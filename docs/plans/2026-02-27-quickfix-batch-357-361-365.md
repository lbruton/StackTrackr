# Quick-Fix Batch: STAK-357, STAK-361, STAK-365

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix three small user-reported bugs in a single patch — NGC lookup link, fractional oz display, and cloud menu reorder.

**Architecture:** Three independent surgical fixes, no shared dependencies. Each touches 1-2 files.

**Linear Issues:** STAK-357, STAK-361, STAK-365

**File Touch Map:**

| Action | File | Scope |
|--------|------|-------|
| MODIFY | `js/viewModal.js` | line ~259 — extract numeric grade for NGC URL |
| MODIFY | `js/utils.js` | lines ~821-823 — remove unconditional sub-oz gram conversion |
| MODIFY | `js/constants.js` | add `HEADER_CLOUD_SYNC_BTN_KEY` constant + ALLOWED_STORAGE_KEYS entry |
| MODIFY | `js/settings.js` | lines ~1134, 1182, 1192, 1217, 1164 — add cloudSyncBtn to reorder system |

---

## Task Table

| ID | Step | Est (min) | Files/Modules | Validation | Risk/Notes | Recommended Agent |
|----|------|-----------|---------------|------------|------------|-------------------|
| T1 | Fix NGC lookup link — extract numeric grade | 2 | `js/viewModal.js:259` | Manual: NGC cert link opens correct page | None — sibling pattern exists at line 274 | Claude |
| T2 | Fix fractional oz display — remove auto-convert | 2 | `js/utils.js:821-823` | Manual: 0.25 oz item shows "0.25 oz" not "7.78 g" | Callers that pass no weightUnit will now show oz instead of g for fractional | Claude |
| T3 | Add cloud sync to reorderable header buttons | 5 | `js/constants.js`, `js/settings.js` | Settings → Appearance shows "Cloud Sync" in button table; reorder works | Cloud sync wrapper contains menu — must move wrapper not just button | Claude |
| T4 | Commit all fixes | 1 | — | `git log` shows commit | — | Claude |

---

## Task 1: Fix NGC Lookup Link (STAK-357) ← NEXT

**Files:**
- Modify: `js/viewModal.js:259`

**Problem:** Line 259 passes `item.grade` (e.g. "MS 65 CAM") directly to the `{grade}` URL template param. NGC expects numeric-only (e.g. "65").

**Correct pattern** already exists at line 274 in the same file:
```javascript
const gradeNum = gradeText.match(/\d+/)?.[0] || '';
```

**Step 1: Apply fix**

In `js/viewModal.js` line 259, change:

```javascript
: certUrlTemplate.replace(/\{certNumber\}/g, encodeURIComponent(certNum)).replace(/\{grade\}/g, encodeURIComponent(item.grade || ''));
```

To:

```javascript
: certUrlTemplate.replace(/\{certNumber\}/g, encodeURIComponent(certNum)).replace(/\{grade\}/g, encodeURIComponent((item.grade || '').match(/\d+/)?.[0] || ''));
```

**Step 2: Verify**

Visually confirm: the only change is the grade substitution value. The rest of the line is identical.

---

## Task 2: Fix Fractional Oz Display (STAK-361)

**Files:**
- Modify: `js/utils.js:821-823`

**Problem:** Lines 821-823 unconditionally convert any weight < 1 oz to grams, even when the caller explicitly passes `weightUnit` or when no unit is specified (implying oz).

**Fix:** Remove the auto-conversion block entirely. All explicit unit conversions (gb, kg, lb, g) are already handled above this block. The remaining default path should always return oz.

**Step 1: Apply fix**

In `js/utils.js`, delete lines 821-823:

```javascript
  if (weight < 1) {
    return `${oztToGrams(weight).toFixed(2)} g`;
  }
```

The function now falls through to `return \`${weight.toFixed(2)} oz\`;` for all weights when no explicit unit is specified.

**Step 2: Verify**

Confirm the function now reads:
```javascript
const formatWeight = (ozt, weightUnit) => {
  if (weightUnit === 'gb') { ... }
  const weight = parseFloat(ozt);
  if (weightUnit === 'kg') { ... }
  if (weightUnit === 'lb') { ... }
  if (weightUnit === 'g') { ... }
  return `${weight.toFixed(2)} oz`;
};
```

---

## Task 3: Add Cloud Sync to Reorderable Header (STAK-365)

**Files:**
- Modify: `js/constants.js` — add storage key constant + ALLOWED_STORAGE_KEYS entry
- Modify: `js/settings.js` — add to vis, labelMap, visKeys, BTN_ID_MAP; remove hardcoded prepend

### Step 1: Add constant to `js/constants.js`

After `HEADER_RESTORE_BTN_KEY` (line 679), add:

```javascript
/** @constant {string} HEADER_CLOUD_SYNC_BTN_KEY - LocalStorage key for header cloud sync button visibility */
const HEADER_CLOUD_SYNC_BTN_KEY = "headerCloudSyncBtnVisible";
```

Add `HEADER_CLOUD_SYNC_BTN_KEY` to the `ALLOWED_STORAGE_KEYS` array (after `HEADER_RESTORE_BTN_KEY` entry around line 817).

Export it to window alongside the other header keys (around line 1720):

```javascript
window.HEADER_CLOUD_SYNC_BTN_KEY = HEADER_CLOUD_SYNC_BTN_KEY;
```

### Step 2: Add to `getHeaderBtnConfig()` in `js/settings.js`

In the `vis` object (line ~1190, before `aboutBtn`), add:

```javascript
cloudSyncBtn: (() => { const v = localStorage.getItem(HEADER_CLOUD_SYNC_BTN_KEY); return v !== null ? v === 'true' : true; })(),
```

In the `labelMap` (line ~1195, before `aboutBtn`), add:

```javascript
cloudSyncBtn: 'Cloud Sync',
```

### Step 3: Add to `saveHeaderBtnConfig()` in `js/settings.js`

In the `visKeys` object (line ~1225, before `aboutBtn`), add:

```javascript
cloudSyncBtn: HEADER_CLOUD_SYNC_BTN_KEY,
```

### Step 4: Add to `BTN_ID_MAP` in `applyHeaderToggleVisibility()`

In the `BTN_ID_MAP` object (line ~1142, before `aboutBtn`), add:

```javascript
cloudSyncBtn: 'headerCloudSyncWrapper',
```

**Important:** Map to `headerCloudSyncWrapper` (the wrapper div), NOT `headerCloudSyncBtn`. The wrapper contains both the button and the dropdown menu — they must move together.

### Step 5: Remove hardcoded prepend

In `applyHeaderToggleVisibility()`, delete lines 1163-1165:

```javascript
    // Cloud sync wrapper is position-managed by the cloud feature; keep it first
    const cloudWrapper = container.querySelector('#headerCloudSyncWrapper');
    if (cloudWrapper) container.prepend(cloudWrapper);
```

The reorder loop (lines 1157-1162) now handles cloud sync positioning via the BTN_ID_MAP entry.

### Step 6: Verify

Open Settings → Appearance → Header Buttons. Confirm "Cloud Sync" appears in the reorder table. Toggle it off/on. Drag to reorder. All should persist across reload.

---

## Task 4: Commit

```bash
git add js/viewModal.js js/utils.js js/constants.js js/settings.js
git commit -m "fix: NGC lookup link, fractional oz display, cloud menu reorder (STAK-357, STAK-361, STAK-365)"
```

---

## Auto-Quiz

1. **Which task is marked NEXT?** T1 (NGC lookup link fix)
2. **Validation for NEXT?** NGC cert link in view modal opens correct NGC page with numeric grade in URL
3. **Commit message template?** `fix: NGC lookup link, fractional oz display, cloud menu reorder (STAK-357, STAK-361, STAK-365)`
4. **Breakpoint?** After T3 (all three fixes applied) — review before committing
