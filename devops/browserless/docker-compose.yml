services:
  browserless:
    image: ghcr.io/browserless/chromium
    container_name: staktrakr-browserless
    ports:
      - "3000:3000"
    # TOKEN uses an inline default so the service works without copying .env.example.
    # Docker Compose also auto-loads .env for variable substitution when it exists.
    environment:
      - TOKEN=${BROWSERLESS_TOKEN:-local_dev_token}
      - CONCURRENT=5
      - QUEUED=10
      - TIMEOUT=120000
      - HEALTH=true
      - TZ=America/New_York
    volumes:
      # Read-only mount of the project root for file:// protocol testing.
      # Allows Playwright to navigate to file:///workspace/StakTrakr/index.html
      # without needing an HTTP server. Matches SMOKE_TEST_BASE_URL_FILEMODE in Infisical.
      - ../../:/workspace/StakTrakr:ro
    restart: unless-stopped

  playwright-dash:
    image: node:22-alpine
    container_name: staktrakr-playwright-dash
    working_dir: /workspace/StakTrakr/devops/playwright-dash
    command: node server.js
    ports:
      - "8766:8766"
    volumes:
      - ../../:/workspace/StakTrakr
    environment:
      - DASH_PORT=8766
      - BROWSERLESS_URL=http://browserless:3000
      - BROWSERLESS_TOKEN=${BROWSERLESS_TOKEN:-local_dev_token}
      - TEST_URL=${TEST_URL:-http://host.docker.internal:8765}
    depends_on:
      - browserless
    restart: unless-stopped
