<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Playwright Dashboard</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --border: #2a2d3a;
    --primary: #3b82f6;
    --primary-dim: rgba(59,130,246,0.15);
    --text: #e2e8f0;
    --muted: #94a3b8;
    --success: #22c55e;
    --danger: #ef4444;
    --radius: 8px;
  }
  body { background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; font-size: 14px; min-height: 100vh; }
  header { display: flex; align-items: center; gap: 12px; padding: 14px 20px; border-bottom: 1px solid var(--border); background: var(--surface); position: sticky; top: 0; z-index: 100; }
  h1 { font-size: 1rem; font-weight: 600; color: var(--text); flex: 1; }
  .badge { font-size: 11px; background: var(--primary-dim); color: var(--primary); border: 1px solid var(--primary); border-radius: 999px; padding: 2px 8px; }
  .toggle-wrap { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--muted); }
  .toggle { position: relative; width: 36px; height: 20px; }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; inset: 0; background: var(--border); border-radius: 20px; cursor: pointer; transition: background 0.2s; }
  .slider::before { content: ''; position: absolute; width: 14px; height: 14px; left: 3px; top: 3px; background: #fff; border-radius: 50%; transition: transform 0.2s; }
  .toggle input:checked + .slider { background: var(--primary); }
  .toggle input:checked + .slider::before { transform: translateX(16px); }
  .btn { padding: 6px 14px; border-radius: 999px; border: none; cursor: pointer; font-size: 13px; font-weight: 500; transition: opacity 0.15s; }
  .btn:hover { opacity: 0.85; }
  .btn-primary { background: var(--primary); color: #fff; }
  .btn-outline { background: transparent; color: var(--primary); border: 1px solid var(--primary); }
  .toolbar { display: flex; align-items: center; gap: 10px; padding: 12px 20px; border-bottom: 1px solid var(--border); }
  .tabs { display: flex; gap: 6px; }
  .tab { padding: 5px 14px; border-radius: 999px; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; font-size: 13px; transition: all 0.15s; }
  .tab.active { background: var(--primary); border-color: var(--primary); color: #fff; }
  .search { margin-left: auto; padding: 5px 12px; border-radius: 999px; border: 1px solid var(--border); background: var(--surface); color: var(--text); font-size: 13px; width: 220px; }
  .search::placeholder { color: var(--muted); }
  .count { font-size: 12px; color: var(--muted); white-space: nowrap; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px; padding: 20px; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; cursor: pointer; transition: border-color 0.15s, transform 0.15s; }
  .card:hover { border-color: var(--primary); transform: translateY(-2px); }
  .card img { width: 100%; height: 160px; object-fit: cover; display: block; background: var(--bg); }
  .card video { width: 100%; height: 160px; display: block; background: #000; pointer-events: none; }
  .card-body { padding: 10px 12px; }
  .card-name { font-size: 12px; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .card-meta { font-size: 11px; color: var(--muted); margin-top: 3px; }
  .empty { grid-column: 1/-1; text-align: center; color: var(--muted); padding: 60px 20px; }
  .empty svg { margin-bottom: 12px; opacity: 0.3; }
  /* Lightbox */
  .lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; align-items: center; justify-content: center; }
  .lightbox.open { display: flex; }
  .lightbox img { max-width: 90vw; max-height: 90vh; border-radius: var(--radius); box-shadow: 0 0 60px rgba(0,0,0,0.5); }
  .lightbox-close { position: absolute; top: 20px; right: 24px; font-size: 28px; color: #fff; cursor: pointer; line-height: 1; opacity: 0.7; }
  .lightbox-close:hover { opacity: 1; }
  /* Toast */
  .toast { position: fixed; bottom: 24px; right: 24px; padding: 10px 18px; border-radius: var(--radius); font-size: 13px; z-index: 300; opacity: 0; transform: translateY(8px); transition: opacity 0.2s, transform 0.2s; pointer-events: none; }
  .toast.show { opacity: 1; transform: translateY(0); }
  .toast.ok { background: var(--success); color: #fff; }
  .toast.err { background: var(--danger); color: #fff; }
  .speed-btn { padding: 3px 10px; border-radius: 999px; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; font-size: 12px; transition: all 0.15s; }
  .speed-btn:hover { border-color: var(--primary); color: var(--primary); }
  .speed-btn.active { background: var(--primary); border-color: var(--primary); color: #fff; }
  .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; margin-right: 6px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  /* Sessions tab */
  .sessions-panel { padding: 20px; }
  .session-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 16px; display: flex; align-items: center; gap: 14px; margin-bottom: 10px; transition: border-color 0.15s; }
  .session-card:hover { border-color: var(--primary); }
  .session-info { flex: 1; }
  .session-ts { font-size: 13px; font-weight: 500; color: var(--text); }
  .session-meta { font-size: 11px; color: var(--muted); margin-top: 4px; }
  .pill { display: inline-block; font-size: 11px; font-weight: 600; border-radius: 999px; padding: 2px 8px; margin-right: 4px; }
  .pill-pass { background: rgba(34,197,94,0.15); color: var(--success); }
  .pill-fail { background: rgba(239,68,68,0.15); color: var(--danger); }
  .pill-total { background: var(--primary-dim); color: var(--primary); }
  /* Delete controls */
  .del-btn { position: absolute; top: 6px; right: 6px; width: 22px; height: 22px;
    border-radius: 50%; border: none; background: rgba(239,68,68,0.85); color: #fff;
    font-size: 14px; line-height: 22px; text-align: center; cursor: pointer;
    display: none; z-index: 10; }
  .card { position: relative; }
  .card:hover .del-btn { display: block; }
  .del-btn:hover { background: var(--danger); }
  .del-btn-session { background: transparent; border: none; color: var(--muted);
    cursor: pointer; font-size: 16px; padding: 4px 8px; border-radius: 4px;
    transition: color 0.15s; flex-shrink: 0; }
  .del-btn-session:hover { color: var(--danger); }
  /* Confirmation modal */
  .confirm-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
    z-index: 400; align-items: center; justify-content: center; }
  .confirm-overlay.open { display: flex; }
  .confirm-box { background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 24px 28px; width: 360px; }
  .confirm-box h2 { font-size: 1rem; font-weight: 600; margin-bottom: 8px; }
  .confirm-box p { font-size: 13px; color: var(--muted); margin-bottom: 16px; }
  .confirm-input { width: 100%; padding: 7px 12px; border-radius: 6px;
    border: 1px solid var(--border); background: var(--bg); color: var(--text);
    font-size: 13px; margin-bottom: 16px; }
  .confirm-actions { display: flex; justify-content: flex-end; gap: 8px; }
</style>
</head>
<body>
<header>
  <h1>Playwright Dashboard</h1>
  <span class="badge" id="statusBadge">idle</span>
  <div class="toggle-wrap">
    <label class="toggle"><input type="checkbox" id="autoRefresh" checked><span class="slider"></span></label>
    Auto-refresh
  </div>
  <button class="btn btn-primary" id="captureBtn">Capture Now</button>
</header>
<div class="toolbar">
  <div class="tabs">
    <button class="tab active" data-tab="screenshot">Screenshots</button>
    <button class="tab" data-tab="video">Videos</button>
    <button class="tab" data-tab="sessions">Sessions</button>
  </div>
  <span class="count" id="countLabel"></span>
  <button class="btn btn-outline" id="deleteAllBtn"
    style="color:var(--danger);border-color:var(--danger);">Delete All</button>
  <input class="search" type="search" id="search" placeholder="Filter by name...">
</div>
<div class="grid" id="grid"></div>
<div class="sessions-panel" id="sessionsPanel" style="display:none;"></div>
<div class="lightbox" id="lightbox">
  <span class="lightbox-close" id="lightboxClose">&times;</span>
  <img id="lightboxImg" src="" alt="">
</div>
<div class="lightbox" id="videoLightbox">
  <span class="lightbox-close" id="videoLightboxClose">&times;</span>
  <div style="display:flex;flex-direction:column;align-items:center;gap:10px;">
    <video id="lightboxVideo" controls style="max-width:90vw;max-height:80vh;border-radius:8px;background:#000;"></video>
    <div id="speedControls" style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;">
      <span style="font-size:11px;color:var(--muted);align-self:center;margin-right:4px;">Speed:</span>
      <button class="speed-btn" data-rate="0.1">0.1&times;</button>
      <button class="speed-btn" data-rate="0.2">0.2&times;</button>
      <button class="speed-btn" data-rate="0.5">0.5&times;</button>
      <button class="speed-btn active" data-rate="1">1&times;</button>
      <button class="speed-btn" data-rate="2">2&times;</button>
      <button class="speed-btn" data-rate="5">5&times;</button>
      <button class="speed-btn" data-rate="10">10&times;</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <h2>Delete Everything?</h2>
    <p>This will permanently delete all test sessions and screenshots. Type DELETE to confirm.</p>
    <input class="confirm-input" id="confirmInput" type="text"
      placeholder="Type DELETE to confirm" autocomplete="off">
    <div class="confirm-actions">
      <button class="btn btn-outline" id="confirmCancel">Cancel</button>
      <button class="btn btn-primary" id="confirmOk"
        style="background:var(--danger);" disabled>Delete All</button>
    </div>
  </div>
</div>
<script>
  let allFiles = [];
  let allSessions = [];
  let activeTab = 'screenshot';
  let refreshTimer = null;
  let fetchController = null;
  let lastFilesKey = '';
  let lastSessionsKey = '';
  const grid = document.getElementById('grid');
  const sessionsPanel = document.getElementById('sessionsPanel');
  const search = document.getElementById('search');
  const statusBadge = document.getElementById('statusBadge');
  const countLabel = document.getElementById('countLabel');
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightboxImg');
  const videoLightbox = document.querySelector('#videoLightbox');
  const lightboxVideo = document.querySelector('#lightboxVideo');
  const toast = document.getElementById('toast');
  const captureBtn = document.getElementById('captureBtn');
  const autoRefresh = document.getElementById('autoRefresh');

  function fmt(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
    return (bytes/1024/1024).toFixed(1) + ' MB';
  }

  function fmtDate(ms) {
    return new Date(ms).toLocaleString();
  }

  function fmtRunId(id) {
    const m = id.match(/^(\d{4})-(\d{2})-(\d{2})-(\d{2})-(\d{2})-(\d{2})$/);
    if (!m) return id;
    return new Date(+m[1], +m[2]-1, +m[3], +m[4], +m[5], +m[6]).toLocaleString();
  }

  function basename(p) {
    return p.split('/').pop();
  }

  function renderGrid() {
    const q = search.value.toLowerCase();
    const type = activeTab === 'screenshot' ? 'screenshot' : 'video';
    const items = allFiles.filter(f => f.type === type && (!q || basename(f.path).toLowerCase().includes(q)));
    countLabel.textContent = items.length + ' item' + (items.length !== 1 ? 's' : '');
    if (items.length === 0) {
      grid.innerHTML = '<div class="empty"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg><p>No ' + type + 's yet</p></div>';
      return;
    }
    grid.innerHTML = items.map(f => {
      const name = basename(f.path);
      const meta = fmtDate(f.mtime) + ' \u00b7 ' + fmt(f.size);
      if (f.type === 'screenshot') {
        return '<div class="card" data-src="' + f.path + '"><img src="' + f.path + '" alt="' + name + '" loading="lazy"><div class="card-body"><div class="card-name">' + name + '</div><div class="card-meta">' + meta + '</div></div><button class="del-btn" title="Delete">\u00d7</button></div>';
      }
      return '<div class="card" data-video="' + f.path + '"><video src="' + f.path + '" preload="metadata"></video><div class="card-body"><div class="card-name">' + name + '</div><div class="card-meta">' + meta + '</div></div><button class="del-btn" title="Delete">\u00d7</button></div>';
    }).join('');
    grid.querySelectorAll('.card[data-src]').forEach(card => {
      card.addEventListener('click', () => {
        lightboxImg.src = card.dataset.src;
        lightbox.classList.add('open');
      });
    });
    grid.querySelectorAll('.card[data-video]').forEach(card => {
      card.addEventListener('click', () => {
        lightboxVideo.src = card.dataset.video;
        videoLightbox.classList.add('open');
        lightboxVideo.play();
      });
    });
    grid.querySelectorAll('.del-btn').forEach(btn => {
      btn.addEventListener('click', async e => {
        e.stopPropagation();
        const card = btn.closest('.card');
        const p = card.dataset.src || card.dataset.video;
        try {
          const r = await fetch('/api/files', { method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: p }) });
          if (!r.ok) throw new Error((await r.json()).error);
          showToast('Deleted', 'ok');
          await fetchFiles();
        } catch (err) { showToast('Delete failed: ' + err.message, 'err'); }
      });
    });
  }

  function renderSessions(sessions) {
    countLabel.textContent = sessions.length + ' session' + (sessions.length !== 1 ? 's' : '');
    if (sessions.length === 0) {
      sessionsPanel.innerHTML = '<div class="empty" style="grid-column:unset"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg><p>No sessions yet \u2014 run <code>npm test</code> to generate one</p></div>';
      return;
    }
    const cards = sessions.map(s => {
      const card = document.createElement('div');
      card.className = 'session-card';

      const info = document.createElement('div');
      info.className = 'session-info';

      const ts = document.createElement('div');
      ts.className = 'session-ts';
      ts.textContent = fmtRunId(s.id);

      const meta = document.createElement('div');
      meta.className = 'session-meta';

      const pTotal = document.createElement('span');
      pTotal.className = 'pill pill-total';
      pTotal.textContent = s.total + ' total';

      const pPass = document.createElement('span');
      pPass.className = 'pill pill-pass';
      pPass.textContent = '\u2705 ' + s.passed + ' passed';

      meta.appendChild(pTotal);
      meta.appendChild(pPass);

      if (s.failed > 0) {
        const pFail = document.createElement('span');
        pFail.className = 'pill pill-fail';
        pFail.textContent = '\u274c ' + s.failed + ' failed';
        meta.appendChild(pFail);
      }

      info.appendChild(ts);
      info.appendChild(meta);

      const btn = document.createElement('button');
      btn.className = 'btn btn-outline';
      btn.textContent = 'Open Report';
      btn.addEventListener('click', () => window.open(s.reportUrl, '_blank'));

      card.appendChild(info);
      card.appendChild(btn);

      const delBtn = document.createElement('button');
      delBtn.className = 'del-btn-session';
      delBtn.title = 'Delete session';
      delBtn.textContent = '\u{1F5D1}';
      delBtn.addEventListener('click', async () => {
        try {
          const r = await fetch('/api/sessions/' + encodeURIComponent(s.id), { method: 'DELETE' });
          if (!r.ok) throw new Error((await r.json()).error);
          showToast('Session deleted', 'ok');
          await fetchSessions();
        } catch (err) { showToast('Delete failed: ' + err.message, 'err'); }
      });
      card.appendChild(delBtn);

      return card;
    });
    sessionsPanel.replaceChildren(...cards);
  }

  async function fetchFiles() {
    if (fetchController) fetchController.abort();
    fetchController = new AbortController();
    try {
      statusBadge.textContent = 'refreshing';
      const res = await fetch('/api/files', { signal: fetchController.signal });
      const files = await res.json();
      const key = files.map(f => f.path + f.mtime).join('|');
      statusBadge.textContent = 'live';
      if (key !== lastFilesKey) {
        lastFilesKey = key;
        allFiles = files;
        if (activeTab !== 'sessions') renderGrid();
      }
    } catch (e) {
      if (e.name !== 'AbortError') statusBadge.textContent = 'error';
    }
  }

  async function fetchSessions() {
    try {
      const res = await fetch('/api/sessions');
      const sessions = await res.json();
      const key = sessions.map(s => s.id + s.mtime).join('|');
      if (key !== lastSessionsKey) {
        lastSessionsKey = key;
        allSessions = sessions;
        if (activeTab === 'sessions') renderSessions(sessions);
      }
    } catch { /* ignore */ }
  }

  async function refresh() {
    await fetchFiles();
    await fetchSessions();
  }

  function startRefresh() {
    if (refreshTimer) return;
    refreshTimer = setInterval(refresh, 3000);
  }
  function stopRefresh() {
    clearInterval(refreshTimer);
    refreshTimer = null;
  }

  function showToast(msg, type) {
    toast.textContent = msg;
    toast.className = 'toast show ' + type;
    setTimeout(() => { toast.className = 'toast'; }, 3000);
  }

  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      activeTab = tab.dataset.tab;
      if (activeTab === 'sessions') {
        grid.style.display = 'none';
        sessionsPanel.style.display = 'block';
        search.style.display = 'none';
        renderSessions(allSessions);
        fetchSessions();
      } else {
        grid.style.display = '';
        sessionsPanel.style.display = 'none';
        search.style.display = '';
        renderGrid();
      }
    });
  });

  search.addEventListener('input', renderGrid);

  function setSpeed(rate) {
    lightboxVideo.playbackRate = rate;
    document.querySelectorAll('.speed-btn').forEach(b => b.classList.toggle('active', Number(b.dataset.rate) === rate));
  }

  function closeVideoLightbox() {
    lightboxVideo.pause();
    lightboxVideo.src = '';
    videoLightbox.classList.remove('open');
    setSpeed(1);
  }

  document.querySelectorAll('.speed-btn').forEach(btn => {
    btn.addEventListener('click', e => { e.stopPropagation(); setSpeed(Number(btn.dataset.rate)); });
  });

  lightbox.addEventListener('click', e => { if (e.target === lightbox || e.target.id === 'lightboxClose') lightbox.classList.remove('open'); });
  document.getElementById('lightboxClose').addEventListener('click', () => lightbox.classList.remove('open'));
  videoLightbox.addEventListener('click', e => { if (e.target === videoLightbox || e.target.id === 'videoLightboxClose') closeVideoLightbox(); });
  document.querySelector('#videoLightboxClose').addEventListener('click', closeVideoLightbox);
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      lightbox.classList.remove('open');
      closeVideoLightbox();
      confirmOverlay.classList.remove('open');
      confirmInput.value = '';
      confirmOk.disabled = true;
    }
  });

  autoRefresh.addEventListener('change', () => {
    if (autoRefresh.checked) startRefresh(); else stopRefresh();
  });

  const deleteAllBtn = document.getElementById('deleteAllBtn');
  const confirmOverlay = document.getElementById('confirmOverlay');
  const confirmInput = document.getElementById('confirmInput');
  const confirmOk = document.getElementById('confirmOk');
  const confirmCancel = document.getElementById('confirmCancel');

  deleteAllBtn.addEventListener('click', () => confirmOverlay.classList.add('open'));
  confirmCancel.addEventListener('click', () => {
    confirmOverlay.classList.remove('open');
    confirmInput.value = '';
    confirmOk.disabled = true;
  });
  confirmInput.addEventListener('input', () => {
    confirmOk.disabled = confirmInput.value !== 'DELETE';
  });
  confirmOk.addEventListener('click', async () => {
    confirmOverlay.classList.remove('open');
    confirmInput.value = '';
    confirmOk.disabled = true;
    try {
      const r = await fetch('/api/all', { method: 'DELETE' });
      const data = await r.json();
      if (!r.ok) throw new Error(data.error);
      showToast('Deleted ' + data.dirs + ' session(s) and ' + data.files + ' file(s)', 'ok');
      lastFilesKey = '';
      lastSessionsKey = '';
      allFiles = [];
      allSessions = [];
      await refresh();
    } catch (err) { showToast('Delete failed: ' + err.message, 'err'); }
  });
  confirmOverlay.addEventListener('click', e => {
    if (e.target === confirmOverlay) {
      confirmOverlay.classList.remove('open');
      confirmInput.value = '';
      confirmOk.disabled = true;
    }
  });

  captureBtn.addEventListener('click', async () => {
    captureBtn.disabled = true;
    captureBtn.innerHTML = '<span class="spinner"></span>Capturing...';
    try {
      const res = await fetch('/api/capture', { method: 'POST' });
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      showToast('Screenshot saved', 'ok');
      await fetchFiles();
      activeTab = 'screenshot';
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === 'screenshot'));
      grid.style.display = '';
      sessionsPanel.style.display = 'none';
      search.style.display = '';
      renderGrid();
    } catch (e) {
      showToast('Capture failed: ' + e.message, 'err');
    } finally {
      captureBtn.disabled = false;
      captureBtn.textContent = 'Capture Now';
    }
  });

  refresh();
  startRefresh();
</script>
</body>
</html>
