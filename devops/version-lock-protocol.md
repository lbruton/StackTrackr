# Version Lock + Worktree Protocol — StakTrakr

## Why This Exists

Multiple agents (Claude, Gemini, Codex, Jules) work concurrently on the same local git repo.
Without coordination, two agents can:

1. Compute the same "next version" and produce duplicate/skipped version tags
2. Make conflicting edits to the same files in the shared `dev` branch

This protocol solves both problems: a **version lock** claims the next version number, and a
**git worktree** gives each agent an isolated filesystem to work in.

The actual lock state lives in `devops/version.lock` (gitignored). Worktrees live in
`.claude/worktrees/` (also gitignored).

---

## Full Protocol (9 steps)

### Step 1 — CHECK the lock

```bash
cat devops/version.lock 2>/dev/null || echo "UNLOCKED"
```

- **Locked and not expired:** STOP. Report who holds it to the user. Do not proceed.
- **Locked but expired (> 30 min old):** Take it over. Log a mem0 entry noting the takeover.
- **Unlocked:** Proceed to Step 2.

### Step 2 — COMPUTE next version

Read current `APP_VERSION` from `js/constants.js` and increment the PATCH number:
`3.32.08` → `3.32.09`

### Step 3 — WRITE the lock file

```json
{
  "locked": "3.32.09",
  "locked_by": "claude-sonnet / STAK-XX feature name",
  "locked_at": "2026-02-22T19:00:00Z",
  "expires_at": "2026-02-22T19:30:00Z"
}
```

The `locked` version becomes the **anchor** for all work: Linear notes, changelog bullets,
commit messages, and mem0 handoffs should all reference this version number.

### Step 4 — CREATE worktree + branch

```bash
git worktree add .claude/worktrees/patch-VERSION -b patch/VERSION
```

Example: `git worktree add .claude/worktrees/patch-3.32.09 -b patch/3.32.09`

The new branch is created off the current HEAD of `dev`.

### Step 5 — DO ALL WORK in the worktree

All file edits, the `/release patch` version bump, and test runs happen inside
`.claude/worktrees/patch-VERSION/`. Do not make changes to the main `dev` working tree
while this lock is held.

The `/release patch` skill reads `js/constants.js` relative to the worktree CWD, so
it correctly bumps to the locked version.

### Step 5b — SYNC with latest origin/dev before pushing

Before pushing, merge any commits that landed in `dev` while you were working:

```bash
git fetch origin
git merge origin/dev  # inside the worktree
```

This surfaces conflicts early (before the PR opens) and ensures the Cloudflare preview
reflects the combined state. If there are no concurrent commits it's a no-op.

### Step 6 — PUSH branch and open PR to dev

```bash
git push origin patch/VERSION
gh pr create --base dev --head patch/VERSION --draft \
  --title "patch/VERSION — description" \
  --body "..."
```

Cloudflare Pages will automatically generate a **preview URL** for this PR branch.
Use the preview URL to QA the changes before merging.

### Step 7 — QA the Cloudflare preview

Test the live preview URL generated by the PR. Confirm:
- The feature/fix works as expected
- No regressions in core flows
- Version number displays correctly in About modal

### Step 8 — MERGE to dev

When QA passes, merge the PR into `dev`. Use a squash merge for clean history,
or a regular merge to preserve individual commits — either is acceptable.

### Step 9 — CLEANUP

```bash
git worktree remove .claude/worktrees/patch-VERSION --force
git branch -d patch/VERSION
rm devops/version.lock
```

If the remote branch is no longer needed:
```bash
git push origin --delete patch/VERSION
```

---

## Lock File Format

```json
{
  "locked": "3.32.09",
  "locked_by": "claude-sonnet / STAK-XX feature name",
  "locked_at": "2026-02-22T19:00:00Z",
  "expires_at": "2026-02-22T19:30:00Z"
}
```

- `locked` — the version number being worked on (matches `APP_VERSION` bump target)
- `locked_by` — agent name + brief task description (for human visibility)
- `locked_at` / `expires_at` — ISO 8601 UTC timestamps, 30-minute TTL

---

## TTL Rule

Lock expires **30 minutes** after `locked_at`. Any agent may take over an expired lock,
but must log the takeover in mem0:

```javascript
mcp__mem0__add_memory({
  text: "StakTrakr workflow: Took over expired version lock for 3.32.09. Previous holder: claude-sonnet.",
  metadata: { project: "staktrakr", category: "workflow", type: "insight" }
})
```

Healthy agents always release (delete) the lock before 30 minutes are up.

---

## Integration with /release Skill

The `/release` skill (`.claude/skills/release/SKILL.md`) integrates this protocol in Phase 0:

- **Step 0a**: Check lock → compute next version → write lock → create worktree → instruct agent
  to switch to worktree directory
- **Step 0b**: Seed data sync (unchanged)
- **Phase 3 cleanup**: After commit, remove worktree, delete branch, delete lock file

---

## Version Anchor Concept

Each version tag is an **anchor** for a batch of work:

- Version number is claimed *before* any code is written
- All Linear notes, changelog bullets, and mem0 handoffs reference that version
- The git tag (`v3.32.09`) is the permanent breadcrumb
- The PR body is assembled from all the patch tags between the last release and now

This means the version number is the *first* thing decided, not the last.

---

## Worktree Reference

```bash
# List active worktrees
git worktree list

# Remove a worktree (after merging)
git worktree remove .claude/worktrees/patch-3.32.09 --force

# If a worktree directory was deleted manually, prune stale metadata
git worktree prune
```

---

*Protocol established: 2026-02-22 | Worktree flow added: 2026-02-22*
