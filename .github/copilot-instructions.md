# Copilot Instructions — StakTrakr

Custom review instructions for GitHub Copilot PR reviews.

## Project Context

StakTrakr is a single-page vanilla JavaScript app (no framework, no build step). It runs on both `file://` protocol and HTTP servers. The runtime artifact is `index.html` plus JS/CSS assets — no bundler, no transpiler.

## Critical Patterns to Enforce

### 1. DOM Access — Always use `safeGetElement()`

Direct `document.getElementById()` calls are **not allowed**. The codebase uses `safeGetElement(id)` which prevents null reference errors.

```js
// BAD — flag this
const el = document.getElementById("myElement");

// GOOD
const el = safeGetElement("myElement");
```

**Exception**: Code inside `about.js`, `init.js`, and event setup functions that run once at startup may use `document.getElementById()` for elements that are guaranteed to exist.

### 2. localStorage — Whitelist Required

All localStorage keys **must** be registered in `ALLOWED_STORAGE_KEYS` in `js/constants.js`. Direct `localStorage.setItem()` with an unlisted key will be silently blocked by the security layer. Flag any new `localStorage.setItem()` or `localStorage.getItem()` call that uses a key not in the whitelist.

Prefer `saveData()`/`loadData()` (async) or `saveDataSync()`/`loadDataSync()` from `js/utils.js` for application data.

### 3. Script Loading Order

Scripts load via `<script>` tags in `index.html` in strict dependency order. `file-protocol-fix.js` loads first (no `defer`), `init.js` loads last. If a PR adds a new script file, verify it's placed correctly in `index.html`.

### 4. Service Worker — respondWith() Must Always Resolve to a Response

Every `event.respondWith()` call **must** guarantee a `Response` object. This is the #1 cause of PWA crashes:

- `.catch()` only handles **rejections**, not `undefined` from cache misses
- `caches.match()` resolves to `undefined` on a miss — this is not a rejection
- Use `.then((r) => r || fallback)` to guard against `undefined`, not `.catch()`
- Every promise chain passed to `respondWith()` must end with a guaranteed `Response`

```js
// BAD — undefined cache miss skips .catch(), respondWith gets undefined
event.respondWith(
  caches.match(req).catch(() => new Response("fallback"))
);

// GOOD — .then() catches both undefined and rejection paths
event.respondWith(
  caches.match(req).then((r) => r || fetch(req)).then((r) => r || new Response("fallback"))
);
```

### 5. Version Sync — 6 Files Must Match

When any version-related file changes, verify all 6 are in sync:

| File | Field |
|------|-------|
| `js/constants.js` | `APP_VERSION` |
| `sw.js` | `CACHE_NAME` (includes version) |
| `CHANGELOG.md` | Latest `## [x.y.z]` heading |
| `docs/announcements.md` | Latest What's New entry version |
| `js/about.js` | `getEmbeddedWhatsNew()` version |
| `version.json` | `"version"` field |

If only some files are updated, flag the missing ones.

### 6. XSS Prevention

All user-supplied strings rendered into the DOM must go through `sanitizeHtml()` from `js/utils.js`. Flag any direct `innerHTML` assignment with unsanitized input. Existing `// nosemgrep:` comments indicate reviewed exceptions — do not flag those.

### 7. CACHE_NAME and APP_VERSION Drift

If `sw.js` CACHE_NAME does not match the version in `js/constants.js`, the service worker will serve stale assets. This causes the What's New splash to re-trigger on every page load. Always flag CACHE_NAME/APP_VERSION mismatches.

### 8. Announcements Entry Rotation — Intentional Limit

`docs/announcements.md` and `js/about.js` (`getEmbeddedWhatsNew()`) are **intentionally capped at 3–5 entries**. When a new release is added, the oldest entry is rotated out. Do not flag removed older entries as missing — this is by design. Both files must contain the **same** entries in the **same** order; flag any drift between them.

Similarly, the Development Roadmap section in `announcements.md` and `getEmbeddedRoadmap()` in `about.js` are capped at 3–4 items. Completed roadmap items are removed during releases.

### 9. Seed Data Files — Auto-Generated

Files matching `data/spot-history-*.json` are generated by an external Docker poller and committed in bulk during releases. Do not flag formatting, line count changes, or large diffs in these files — they are machine-generated price data.

## Review Focus Areas

- **Error handling in async code**: Promise chains should have `.catch()` handlers, especially in service worker code and API calls
- **New localStorage keys**: Must be added to `ALLOWED_STORAGE_KEYS` before use
- **CSS changes**: The app supports four themes (light, dark, sepia, system). Verify color values use CSS custom properties (`var(--...)`) rather than hardcoded colors
- **Mobile responsiveness**: The app uses a card view below 1350px breakpoint. Check that new UI elements are responsive
