# Nightly sync between StakTrakrApi and StakTrakrApi1
# Ensures both API repos have identical data/ directories.
# Copies missing files in both directions — no overwrites, no deletions.
# Requires repository secret: API_PUSH_TOKEN (PAT with repo scope)
name: Sync API Repos

on:
  schedule:
    - cron: '0 5 * * *'   # 5am UTC daily (midnight EST)
  workflow_dispatch:       # Manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout StakTrakrApi (Fly.io endpoint)
        uses: actions/checkout@v4
        with:
          repository: lbruton/StakTrakrApi
          ref: main
          path: api
          token: ${{ secrets.API_PUSH_TOKEN }}
          fetch-depth: 1

      - name: Checkout StakTrakrApi1 (GitHub Pages endpoint)
        uses: actions/checkout@v4
        with:
          repository: lbruton/StakTrakrApi1
          ref: main
          path: api1
          token: ${{ secrets.API_PUSH_TOKEN }}
          fetch-depth: 1

      - name: Sync missing files (both directions)
        run: |
          API_UPDATED=0
          API1_UPDATED=0

          # --- Direction 1: api → api1 (files in StakTrakrApi but not StakTrakrApi1) ---
          echo "=== Syncing StakTrakrApi → StakTrakrApi1 ==="
          cd "$GITHUB_WORKSPACE/api"
          find data -type f -name "*.json" | while read -r FILE; do
            if [ ! -f "$GITHUB_WORKSPACE/api1/$FILE" ]; then
              mkdir -p "$GITHUB_WORKSPACE/api1/$(dirname "$FILE")"
              cp "$FILE" "$GITHUB_WORKSPACE/api1/$FILE"
              echo "  + api1/$FILE"
              API1_UPDATED=$((API1_UPDATED + 1))
            fi
          done

          # --- Direction 2: api1 → api (files in StakTrakrApi1 but not StakTrakrApi) ---
          echo "=== Syncing StakTrakrApi1 → StakTrakrApi ==="
          cd "$GITHUB_WORKSPACE/api1"
          find data -type f -name "*.json" | while read -r FILE; do
            if [ ! -f "$GITHUB_WORKSPACE/api/$FILE" ]; then
              mkdir -p "$GITHUB_WORKSPACE/api/$(dirname "$FILE")"
              cp "$FILE" "$GITHUB_WORKSPACE/api/$FILE"
              echo "  + api/$FILE"
              API_UPDATED=$((API_UPDATED + 1))
            fi
          done

          echo "Files added to StakTrakrApi: $API_UPDATED"
          echo "Files added to StakTrakrApi1: $API1_UPDATED"

      - name: Push StakTrakrApi if changed
        working-directory: api
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          if git diff --cached --quiet; then
            echo "StakTrakrApi: already in sync."
          else
            COUNT=$(git diff --cached --numstat | wc -l | tr -d ' ')
            git commit -m "sync: +${COUNT} files from StakTrakrApi1 ($(date -u +%Y-%m-%d))"
            git push
            echo "StakTrakrApi: pushed ${COUNT} new files."
          fi

      - name: Push StakTrakrApi1 if changed
        working-directory: api1
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          if git diff --cached --quiet; then
            echo "StakTrakrApi1: already in sync."
          else
            COUNT=$(git diff --cached --numstat | wc -l | tr -d ' ')
            git commit -m "sync: +${COUNT} files from StakTrakrApi ($(date -u +%Y-%m-%d))"
            git push
            echo "StakTrakrApi1: pushed ${COUNT} new files."
          fi
