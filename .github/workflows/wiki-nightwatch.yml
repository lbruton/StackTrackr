name: Wiki Nightwatch

on:
  schedule:
    - cron: '0 6 * * *' # 6 AM UTC â€” ~11 PM PT nightly
  workflow_dispatch: # manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  nightwatch:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0 # full history needed for branch creation

      - name: Wiki accuracy patrol
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are a wiki accuracy hunter â€” part of the nightly Nightwatch patrol.
            Your mission: find ONE specific inaccuracy in a frontend wiki page by
            cross-checking it against the actual codebase, then submit a PR with
            the correction and justification.

            ## Step 1 â€” Rotation state

            Read wiki/.nightwatch-log.json to get the rotation state.
            If the file does not exist, create it with nextIndex: 0 and a rotation
            array of all wiki/*.md files that have "owner: staktrakr" in frontmatter
            (skip _sidebar.md, README.md, CHANGELOG.md, and any owner: staktrakr-api pages).

            Pick the page at rotation[nextIndex].

            ## Step 2 â€” Deep read

            Read the wiki page completely. Extract sourceFiles from the YAML frontmatter.
            Read EVERY source file listed â€” line by line, not skimming.

            ## Step 3 â€” Cross-check ALL factual claims

            - Counts (e.g. "56 script tags" â€” verify: grep -c '<script' index.html)
            - Function names and signatures (do they still exist with that exact name?)
            - Window globals and exports (does window.X still get assigned?)
            - Code patterns described (does the code still work this way?)
            - Related page links (do the referenced .md files exist in wiki/?)
            - Version numbers, constant values, enum members
            - Storage key names, CSS class names, DOM element IDs
            - CORE_ASSETS entries in sw.js vs actual file list

            ## Step 4 â€” Act on findings

            Configure git first (both paths need this):
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"

            ### Path A â€” INACCURACY FOUND

            1. Create a branch from dev:
               git checkout -b nightwatch/fix-PAGE-$(date +%Y%m%d)
               (replace PAGE with the page name without .md extension)

            2. Edit the wiki .md file to correct the inaccuracy.
               Make the MINIMUM change needed â€” fix the specific claim, don't
               rewrite the entire page or restructure content.

            3. Update wiki/.nightwatch-log.json:
               - Append to history array:
                 { "date": "YYYY-MM-DD", "page": "PAGE.md", "track": "frontend",
                   "status": "inaccuracy_found",
                   "finding": "brief description of the inaccuracy",
                   "verified": [] }
               - Increment nextIndex (wrap to 0 at end of rotation array)
               - Cap history at 30 entries (trim oldest)

            4. Stage and commit:
               git add wiki/PAGE.md wiki/.nightwatch-log.json
               git commit -m "fix(wiki): PAGE â€” brief description"

            5. Push the branch:
               git push origin HEAD

            6. Open a draft PR to dev. Use gh with a heredoc for the body:

               gh pr create --base dev --draft \
                 --title "fix(wiki): PAGE â€” brief description" \
                 --body "$(cat <<'PREOF'
               ## Wiki Nightwatch â€” Inaccuracy Correction

               **Page:** `wiki/PAGE.md`
               **Section:** {heading where the inaccuracy lives}

               ### What the wiki claimed
               > {exact quote from the wiki}

               ### What the code actually shows
               {what the code actually says, with file:line references}

               ### Correction made
               {description of the edit}

               ### Verification
               - Source file: `{path}` (line {N})
               - How confirmed: {grep output, line count, function signature, etc.}

               ---
               *ðŸ¤– Generated by [Wiki Nightwatch](https://github.com/lbruton/StakTrakr/blob/dev/.github/workflows/wiki-nightwatch.yml)*
               PREOF
               )"

            ### Path B â€” VERIFIED OK (no inaccuracy found)

            1. Update wiki/.nightwatch-log.json:
               - Append to history array:
                 { "date": "YYYY-MM-DD", "page": "PAGE.md", "track": "frontend",
                   "status": "verified_ok", "finding": null,
                   "verified": ["claim 1 â€” verified in file:line",
                                "claim 2 â€” verified in file:line",
                                "claim 3 â€” verified in file:line"] }
               - Increment nextIndex (wrap to 0 at end of rotation array)
               - Cap history at 30 entries

            2. Commit the log update to dev:
               git add wiki/.nightwatch-log.json
               git commit -m "chore: wiki nightwatch â€” PAGE verified ok"
               git push origin dev

            ## Rules

            - Be thorough. Read actual code line by line. One real finding is
              more valuable than a false "all clear."
            - Only check frontend pages (owner: staktrakr). Skip any
              infrastructure pages (owner: staktrakr-api) in rotation.
            - Make minimal corrections â€” fix the specific claim, don't refactor.
            - Always include file:line evidence in the PR body.
            - Draft PRs only â€” human reviews before merge.
          allowed_tools: "Read,Grep,Glob,Edit,Write,Bash(git config:*),Bash(git checkout:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(git status),Bash(gh pr create:*),Bash(wc *),Bash(grep -c:*),Bash(date *)"
