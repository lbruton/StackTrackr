<!doctype html>
<!--
  StakTrakr - Main Application Interface
  
  A comprehensive client-side web application for tracking precious metal investments
  including silver, gold, platinum, and palladium. Features include spot price management,
  premium calculations, and multi-format data import/export.
  
  All data is stored locally using localStorage - no server required.
  Application version is managed dynamically via constants.js
-->
<html lang="en">
  <head>
    <!--
    Content Security Policy — intentionally permissive (see DEVS-22).

    StakTrakr's primary distribution is local (file:// protocol or
    extracted ZIP). The file:// origin requires 'unsafe-inline' for
    inline handlers/styles and 'unsafe-eval' for vendor libraries
    (JSZip, Forge). A strict CSP breaks both execution paths.

    Runtime mitigations in place:
      - All user-controlled HTML is escaped via sanitizeHtml() (utils.js)
      - OAuth tokens scoped to localStorage; vault password cached in
        sessionStorage with XOR obfuscation + auto-clear idle timer
      - No server-stored user data; compromise requires local access
  -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;"
    />
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1, minimum-scale=1, user-scalable=yes"
      name="viewport"
    />

    <!-- PWA Support -->
    <link rel="manifest" href="./manifest.json" />
    <meta name="theme-color" content="#1a1a2e" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <link rel="apple-touch-icon" href="./images/icon-192.png" />

    <title>StakTrakr — Precious Metals Inventory Tracker</title>
    <meta name="description" content="Track your silver, gold, platinum, and palladium portfolio. Live spot prices, melt values, gain/loss tracking. Free, open source, no data collected." />
    <meta property="og:title" content="StakTrakr — Precious Metals Inventory Tracker" />
    <meta property="og:description" content="Track your silver, gold, platinum, and palladium portfolio. Live spot prices, melt values, gain/loss tracking. Free, open source, no data collected." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.staktrakr.com" />
    <!-- FILE PROTOCOL COMPATIBILITY - MUST LOAD FIRST -->
    <script src="./js/file-protocol-fix.js"></script>

    <!-- Vendored libraries: loaded locally for offline + file:// compatibility.
         CDN fallbacks fire automatically if the local copy fails to define its global. -->
    <script defer src="./vendor/papaparse.min.js"></script>
    <script defer src="./vendor/jspdf.umd.min.js"></script>
    <script defer src="./vendor/jspdf.plugin.autotable.min.js"></script>
    <script defer src="./vendor/chart.min.js"></script>
    <script defer src="./vendor/chartjs-plugin-datalabels.min.js"></script>
    <script defer src="./vendor/jszip.min.js"></script>
    <script defer src="./vendor/forge.min.js"></script>
    <!-- CDN fallbacks — only execute if the local vendor copy failed to load -->
    <script>
      window.__vendorFallbacks = [
        { global: 'Papa',                   src: 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js' },
        { global: 'jspdf',                  src: 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js' },
        { check: function() { return !!(window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.prototype.autoTable); }, src: 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js' },
        { global: 'Chart',                  src: 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js' },
        { global: 'ChartDataLabels',        src: 'https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js' },
        { global: 'JSZip',                  src: 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js' },
        { global: 'forge',                  src: 'https://cdnjs.cloudflare.com/ajax/libs/forge/0.10.0/forge.min.js' },
      ];
      document.addEventListener('DOMContentLoaded', function () {
        window.__vendorFallbacks.forEach(function (lib) {
          var missing = lib.check ? !lib.check() : !window[lib.global];
          if (missing) {
            var label = lib.global || lib.src.split('/').pop();
            console.warn('[vendor] ' + label + ' not loaded from local — falling back to CDN');
            var s = document.createElement('script');
            s.src = lib.src;
            document.head.appendChild(s);
          }
        });
      });
    </script>

    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="icon" type="image/svg+xml" href="./favicon.svg?v=3.27.03" />
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon.png?v=3.27.03" />
    <link rel="icon" type="image/png" sizes="192x192" href="./images/icon-192.png?v=3.27.03" />

    <!-- PROTOTYPE: STAK-144 — 4-way view toggle (A/B/C/D) + always-visible sort bar + summary row -->
    <style>
      /* ── Fix: body overflow-x:hidden blocks child horizontal scroll ───────
         overflow-x:clip prevents body-level layout overflow (same visual result)
         but does NOT create a new scroll container, so .portal-scroll can scroll
         horizontally on mobile Safari / iOS WebView. ─────────────────────────── */
      body {
        overflow-x: clip !important;
      }

      /* ── Sort bar: borderless, blends into content below ───────────────── */
      #cardSortBar {
        border: none !important;
        background: transparent !important;
        padding-bottom: 0.5rem !important;
        margin-bottom: 0 !important;
      }

      /* ── Portfolio summary bar (full-width bottom of filter chips section) ─ */
      .card-sort-summary {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: center;
        flex-wrap: nowrap;
        font-size: 0.75rem;
        width: 100%;
        padding: 0.35rem 0 0;
        border-top: 1px solid var(--border-color, var(--border));
        margin-top: 0.25rem;
        overflow: hidden;
      }
      .card-sort-summary .summary-item {
        display: inline-flex;
        align-items: baseline;
        gap: 0.2rem;
      }
      .card-sort-summary .summary-label {
        color: var(--text-muted, var(--text-secondary));
        font-size: 0.68rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }
      .card-sort-summary .summary-val {
        color: var(--text-primary);
        font-weight: 600;
      }
      .card-sort-summary .summary-positive .summary-val { color: var(--gain, #22c55e); }
      .card-sort-summary .summary-negative .summary-val { color: var(--loss, #ef4444); }
      .card-sort-summary .summary-sep {
        color: var(--border);
        padding: 0 0.1rem;
      }

      /* ── Table scroll: portal-scroll must fill its container for touch drag ─ */
      .portal-scroll {
        width: 100%;
      }

      /* ── Custom horizontal scrollbar (D mode) ───────────────────────────── */
      .h-scroll-track {
        position: relative;
        height: 10px;
        margin: 4px 6px 6px;
        border-radius: 5px;
        background: var(--bg-tertiary, rgba(128,128,128,0.15));
        cursor: pointer;
        /* Hide when .hidden attribute is set */
      }
      .h-scroll-track[hidden] { display: none; }
      .h-scroll-thumb {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        min-width: 44px;
        background: var(--primary, #6366f1);
        border-radius: 5px;
        cursor: grab;
        will-change: transform;
        /* Smooth reposition during scroll */
        transition: transform 0.05s linear;
      }
      .h-scroll-thumb:active { cursor: grabbing; }
      /* Hide native horizontal scrollbar when using custom one */
      body.view-mode-d .portal-scroll::-webkit-scrollbar { height: 0; }
      body.view-mode-d .portal-scroll { scrollbar-width: none; }

      /* ── Table (D mode): constrain container + force overflow ──────────────
         table-section must be overflow:hidden so it can't inflate to match
         the table's 1200px min-width (otherwise portal.clientWidth === 1200
         and no scroll is detected). overflow:hidden creates a BFC that locks
         the element to its parent container's width (~565px on mobile).       */
      body.view-mode-d #tableSectionEl {
        overflow-x: hidden;
      }
      body.view-mode-d .portal-scroll {
        overflow-x: scroll;
        max-width: 100%;
      }
      body.view-mode-d #inventoryTable {
        min-width: 1200px;
      }

      /* ── Table header: slightly darker so it reads as a distinct header ─── */
      #inventoryTable thead th {
        /* box-shadow overlay avoids creating a new stacking context (filter would
           break position:sticky in some browsers) */
        box-shadow: inset 0 0 0 9999px rgba(0, 0, 0, 0.18);
      }

      /* ── Touch-friendly table rows at narrow viewports ──────────────────── */
      @media (max-width: 900px) {
        #inventoryTable tbody td {
          padding-top: 0.55rem;
          padding-bottom: 0.55rem;
        }
      }

      /* ── Portfolio summary + sort bar compact scaling (<= 480px) ──────────── */
      @media (max-width: 480px) {
        .card-sort-summary {
          font-size: 0.65rem;
          gap: 0.3rem;
          padding: 0.35rem 0 0;
        }
        .card-sort-summary .summary-label {
          font-size: 0.58rem;
        }
        .card-sort-summary .summary-sep {
          display: none; /* drop separators at very narrow widths */
        }
        .card-sort-summary .summary-item {
          gap: 0.1rem;
        }
        #cardSortBar .control-label {
          font-size: 0.7rem;
        }
        #cardSortBar .control-select {
          font-size: 0.72rem;
          min-width: 5.5rem;
        }
      }

    </style>
  </head>
  <body>
    <!-- Application Header -->
    <div class="app-header">
      <div>
        <h1 class="app-logo" id="appLogo" aria-label="StakTrakr">
          <svg class="stackr-logo" viewBox="35 5 355 145" xmlns="http://www.w3.org/2000/svg" width="100%" style="max-width: 666px;">
            <defs>
              <!-- Light Mode Gradients -->
              <linearGradient id="goldLight" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="#FFD700"/>
                <stop offset="30%" stop-color="#FFA500"/>
                <stop offset="70%" stop-color="#B8860B"/>
                <stop offset="100%" stop-color="#8B6914"/>
              </linearGradient>
              
              <linearGradient id="silverLight" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="#F8F8FF"/>
                <stop offset="30%" stop-color="#E5E5E5"/>
                <stop offset="70%" stop-color="#C0C0C0"/>
                <stop offset="100%" stop-color="#A0A0A0"/>
              </linearGradient>
              
              <!-- Dark Mode Gradients -->
              <linearGradient id="goldDark" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="#FFED4E"/>
                <stop offset="30%" stop-color="#FFD700"/>
                <stop offset="70%" stop-color="#FFA500"/>
                <stop offset="100%" stop-color="#CC8400"/>
              </linearGradient>
              
              <linearGradient id="silverDark" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="#FFFFFF"/>
                <stop offset="30%" stop-color="#F5F5F5"/>
                <stop offset="70%" stop-color="#E0E0E0"/>
                <stop offset="100%" stop-color="#C0C0C0"/>
              </linearGradient>
              
              <!-- Sepia Mode Gradients -->
              <linearGradient id="goldSepia" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="#D4A574"/>
                <stop offset="30%" stop-color="#B58900"/>
                <stop offset="70%" stop-color="#8B6914"/>
                <stop offset="100%" stop-color="#6B5416"/>
              </linearGradient>
              
              <linearGradient id="silverSepia" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="#F2E7D5"/>
                <stop offset="30%" stop-color="#D1C2A5"/>
                <stop offset="70%" stop-color="#A8A29E"/>
                <stop offset="100%" stop-color="#8D8D8D"/>
              </linearGradient>
            </defs>
            
            <!-- Light Mode Group -->
            <g class="light-mode">
              <!-- Shadow layer for light mode -->
              <text x="53" y="83" font-family="Arial, sans-serif" font-size="72" font-weight="bold" fill="rgba(0,0,0,0.3)">
                <tspan class="logo-silver">Stak</tspan><tspan class="logo-gold">Trakr</tspan>
              </text>
              <!-- Main title -->
              <text x="50" y="80" font-family="Arial, sans-serif" font-size="72" font-weight="bold">
                <tspan class="logo-silver" fill="url(#silverLight)">Stak</tspan><tspan class="logo-gold" fill="url(#goldLight)">Trakr</tspan>
              </text>

              <!-- Tagline shadow -->
              <text x="52" y="132" font-family="Arial, sans-serif" font-size="32" fill="rgba(0,0,0,0.2)">
                Your Stack. Your Way.
              </text>
              <!-- Tagline -->
              <text x="50" y="130" font-family="Arial, sans-serif" font-size="32" fill="#666666">
                Your Stack. Your Way.
              </text>
            </g>
            
            <!-- Dark Mode Group -->
            <g class="dark-mode">
              <!-- Shadow layer for dark mode -->
              <text x="53" y="83" font-family="Arial, sans-serif" font-size="72" font-weight="bold" fill="rgba(0,0,0,0.5)">
                <tspan class="logo-silver">Stak</tspan><tspan class="logo-gold">Trakr</tspan>
              </text>
              <!-- Main title -->
              <text x="50" y="80" font-family="Arial, sans-serif" font-size="72" font-weight="bold">
                <tspan class="logo-silver" fill="url(#silverDark)">Stak</tspan><tspan class="logo-gold" fill="url(#goldDark)">Trakr</tspan>
              </text>

              <!-- Tagline shadow -->
              <text x="52" y="132" font-family="Arial, sans-serif" font-size="32" fill="rgba(0,0,0,0.3)">
                Your Stack. Your Way.
              </text>
              <!-- Tagline -->
              <text x="50" y="130" font-family="Arial, sans-serif" font-size="32" fill="#E0E0E0">
                Your Stack. Your Way.
              </text>
            </g>
            
            <!-- Sepia Mode Group -->
            <g class="sepia-mode">
              <!-- Shadow layer for sepia mode -->
              <text x="53" y="83" font-family="Arial, sans-serif" font-size="72" font-weight="bold" fill="rgba(62,47,30,0.4)">
                <tspan class="logo-silver">Stak</tspan><tspan class="logo-gold">Trakr</tspan>
              </text>
              <!-- Main title -->
              <text x="50" y="80" font-family="Arial, sans-serif" font-size="72" font-weight="bold">
                <tspan class="logo-silver" fill="url(#silverSepia)">Stak</tspan><tspan class="logo-gold" fill="url(#goldSepia)">Trakr</tspan>
              </text>

              <!-- Tagline shadow -->
              <text x="52" y="132" font-family="Arial, sans-serif" font-size="32" fill="rgba(62,47,30,0.3)">
                Your Stack. Your Way.
              </text>
              <!-- Tagline -->
              <text x="50" y="130" font-family="Arial, sans-serif" font-size="32" fill="#6F604E">
                Your Stack. Your Way.
              </text>
            </g>
          </svg>
        </h1>
      </div>
      <div class="app-header-actions">
        <!-- Theme cycle button (STACK-54) -->
        <button class="btn theme-btn header-toggle-btn" id="headerThemeBtn"
                title="Cycle theme" aria-label="Cycle theme">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3"/>
            <line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/>
            <line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
        </button>
        <!-- Currency toggle button (STACK-54) -->
        <button class="btn theme-btn header-toggle-btn" id="headerCurrencyBtn"
                title="Toggle currency" aria-label="Toggle currency">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23"/>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
          </svg>
        </button>
        <!-- Trend cycle button -->
        <button class="btn theme-btn header-toggle-btn" id="headerTrendBtn"
                title="Trend period" aria-label="Trend period" style="display:none">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
          <span class="header-trend-label" id="headerTrendLabel">90d</span>
        </button>
        <!-- Sync all spot prices button -->
        <button class="btn theme-btn header-toggle-btn" id="headerSyncBtn"
                title="Sync all spot prices" aria-label="Sync all spot prices" style="display:none">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/>
            <path d="M2.5 11.5a10 10 0 0 1 18.4-4.5"/>
            <path d="M21.5 12.5a10 10 0 0 1-18.4 4.5"/>
          </svg>
        </button>
        <button class="btn theme-btn" id="aboutBtn" title="About" aria-label="About">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="16" x2="12" y2="12"/>
            <line x1="12" y1="8" x2="12.01" y2="8"/>
          </svg>
        </button>
        <button class="btn theme-btn" id="settingsBtn" title="Settings" aria-label="Settings">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        </button>
      </div>
    </div>
    <div class="container">
      <!-- =============================================================================
         SPOT PRICES SECTION
         
         Displays current spot prices for all four supported metals and provides
         manual input controls for setting custom spot prices. Each metal has:
         - Display card showing current spot price
         - Input field for setting new spot price
         - Save and Reset buttons for price management
         
         Spot prices are used for premium calculations and profit/loss analysis
         ============================================================================= -->
      <section class="spot-prices" id="spotPricesSection">
        <div class="spot-cards-grid">
          <!-- Silver spot price card -->
          <div class="spot-input silver">
            <div class="spot-card" data-metal="silver">
              <canvas class="spot-sparkline" id="sparklineSilver" aria-hidden="true"></canvas>
              <div class="spot-card-header">
                <div class="spot-card-label">Silver Spot Price</div>
                <div class="spot-card-controls">
                  <select class="spot-range-select" id="spotRangeSilver" title="Trend period">
                    <option value="1">1d</option>
                    <option value="7">7d</option>
                    <option value="14">14d</option>
                    <option value="30">30d</option>
                    <option value="60">60d</option>
                    <option value="90" selected>90d</option>
                    <option value="365">1Y</option>
                    <option value="1095">3Y</option>
                    <option value="1825">5Y</option>
                    <option value="3650">10Y</option>
                  </select>
                  <button class="spot-sync-icon" id="syncIconSilver" title="Sync from API" disabled>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M2.5 11.5a10 10 0 0 1 18.4-4.5"/><path d="M21.5 12.5a10 10 0 0 1-18.4 4.5"/></svg>
                  </button>
                </div>
              </div>
              <div class="spot-card-value" id="spotPriceDisplaySilver" title="Shift+click to edit">—</div>
              <div class="spot-card-change" id="spotChangeSilver"></div>
              <div class="spot-card-timestamp" id="spotTimestampSilver">No data</div>
            </div>
          </div>
          <!-- Gold spot price card -->
          <div class="spot-input gold">
            <div class="spot-card" data-metal="gold">
              <canvas class="spot-sparkline" id="sparklineGold" aria-hidden="true"></canvas>
              <div class="spot-card-header">
                <div class="spot-card-label">Gold Spot Price</div>
                <div class="spot-card-controls">
                  <select class="spot-range-select" id="spotRangeGold" title="Trend period">
                    <option value="1">1d</option>
                    <option value="7">7d</option>
                    <option value="14">14d</option>
                    <option value="30">30d</option>
                    <option value="60">60d</option>
                    <option value="90" selected>90d</option>
                    <option value="365">1Y</option>
                    <option value="1095">3Y</option>
                    <option value="1825">5Y</option>
                    <option value="3650">10Y</option>
                  </select>
                  <button class="spot-sync-icon" id="syncIconGold" title="Sync from API" disabled>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M2.5 11.5a10 10 0 0 1 18.4-4.5"/><path d="M21.5 12.5a10 10 0 0 1-18.4 4.5"/></svg>
                  </button>
                </div>
              </div>
              <div class="spot-card-value" id="spotPriceDisplayGold" title="Shift+click to edit">—</div>
              <div class="spot-card-change" id="spotChangeGold"></div>
              <div class="spot-card-timestamp" id="spotTimestampGold">No data</div>
            </div>
          </div>
          <!-- Platinum spot price card -->
          <div class="spot-input platinum">
            <div class="spot-card" data-metal="platinum">
              <canvas class="spot-sparkline" id="sparklinePlatinum" aria-hidden="true"></canvas>
              <div class="spot-card-header">
                <div class="spot-card-label">Platinum Spot Price</div>
                <div class="spot-card-controls">
                  <select class="spot-range-select" id="spotRangePlatinum" title="Trend period">
                    <option value="1">1d</option>
                    <option value="7">7d</option>
                    <option value="14">14d</option>
                    <option value="30">30d</option>
                    <option value="60">60d</option>
                    <option value="90" selected>90d</option>
                    <option value="365">1Y</option>
                    <option value="1095">3Y</option>
                    <option value="1825">5Y</option>
                    <option value="3650">10Y</option>
                  </select>
                  <button class="spot-sync-icon" id="syncIconPlatinum" title="Sync from API" disabled>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M2.5 11.5a10 10 0 0 1 18.4-4.5"/><path d="M21.5 12.5a10 10 0 0 1-18.4 4.5"/></svg>
                  </button>
                </div>
              </div>
              <div class="spot-card-value" id="spotPriceDisplayPlatinum" title="Shift+click to edit">—</div>
              <div class="spot-card-change" id="spotChangePlatinum"></div>
              <div class="spot-card-timestamp" id="spotTimestampPlatinum">No data</div>
            </div>
          </div>
          <!-- Palladium spot price card -->
          <div class="spot-input palladium">
            <div class="spot-card" data-metal="palladium">
              <canvas class="spot-sparkline" id="sparklinePalladium" aria-hidden="true"></canvas>
              <div class="spot-card-header">
                <div class="spot-card-label">Palladium Spot Price</div>
                <div class="spot-card-controls">
                  <select class="spot-range-select" id="spotRangePalladium" title="Trend period">
                    <option value="1">1d</option>
                    <option value="7">7d</option>
                    <option value="14">14d</option>
                    <option value="30">30d</option>
                    <option value="60">60d</option>
                    <option value="90" selected>90d</option>
                    <option value="365">1Y</option>
                    <option value="1095">3Y</option>
                    <option value="1825">5Y</option>
                    <option value="3650">10Y</option>
                  </select>
                  <button class="spot-sync-icon" id="syncIconPalladium" title="Sync from API" disabled>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M2.5 11.5a10 10 0 0 1 18.4-4.5"/><path d="M21.5 12.5a10 10 0 0 1-18.4 4.5"/></svg>
                  </button>
                </div>
              </div>
              <div class="spot-card-value" id="spotPriceDisplayPalladium" title="Shift+click to edit">—</div>
              <div class="spot-card-change" id="spotChangePalladium"></div>
              <div class="spot-card-timestamp" id="spotTimestampPalladium">No data</div>
            </div>
          </div>
        </div>
      </section><!-- =============================================================================
         TOTALS SECTION

         Comprehensive financial summary cards for each metal type showing:
         - Total items and weight in inventory
         - Purchase price vs current value calculations
         - Average prices and premium analysis
         - Profit/loss calculations
         - Clickable totals titles opening analytics modals with pie charts

         All calculations are performed by updateSummary() in inventory.js
         Values are updated automatically when inventory changes
         ============================================================================= -->
      <section class="totals-section" id="totalsSectionEl">
        <div class="totals-wrapper">
          <button class="totals-nav-btn totals-prev" id="totalsPrev" aria-label="Previous card">&#8249;</button>
          <div class="totals" id="totalsCarousel">
          <!-- Silver totals card -->
          <div class="total-card silver">
            <div class="total-title" data-metal="Silver">Silver</div>
            <div class="total-group">
              <div class="total-item">
                <span class="total-label">Items:</span>
                <span class="total-value" id="totalItemsSilver">0</span>
              </div>
              <div class="total-item">
                <span class="total-label">Weight (oz):</span>
                <span class="total-value" id="totalWeightSilver">0.00</span>
              </div>
              <div class="total-item">
                <span class="total-label">Avg Cost/oz:</span>
                <span class="total-value" id="avgCostPerOzSilver">$0.00</span>
              </div>
            </div>
            <div class="total-group">
              <div class="total-item">
                <span class="total-label">Purchase Price:</span>
                <span class="total-value" id="totalPurchasedSilver">$0.00</span>
              </div>
              <div class="total-item">
                <span class="total-label">Melt Value:</span>
                <span class="total-value" id="currentValueSilver">$0.00</span>
              </div>
              <div class="total-item">
                <span class="total-label">Retail Value:</span>
                <span class="total-value" id="retailValueSilver">$0.00</span>
              </div>
              <div class="total-item total-item-bottom-line">
                <span class="total-label">Gain/Loss:</span>
                <span class="total-value" id="lossProfitSilver">$0.00</span>
              </div>
            </div>
          </div>
          <!-- Gold totals card -->
          <div class="total-card gold">
            <div class="total-title" data-metal="Gold">Gold</div>
            <div class="total-group">
              <div class="total-item">
                <span class="total-label">Items:</span>
                <span class="total-value" id="totalItemsGold">0</span>
              </div>
              <div class="total-item">
                <span class="total-label">Weight (oz):</span>
                <span class="total-value" id="totalWeightGold">0.00</span>
              </div>
              <div class="total-item">
                <span class="total-label">Avg Cost/oz:</span>
                <span class="total-value" id="avgCostPerOzGold">$0.00</span>
              </div>
            </div>
            <div class="total-group">
              <div class="total-item">
                <span class="total-label">Purchase Price:</span>
                <span class="total-value" id="totalPurchasedGold">$0.00</span>
              </div>
              <div class="total-item">
                <span class="total-label">Melt Value:</span>
                <span class="total-value" id="currentValueGold">$0.00</span>
              </div>
              <div class="total-item">
                <span class="total-label">Retail Value:</span>
                <span class="total-value" id="retailValueGold">$0.00</span>
              </div>
              <div class="total-item total-item-bottom-line">
                <span class="total-label">Gain/Loss:</span>
                <span class="total-value" id="lossProfitGold">$0.00</span>
              </div>
            </div>
          </div>
          <!-- Platinum totals card -->
          <div class="total-card platinum">
            <div class="total-title" data-metal="Platinum">Platinum</div>
            <div class="total-group">
              <div class="total-item">
                <span class="total-label">Items:</span>
                <span class="total-value" id="totalItemsPlatinum">0</span>
              </div>
              <div class="total-item">
                <span class="total-label">Weight (oz):</span>
                <span class="total-value" id="totalWeightPlatinum">0.00</span>
              </div>
              <div class="total-item">
                <span class="total-label">Avg Cost/oz:</span>
                <span class="total-value" id="avgCostPerOzPlatinum">$0.00</span>
              </div>
            </div>
            <div class="total-group">
              <div class="total-item">
                <span class="total-label">Purchase Price:</span>
                <span class="total-value" id="totalPurchasedPlatinum">$0.00</span>
              </div>
              <div class="total-item">
                <span class="total-label">Melt Value:</span>
                <span class="total-value" id="currentValuePlatinum">$0.00</span>
              </div>
              <div class="total-item">
                <span class="total-label">Retail Value:</span>
                <span class="total-value" id="retailValuePlatinum">$0.00</span>
              </div>
              <div class="total-item total-item-bottom-line">
                <span class="total-label">Gain/Loss:</span>
                <span class="total-value" id="lossProfitPlatinum">$0.00</span>
              </div>
            </div>
          </div>
          <!-- Palladium totals card -->
          <div class="total-card palladium">
            <div class="total-title" data-metal="Palladium">Palladium</div>
            <div class="total-group">
              <div class="total-item">
                <span class="total-label">Items:</span>
                <span class="total-value" id="totalItemsPalladium">0</span>
              </div>
              <div class="total-item">
                <span class="total-label">Weight (oz):</span>
                <span class="total-value" id="totalWeightPalladium">0.00</span>
              </div>
              <div class="total-item">
                <span class="total-label">Avg Cost/oz:</span>
                <span class="total-value" id="avgCostPerOzPalladium">$0.00</span>
              </div>
            </div>
            <div class="total-group">
              <div class="total-item">
                <span class="total-label">Purchase Price:</span>
                <span class="total-value" id="totalPurchasedPalladium">$0.00</span>
              </div>
              <div class="total-item">
                <span class="total-label">Melt Value:</span>
                <span class="total-value" id="currentValuePalladium">$0.00</span>
              </div>
              <div class="total-item">
                <span class="total-label">Retail Value:</span>
                <span class="total-value" id="retailValuePalladium">$0.00</span>
              </div>
              <div class="total-item total-item-bottom-line">
                <span class="total-label">Gain/Loss:</span>
                <span class="total-value" id="lossProfitPalladium">$0.00</span>
              </div>
            </div>
          </div>
          <!-- All metals combined totals card -->
          <div class="total-card total-card-all">
            <div class="total-title" data-metal="All">All Metals</div>
            <div class="total-group">
              <div class="total-item">
                <span class="total-label">Items:</span>
                <span class="total-value" id="totalItemsAll">0</span>
              </div>
              <div class="total-item">
                <span class="total-label">Weight (oz):</span>
                <span class="total-value" id="totalWeightAll">0.00</span>
              </div>
              <div class="total-item">
                <span class="total-label">Avg Cost/oz:</span>
                <span class="total-value" id="avgCostPerOzAll">$0.00</span>
              </div>
            </div>
            <div class="total-group">
              <div class="total-item">
                <span class="total-label">Purchase Price:</span>
                <span class="total-value" id="totalPurchasedAll">$0.00</span>
              </div>
              <div class="total-item">
                <span class="total-label">Melt Value:</span>
                <span class="total-value" id="currentValueAll">$0.00</span>
              </div>
              <div class="total-item">
                <span class="total-label">Retail Value:</span>
                <span class="total-value" id="retailValueAll">$0.00</span>
              </div>
              <div class="total-item total-item-bottom-line">
                <span class="total-label">Gain/Loss:</span>
                <span class="total-value" id="lossProfitAll">$0.00</span>
              </div>
            </div>
          </div>
          </div><!-- /.totals -->
          <button class="totals-nav-btn totals-next" id="totalsNext" aria-label="Next card">&#8250;</button>
          <div class="totals-dots" id="totalsDots"></div>
        </div><!-- /.totals-wrapper -->
      </section>
      <!-- =============================================================================
         INVENTORY FORM SECTION
         
         Primary data entry form for adding new inventory items. Includes fields for:
         - Metal type selection (Silver, Gold, Platinum, Palladium)
         - Item details (name, type, quantity, weight)
         - Purchase information (price, location, storage location, date)
         
         Form submission is handled by events.js with validation and automatic
         premium calculation based on current spot prices
         ============================================================================= -->
      <!--
        Legacy add item form - commented out pending removal after
        verifying new modal workflow.
      <section class="form-section">
        ...
      </section>
      -->
      <!-- =============================================================================
         INVENTORY

         Wrapper containing search and inventory table
         ============================================================================= -->
        <!-- =============================================================================
           SEARCH FUNCTIONALITY

           Live search interface that filters inventory table in real-time.
           Searches across all relevant fields including:
           - Metal type, name, type, purchase/storage locations, date
           - Quantity, weight, price values

           Search is case-insensitive and supports partial matches
           Implementation in search.js with filterInventory() function
           ============================================================================= -->
        <section class="search-section" id="searchSectionEl">
          <div class="search-container">
            <button
              class="btn search-action-btn add-btn"
              id="newItemBtn"
              title="Add new item"
              aria-label="Add new item"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="16"/>
                <line x1="8" y1="12" x2="16" y2="12"/>
              </svg>
              <span>Add Item</span>
            </button>
            <input
              id="searchInput"
              placeholder="Search inventory by metal, name, type, purchase location, storage location, notes, date..."
              type="text"
            />
            <button
              class="btn search-action-btn clear-btn"
              id="clearBtn"
              title="Clear search"
              aria-label="Clear search"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
              <span>Clear</span>
            </button>
            <button
              class="btn search-action-btn log-btn" id="changeLogBtn" title="Change log" aria-label="Change log">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14,2 14,8 20,8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10,9 9,9 8,9"/>
              </svg>
              <span>Log</span>
            </button>
          </div>
          
          <!-- Integrated Filters -->
          <div class="search-filters">
            <div class="filter-controls">
              <div class="control-group">
                <label for="chipMinCount" class="control-label">Filter Chips:</label>
                <select id="chipMinCount" class="control-select" title="Minimum number of items before showing a filter chip">
                  <option value="2">2+</option>
                  <option value="3" selected>3+</option>
                  <option value="5">5+</option>
                  <option value="10">10+</option>
                  <option value="100">100+</option>
                </select>
              </div>
              <div class="control-group">
                <span class="control-label">Smart Grouping:</span>
                <div class="chip-sort-toggle" id="groupNameChips" title="Group similar item names (e.g., 'American Silver Eagle (3)' instead of separate year chips)">
                  <button type="button" class="chip-sort-btn active" data-val="yes">On</button>
                  <button type="button" class="chip-sort-btn" data-val="no">Off</button>
                </div>
              </div>
              <div class="control-group">
                <span class="control-label">Chip Sort:</span>
                <div class="chip-sort-toggle" id="chipSortOrder" title="Sort chips within each category">
                  <button type="button" class="chip-sort-btn active" data-sort="alpha">A-Z</button>
                  <button type="button" class="chip-sort-btn" data-sort="count">Qty</button>
                </div>
              </div>
              <div class="control-group" id="saveSearchPatternGroup" style="display:none">
                <button type="button" class="chip-sort-btn save-filter-btn" id="saveSearchPatternBtn" title="Save current search as a custom filter chip">Save Filter</button>
              </div>
            </div>
            <div class="filter-row">
              <div class="active-filters" id="activeFilters"></div>
              <div class="search-results-info" id="searchResultsInfo"></div>
            </div>
          </div>
          <!-- Portfolio summary: Buy / Melt / Market / G/L — full-width bottom row -->
          <div class="card-sort-summary" id="cardSortSummary"></div>
        </section>
        <!-- =============================================================================
           INVENTORY TABLE SECTION

           Main data display table showing all inventory items with:
           - Sortable columns (click headers to sort ascending/descending)
           - Clickable item names for editing (opens edit modal)
           - Delete buttons with confirmation
           - Responsive design with column resizing capability

        Table rendering handled by renderTable() in inventory.js
         Portal view shows all items in a scrollable table with sticky headers
         ============================================================================= -->
        <section class="table-section" id="tableSectionEl">
          <!-- PROTOTYPE: Sort bar always visible. Style D = table view. -->
          <div class="card-sort-bar" id="cardSortBar">
            <div class="card-sort-left">
              <span class="control-label">Sort:</span>
              <select id="cardSortColumn" class="control-select" title="Sort cards by column">
                <option value="0">Date</option>
                <option value="1">Metal</option>
                <option value="2">Type</option>
                <option value="4">Name</option>
                <option value="5">Qty</option>
                <option value="6">Weight</option>
                <option value="7">Purchase</option>
                <option value="8">Melt Value</option>
                <option value="9">Retail</option>
                <option value="10">Gain/Loss</option>
                <option value="11">Source</option>
              </select>
              <button type="button" class="card-sort-dir-btn" id="cardSortDirBtn" title="Toggle sort direction">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline class="sort-arrow-up" points="18 15 12 9 6 15"/>
                  <polyline class="sort-arrow-down" points="6 9 12 15 18 9"/>
                </svg>
              </button>
            </div>
            <div class="card-sort-right">
              <span class="control-label">View:</span>
              <div class="chip-sort-toggle" id="cardStyleToggle">
                <button type="button" class="chip-sort-btn active" data-style="A" title="Sparkline cards">A</button>
                <button type="button" class="chip-sort-btn" data-style="B" title="Hero cards">B</button>
                <button type="button" class="chip-sort-btn" data-style="C" title="Split cards">C</button>
                <button type="button" class="chip-sort-btn" data-style="D" title="Table view">
                  <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="9" x2="9" y2="21"/><line x1="15" y1="9" x2="15" y2="21"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          <div class="card-view-grid" id="cardViewGrid"></div>
          <div class="portal-scroll">
          <table id="inventoryTable">
          <thead>
            <tr>
              <th class="shrink" data-column="date">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                  <line x1="16" y1="2" x2="16" y2="6"/>
                  <line x1="8" y1="2" x2="8" y2="6"/>
                  <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                <span class="header-text">Date</span>
              </th>
              <th class="shrink" data-column="metal">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon">
                  <circle cx="12" cy="12" r="10"/>
                  <circle cx="12" cy="12" r="6"/>
                  <circle cx="12" cy="12" r="2"/>
                </svg>
                <span class="header-text">Metal</span>
              </th>
              <th class="shrink" data-column="type">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon">
                  <polygon points="12,2 22,8.5 22,15.5 12,22 2,15.5 2,8.5"/>
                </svg>
                <span class="header-text">Type</span>
              </th>
              <th class="shrink" data-column="image">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <polyline points="21 15 16 10 5 21"/>
                </svg>
                <span class="header-text">Image</span>
              </th>
              <th class="expand" data-column="name">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
                <span class="header-text">Name</span>
              </th>
              <th class="shrink center-align" data-column="qty">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon">
                  <line x1="8" y1="6" x2="21" y2="6"/>
                  <line x1="8" y1="12" x2="21" y2="12"/>
                  <line x1="8" y1="18" x2="21" y2="18"/>
                  <line x1="3" y1="6" x2="3.01" y2="6"/>
                  <line x1="3" y1="12" x2="3.01" y2="12"/>
                  <line x1="3" y1="18" x2="3.01" y2="18"/>
                </svg>
                <span class="header-text">Qty</span>
              </th>
              <th class="shrink" data-column="weight">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                <span class="header-text">Weight</span>
              </th>
              <th class="shrink" data-column="purchasePrice" title="USD">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon">
                  <line x1="12" y1="1" x2="12" y2="23"/>
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
                <span class="header-text">Purchase</span>
              </th>
              <th class="shrink" data-column="meltValue" title="USD">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon">
                  <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2z"/>
                  <path d="M12 6v6l4 2"/>
                </svg>
                <span class="header-text">Melt</span>
              </th>
              <th class="shrink" data-column="retailPrice" title="USD">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon">
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                </svg>
                <span class="header-text">Retail</span>
              </th>
              <th class="shrink" data-column="gainLoss" title="USD">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon">
                  <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                  <polyline points="17 6 23 6 23 12"/>
                </svg>
                <span class="header-text">Gain/Loss</span>
              </th>
              <th class="shrink" data-column="purchaseLocation">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon">
                  <path d="M3 9l1.5-5h15L21 9"/>
                  <path d="M3 9v11a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1V9"/>
                  <path d="M9 21V13h6v8"/>
                </svg>
                <span class="header-text">Source</span>
              </th>
              <th class="icon-col actions-col" data-column="actions" aria-label="Actions" title="Actions">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon">
                  <circle cx="12" cy="5" r="1.5"/>
                  <circle cx="12" cy="12" r="1.5"/>
                  <circle cx="12" cy="19" r="1.5"/>
                </svg>
                <span class="header-text">Actions</span>
              </th>
            </tr>
          </thead>
          <tbody></tbody>
          </table>
          </div>
          <div class="table-footer-controls">
            <div class="table-item-count"><strong id="itemCount"></strong></div>
            <select id="itemsPerPage" class="control-select" title="Visible rows">
              <option value="3">3</option>
              <option value="6">6</option>
              <option value="12" selected>12</option>
              <option value="24">24</option>
              <option value="48">48</option>
              <option value="96">96</option>
              <option value="128">128</option>
              <option value="512">512</option>
              <option value="all">All</option>
            </select>
          </div>
          
          <!-- Bulk Edit Control Panel -->
          <div class="bulk-edit-panel" id="bulkEditPanel" style="display: none;">
            <div class="bulk-edit-controls">
              <button class="bulk-edit-btn toggle-all-btn" id="bulkToggleAll" title="Toggle all items edit mode">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="bulk-edit-icon">
                  <path d="M14.06,9L15,9.94L5.92,19H5V18.08L14.06,9M17.66,3C17.41,3 17.15,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.66,3M14.06,6.19L3,17.25V21H6.75L17.81,9.94L14.06,6.19Z"/>
                </svg>
              </button>
              <button class="bulk-edit-btn save-all-btn" id="bulkSaveAll" title="Save all changes">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="bulk-edit-icon">
                  <path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/>
                </svg>
              </button>
              <button class="bulk-edit-btn cancel-all-btn" id="bulkCancelAll" title="Cancel all changes">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="bulk-edit-icon">
                  <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                </svg>
              </button>
            </div>
          </div>
        </section>
      <!-- =============================================================================
         IMPORT/EXPORT SECTION
         
         Comprehensive data management with support for multiple formats:
         
         IMPORT OPTIONS:
         - CSV: Standard comma-separated values with automatic field mapping
         - JSON: Native application format preserving all data
         
         EXPORT OPTIONS:
         - CSV: Compatible with spreadsheet applications
         - JSON: Full data backup with metadata
         - PDF: Print-ready report with totals and formatting
         - HTML: Standalone web page with embedded styles
         
         All import/export functions include data validation and error handling
         Implementation in inventory.js with format-specific parsing
      ============================================================================= -->
    </div>
    <!-- UNIFIED ITEM MODAL (Add / Edit) -->
    <div class="modal" id="itemModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="itemModalTitle">Add Inventory Item</h2>
          <button aria-label="Close modal" class="modal-close" id="itemCloseBtn">×</button>
        </div>
        <div class="modal-body">
          <form id="inventoryForm">
            <!-- Hidden fields -->
            <input type="hidden" id="itemSerial" value="" />
            <input type="hidden" id="itemSpotPrice" value="" />

            <!-- ═══════════════════════════════════════════════════════
                 CORE FIELDS — Always visible
                 ═══════════════════════════════════════════════════════ -->

            <!-- Row: Metal & Type -->
            <div class="grid grid-2">
              <div>
                <label for="itemMetal">Metal</label>
                <select id="itemMetal">
                  <option value="Silver">Silver</option>
                  <option value="Gold">Gold</option>
                  <option value="Platinum">Platinum</option>
                  <option value="Palladium">Palladium</option>
                </select>
              </div>
              <div>
                <label for="itemType">Type</label>
                <select id="itemType">
                  <option value="Coin">Coin</option>
                  <option value="Bar">Bar</option>
                  <option value="Round">Round</option>
                  <option value="Note">Note</option>
                  <option value="Aurum">Aurum</option>
                  <option value="Set">Set</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>
            <!-- Row: Purity, Quantity, Weight, Unit -->
            <div class="grid grid-purity-row">
              <div>
                <label for="itemPuritySelect">Purity <span style="font-weight:normal;opacity:0.6;">(fineness)</span></label>
                <select id="itemPuritySelect">
                  <option value="1.0">100% — Pure</option>
                  <option value="0.9999">.9999 — Four Nines</option>
                  <option value="0.9995">.9995 — Pure Platinum</option>
                  <option value="0.999">.999 — Fine</option>
                  <option value="0.925">.925 — Sterling</option>
                  <option value="0.9167">.9167 — 22K (Krugerrand)</option>
                  <option value="0.900">.900 — 90% Silver</option>
                  <option value="0.800">.800 — 80% (European)</option>
                  <option value="0.600">.600 — 60%</option>
                  <option value="0.400">.400 — 40% Silver</option>
                  <option value="0.350">.350 — War Nickels</option>
                  <option value="custom">Custom…</option>
                </select>
              </div>
              <div>
                <label for="itemQty">Quantity</label>
                <input id="itemQty" min="1" required step="1" type="number" value="1" />
              </div>
              <div>
                <label for="itemWeight" id="itemWeightLabel">Weight</label>
                <input id="itemWeight" inputmode="decimal" placeholder="1, 0.5, 1/10" required type="text" value="1" />
                <select id="itemGbDenom" style="display:none;">
                  <option value="0.5">½ Goldback</option>
                  <option value="1" selected>1 Goldback</option>
                  <option value="2">2 Goldback</option>
                  <option value="5">5 Goldback</option>
                  <option value="10">10 Goldback</option>
                  <option value="25">25 Goldback</option>
                  <option value="50">50 Goldback</option>
                  <option value="100">100 Goldback</option>
                </select>
              </div>
              <div>
                <label>&nbsp;</label>
                <select id="itemWeightUnit">
                  <option value="oz">ounce</option>
                  <option value="g">gram</option>
                  <option value="gb">goldback</option>
                </select>
              </div>
            </div>
            <div id="purityCustomWrapper" class="grid grid-2" style="display:none;">
              <div>
                <label for="itemPurity">Custom Purity</label>
                <input id="itemPurity" type="number" min="0.001" max="1" step="0.0001" placeholder="e.g. 0.9995" />
              </div>
            </div>
            <!-- Row: Name & Year -->
            <div class="grid grid-name-year">
              <div>
                <label for="itemName">Name</label>
                <div class="input-with-action">
                  <input id="itemName" required type="text" />
                  <button class="inline-search-btn" id="searchNumistaNameBtn" type="button"
                          title="Search Numista catalog by name">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/>
                    </svg>
                  </button>
                </div>
              </div>
              <div>
                <label for="itemYear">Year <span style="font-weight:normal;opacity:0.6;">(optional)</span></label>
                <input id="itemYear" type="text" placeholder="e.g. 2024" />
              </div>
            </div>
            <!-- Row: Purchase Date & Purchase Price -->
            <div class="grid grid-2">
              <div id="dateField">
                <label for="itemDate">Purchase Date <span style="font-weight:normal;opacity:0.6;">(optional)</span></label>
                <input id="itemDate" type="date" />
                <label class="date-na-label">
                  <input type="checkbox" id="itemDateNA" /> <span>N/A</span>
                </label>
              </div>
              <div>
                <label for="itemPrice">Purchase Price</label>
                <div class="currency-input input-with-action">
                  <input id="itemPrice" min="0" step="0.01" type="number" />
                  <button class="inline-search-btn" id="spotLookupBtn" type="button" disabled
                          title="Search for spot price on purchase date">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
            <!-- Row: Purchase Location & Storage Location -->
            <div class="grid grid-2">
              <div>
                <label for="purchaseLocation">Purchase Location</label>
                <input id="purchaseLocation" type="text" />
              </div>
              <div>
                <label for="storageLocation">Storage Location</label>
                <input id="storageLocation" type="text" placeholder="Vault A, Safe B, etc..." />
              </div>
            </div>
            <!-- Images — Unified upload / camera / URL per slot -->
            <div id="imageUploadGroup" class="image-upload-group" style="display:none">
              <label>Images</label>
              <div class="image-upload-sides">
                <!-- Obverse -->
                <div class="image-upload-side">
                  <span class="image-side-label">Obverse</span>
                  <div class="image-card">
                    <div id="itemImagePreviewObv" class="image-upload-preview" style="display:none">
                      <img id="itemImagePreviewImgObv" alt="Obverse preview" />
                    </div>
                    <div class="image-card-actions">
                      <input type="file" id="itemImageFileObv" accept="image/jpeg,image/png,image/webp" style="display:none" />
                      <button class="btn img-btn img-btn-upload" id="itemImageUploadBtnObv" type="button">Upload</button>
                      <button class="btn img-btn img-btn-url" id="itemImageUrlBtnObv" type="button" style="display:none">URL</button>
                      <button class="btn img-btn img-btn-camera" id="itemImageCameraBtnObv" type="button" style="display:none">Camera</button>
                      <button class="btn img-btn img-btn-remove" id="itemImageRemoveBtnObv" type="button" style="display:none">Remove</button>
                    </div>
                  </div>
                  <span id="itemImageSizeInfoObv" class="image-size-info"></span>
                  <div id="itemImageUrlInputObv" class="image-url-input" style="display:none">
                    <input id="itemObverseImageUrl" type="url" class="form-control" placeholder="https://example.com/obverse.jpg" />
                  </div>
                </div>
                <!-- Reverse -->
                <div class="image-upload-side">
                  <span class="image-side-label">Reverse</span>
                  <div class="image-card">
                    <div id="itemImagePreviewRev" class="image-upload-preview" style="display:none">
                      <img id="itemImagePreviewImgRev" alt="Reverse preview" />
                    </div>
                    <div class="image-card-actions">
                      <input type="file" id="itemImageFileRev" accept="image/jpeg,image/png,image/webp" style="display:none" />
                      <button class="btn img-btn img-btn-upload" id="itemImageUploadBtnRev" type="button">Upload</button>
                      <button class="btn img-btn img-btn-url" id="itemImageUrlBtnRev" type="button" style="display:none">URL</button>
                      <button class="btn img-btn img-btn-camera" id="itemImageCameraBtnRev" type="button" style="display:none">Camera</button>
                      <button class="btn img-btn img-btn-remove" id="itemImageRemoveBtnRev" type="button" style="display:none">Remove</button>
                    </div>
                  </div>
                  <span id="itemImageSizeInfoRev" class="image-size-info"></span>
                  <div id="itemImageUrlInputRev" class="image-url-input" style="display:none">
                    <input id="itemReverseImageUrl" type="url" class="form-control" placeholder="https://example.com/reverse.jpg" />
                  </div>
                </div>
              </div>
              <!-- Hidden wrapper preserved for feature-flag JS compatibility -->
              <div id="imageUrlGroup" style="display:none"></div>
              <div id="imagePatternToggleGroup" class="image-pattern-toggle-group" style="display:none">
                <div class="pattern-toggle-row">
                  <label class="settings-checkbox-label pattern-toggle-label">
                    <input type="checkbox" id="imagePatternToggle" />
                    Apply to all matching items
                  </label>
                  <button id="refreshImageUrlsBtn" type="button" class="btn secondary btn-sm pattern-refresh-btn" style="display:none" title="Fetch image URLs from Numista API (bypasses cache)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
                      <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                  </button>
                </div>
                <div id="imagePatternKeywordsGroup" style="display:none">
                  <input type="text" id="imagePatternKeywords" class="form-control" placeholder="e.g. American Silver Eagle, 2024" />
                  <small class="pattern-rule-tip">Pre-filled with the item name. Add year or keywords separated by commas to narrow matches.</small>
                </div>
              </div>
            </div>

            <!-- ═══════════════════════════════════════════════════════
                 COLLAPSIBLE — Grading & Certification
                 ═══════════════════════════════════════════════════════ -->
            <details class="form-section">
              <summary class="form-section-header">
                <span class="form-section-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                       stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
                  </svg>
                </span>
                Grading &amp; Certification
              </summary>
              <div class="form-section-body">
                <div class="grid grid-grade">
                  <div>
                    <label for="itemGrade">Grade <span style="font-weight:normal;opacity:0.6;">(optional)</span></label>
                    <select id="itemGrade">
                      <option value="">-- None --</option>
                      <optgroup label="Standard">
                        <option value="AG">AG - About Good</option>
                        <option value="G">G - Good</option>
                        <option value="VG">VG - Very Good</option>
                        <option value="F">F - Fine</option>
                        <option value="VF">VF - Very Fine</option>
                        <option value="XF">XF - Extremely Fine</option>
                        <option value="AU">AU - About Uncirculated</option>
                        <option value="UNC">UNC - Uncirculated</option>
                        <option value="BU">BU - Brilliant Uncirculated</option>
                      </optgroup>
                      <optgroup label="Mint State">
                        <option value="MS-60">MS-60</option>
                        <option value="MS-61">MS-61</option>
                        <option value="MS-62">MS-62</option>
                        <option value="MS-63">MS-63</option>
                        <option value="MS-64">MS-64</option>
                        <option value="MS-65">MS-65</option>
                        <option value="MS-66">MS-66</option>
                        <option value="MS-67">MS-67</option>
                        <option value="MS-68">MS-68</option>
                        <option value="MS-69">MS-69</option>
                        <option value="MS-70">MS-70</option>
                      </optgroup>
                      <optgroup label="Proof">
                        <option value="PF-60">PF-60</option>
                        <option value="PF-61">PF-61</option>
                        <option value="PF-62">PF-62</option>
                        <option value="PF-63">PF-63</option>
                        <option value="PF-64">PF-64</option>
                        <option value="PF-65">PF-65</option>
                        <option value="PF-66">PF-66</option>
                        <option value="PF-67">PF-67</option>
                        <option value="PF-68">PF-68</option>
                        <option value="PF-69">PF-69</option>
                        <option value="PF-70">PF-70</option>
                      </optgroup>
                    </select>
                  </div>
                  <div>
                    <label for="itemGradingAuthority">Authority <span style="font-weight:normal;opacity:0.6;">(optional)</span></label>
                    <select id="itemGradingAuthority">
                      <option value="">-- None --</option>
                      <option value="PCGS">PCGS</option>
                      <option value="NGC">NGC</option>
                      <option value="ANACS">ANACS</option>
                      <option value="ICG">ICG</option>
                    </select>
                  </div>
                  <div>
                    <label for="itemCertNumber">Cert #
                      <span id="certVerifiedIcon" style="display:none;color:#16a34a;margin-left:0.25rem;vertical-align:middle;" title="PCGS Verified"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></span>
                      <span style="font-weight:normal;opacity:0.6;">(optional)</span></label>
                    <div class="input-with-action">
                      <input id="itemCertNumber" type="text" placeholder="e.g. 12345678" />
                      <button class="inline-search-btn" id="lookupPcgsBtn" type="button"
                              title="Look up coin via PCGS Cert# or PCGS#">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                          <circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="grid grid-2">
                  <div>
                    <label for="itemCatalog">Numista #</label>
                    <div class="input-with-action">
                      <input id="itemCatalog" type="text" placeholder="e.g. 95694" />
                      <button class="inline-search-btn" id="searchNumistaBtn" type="button"
                              title="Search Numista catalog by N#">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                          <circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/>
                        </svg>
                        <span id="numistaModalStatusDot" class="api-status-dot disconnected" title="Numista API: disconnected"></span>
                      </button>
                    </div>
                  </div>
                  <div>
                    <label for="itemPcgsNumber">PCGS # <span style="font-weight:normal;opacity:0.6;">(optional)</span>
                      <a href="https://www.pcgs.com/pcgsnolookup" target="_blank" rel="noopener" title="Look up PCGS coin numbers" class="form-info-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                      </a>
                    </label>
                    <input id="itemPcgsNumber" type="text" placeholder="e.g. 786060" />
                  </div>
                </div>
              </div>
            </details>

            <!-- ═══════════════════════════════════════════════════════
                 COLLAPSIBLE — Pricing & Details
                 ═══════════════════════════════════════════════════════ -->
            <details class="form-section">
              <summary class="form-section-header">
                <span class="form-section-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                       stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                  </svg>
                </span>
                Pricing &amp; Details
              </summary>
              <div class="form-section-body">
                <div class="grid grid-2">
                  <div id="marketValueField">
                    <label for="itemMarketValue">Retail Price <span style="font-weight:normal;opacity:0.6;">(optional)</span>
                      <span id="retailPriceHistoryLink" class="field-history-link" title="View price history">&#x1f4c8;</span>
                    </label>
                    <div class="currency-input">
                      <input id="itemMarketValue" min="0" step="0.01" type="number" placeholder="Defaults to melt value" />
                    </div>
                  </div>
                  <div>
                    <label for="itemSerialNumber">Serial # <span style="font-weight:normal;opacity:0.6;">(optional)</span></label>
                    <input id="itemSerialNumber" type="text" placeholder="Bar or note serial number" />
                  </div>
                </div>
                <div class="grid grid-2" style="margin-top:0.35rem;">
                  <div>
                    <label class="settings-checkbox-label estimate-retail-label">
                      <input type="checkbox" id="estimateRetailFromSpot" />
                      Estimate Retail From Spot
                    </label>
                  </div>
                  <div>
                    <label for="retailSpotModifier">Modifier <span style="font-weight:normal;opacity:0.6;">(%)</span></label>
                    <input id="retailSpotModifier" type="number" min="0" step="0.1" placeholder="e.g. 5" disabled />
                  </div>
                </div>
              </div>
            </details>

            <!-- ═══════════════════════════════════════════════════════
                 COLLAPSIBLE — Numista Data
                 ═══════════════════════════════════════════════════════ -->
            <details class="form-section" id="numistaDataSection">
              <summary class="form-section-header">
                <span class="form-section-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                       stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                  </svg>
                </span>
                Numista Data
              </summary>
              <div class="form-section-body numista-data-fields">
                <div class="grid grid-2">
                  <div>
                    <label for="numistaCountry">Country</label>
                    <input id="numistaCountry" type="text" placeholder="e.g. United States" />
                  </div>
                  <div>
                    <label for="numistaDenomination">Denomination</label>
                    <input id="numistaDenomination" type="text" placeholder="e.g. 1 Dollar" />
                  </div>
                </div>
                <div class="grid grid-2">
                  <div>
                    <label for="numistaComposition">Composition</label>
                    <input id="numistaComposition" type="text" placeholder="e.g. Silver (.999)" />
                  </div>
                  <div>
                    <label for="numistaShape">Shape</label>
                    <input id="numistaShape" type="text" placeholder="e.g. Round" />
                  </div>
                </div>
                <div class="grid grid-3-equal">
                  <div>
                    <label for="numistaDiameter">Diameter <span style="font-weight:normal;opacity:0.6;">(mm)</span></label>
                    <input id="numistaDiameter" type="text" placeholder="e.g. 40.6" />
                  </div>
                  <div>
                    <label for="numistaThickness">Thickness <span style="font-weight:normal;opacity:0.6;">(mm)</span></label>
                    <input id="numistaThickness" type="text" placeholder="e.g. 2.98" />
                  </div>
                  <div>
                    <label for="numistaOrientation">Orientation</label>
                    <input id="numistaOrientation" type="text" placeholder="e.g. Coin" />
                  </div>
                </div>
                <div class="grid grid-2">
                  <div>
                    <label for="numistaTechnique">Technique</label>
                    <input id="numistaTechnique" type="text" placeholder="e.g. Milled" />
                  </div>
                  <div>
                    <label for="numistaMintage">Mintage</label>
                    <input id="numistaMintage" type="text" placeholder="e.g. 500,000" />
                  </div>
                </div>
                <div class="grid grid-2">
                  <div>
                    <label for="numistaRarity">Rarity Index</label>
                    <input id="numistaRarity" type="text" placeholder="e.g. 85" />
                  </div>
                  <div>
                    <label for="numistaKmRef">KM Reference</label>
                    <input id="numistaKmRef" type="text" placeholder="e.g. KM#273" />
                  </div>
                </div>
                <div>
                  <label class="settings-checkbox-label">
                    <input type="checkbox" id="numistaCommemorative" />
                    Commemorative
                  </label>
                </div>
                <div id="numistaCommemorativeDescWrap" style="display:none;">
                  <label for="numistaCommemorativeDesc">Commemorative Description</label>
                  <input id="numistaCommemorativeDesc" type="text" placeholder="What this coin commemorates..." />
                </div>
                <div>
                  <label for="numistaObverseDesc">Obverse Description</label>
                  <input id="numistaObverseDesc" type="text" placeholder="Obverse design description..." />
                </div>
                <div>
                  <label for="numistaReverseDesc">Reverse Description</label>
                  <input id="numistaReverseDesc" type="text" placeholder="Reverse design description..." />
                </div>
                <div>
                  <label for="numistaEdgeDesc">Edge Description</label>
                  <input id="numistaEdgeDesc" type="text" placeholder="Edge design description..." />
                </div>
              </div>
            </details>

            <!-- ═══════════════════════════════════════════════════════
                 COLLAPSIBLE — Notes
                 ═══════════════════════════════════════════════════════ -->
            <details class="form-section">
              <summary class="form-section-header">
                <span class="form-section-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                       stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>
                  </svg>
                </span>
                Notes
              </summary>
              <div class="form-section-body">
                <div>
                  <label for="itemNotes">Notes</label>
                  <input id="itemNotes" type="text" placeholder="Additional notes or comments..." />
                </div>
              </div>
            </details>

            <!-- ═══════════════════════════════════════════════════════
                 COLLAPSIBLE — Tags
                 ═══════════════════════════════════════════════════════ -->
            <details class="form-section" id="tagsSection">
              <summary class="form-section-header">
                <span class="form-section-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                       stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/>
                  </svg>
                </span>
                Tags
              </summary>
              <div class="form-section-body">
                <div id="itemModalTagsContainer" class="tags-edit-container">
                  <div id="itemModalNumistaTags" class="tags-row">
                    <label>Numista Tags</label>
                    <div class="tags-chips" id="numistaTagsChips">
                      <span class="tag-empty-hint">No Numista tags</span>
                    </div>
                  </div>
                  <div id="itemModalCustomTags" class="tags-row">
                    <label>Custom Tags</label>
                    <div class="tags-chips" id="customTagsChips">
                      <span class="tag-empty-hint">No custom tags</span>
                    </div>
                    <div class="tags-add-row">
                      <input type="text" id="newTagInput" placeholder="Add a tag..." class="form-control tag-input" />
                      <button type="button" id="addTagBtn" class="btn secondary btn-sm" title="Add tag">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </details>

            <!-- Form action buttons -->
            <div class="item-modal-actions">
              <div class="item-modal-actions-right">
                <button class="btn" id="undoChangeBtn" type="button" style="display:none">Undo</button>
                <button class="btn" id="cancelItem" type="button">Cancel</button>
                <button class="btn secondary" id="cloneItemBtn" type="button" style="display:none"
                        title="Clone this item as a new entry">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                       stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                       style="vertical-align: -2px; margin-right: 0.2rem;">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                  </svg>Clone
                </button>
                <button class="btn secondary" id="viewItemFromEditBtn" type="button" style="display:none"
                        title="View this item in read-only mode">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                       stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                       style="vertical-align: -2px; margin-right: 0.2rem;">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                  </svg>View
                </button>
                <button class="btn premium" id="itemModalSubmit" type="submit">Add to Inventory</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- =============================================================================
       NOTES MODAL

       Simple modal for viewing and editing item notes. Opens when the Notes
       button is clicked in the inventory table. Allows users to update the
       notes field without opening the full edit form.
       ============================================================================= -->
    <div class="modal" id="notesModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Item Notes</h2>
          <button aria-label="Close modal" class="modal-close" id="notesCloseBtn">×</button>
        </div>
        <div class="modal-body">
          <textarea id="notesTextarea" rows="6" style="width: 100%"></textarea>
          <div style="margin-top: 1rem; text-align: right">
            <button class="btn" id="cancelNotes" type="button">Cancel</button>
            <button class="btn premium" id="saveNotes" type="button">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- =============================================================================
       NOTES VIEW MODAL

       Read-only view of item notes. Click the notes indicator icon to open.
       Shift+click the indicator to open the full edit modal instead.
       ============================================================================= -->
    <div class="modal" id="notesViewModal" style="display: none">
      <div class="modal-content" style="max-width: 32rem;">
        <div class="modal-header">
          <h2 id="notesViewTitle">Notes</h2>
          <button aria-label="Close modal" class="modal-close" id="notesViewCloseBtn">×</button>
        </div>
        <div class="modal-body">
          <div id="notesViewContent" style="white-space: pre-wrap; line-height: 1.5; min-height: 3rem; max-height: 20rem; overflow-y: auto;"></div>
          <div style="margin-top: 1rem; text-align: right">
            <button class="btn" type="button" id="notesViewEditBtn">Edit</button>
          </div>
        </div>
      </div>
    </div>

    <!-- =============================================================================
       CHANGE LOG MODAL

       Displays the 10 most recent inventory cell changes tracked by the system.
       Data is populated dynamically from localStorage and rendered as a table.
       ============================================================================= -->
    <div class="modal" id="changeLogModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Change Log</h2>
          <button aria-label="Close modal" class="modal-close" id="changeLogCloseBtn">×</button>
        </div>
        <div class="modal-body">
          <table id="changeLogTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Item</th>
                <th>Field</th>
                <th>Old Value</th>
                <th>New Value</th>
                <th>Undo</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button
            class="btn secondary icon-btn"
            id="changeLogClearBtn"
            title="Clear log"
            aria-label="Clear log"
          >↺</button>
        </div>
      </div>
    </div>
  </div>

    <!-- =============================================================================
       STORAGE REPORT MODAL

       Displays the generated storage report inside an iframe for in-app viewing.
       ============================================================================= -->
    
    
    <!-- =============================================================================
       DETAILS MODAL WITH PIE CHARTS
       
       Advanced analytics modal opened by clicking totals titles.
       Provides in-depth analysis for selected metal including:
       
       VISUAL ANALYTICS:
       - Pie chart breakdown by item type (rounds, bars, coins, etc.)
       - Pie chart breakdown by purchase location
       - Interactive Chart.js visualizations with hover details
       
       DATA BREAKDOWNS:
       - Type details: count, weight, and value by item type
       - Location details: count, weight, and value by purchase location
       - Formatted currency and weight displays
       
       Modal implementation in detailsModal.js with Chart.js integration
       Data preparation and chart rendering handled by charts.js
       ============================================================================= -->
    <div class="modal" id="detailsModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="detailsModalTitle"></h2>
          <button aria-label="Close modal" class="modal-close" id="detailsCloseBtn">×</button>
        </div>
        <div class="modal-body">
          <div class="details-grid">
            <div class="details-panel">
              <h3 class="details-panel-title" id="typePanelTitle">Breakdown by Type</h3>
              <div class="chart-canvas-container">
                <canvas class="chart-canvas" id="typeChart"></canvas>
              </div>
              <div class="details-breakdown" id="typeBreakdown">
                <!-- Content will be populated by JavaScript -->
              </div>
            </div>
            <div class="details-panel">
              <h3 class="details-panel-title" id="locationPanelTitle">Breakdown by Purchase Location</h3>
              <div class="chart-canvas-container">
                <canvas class="chart-canvas" id="locationChart"></canvas>
              </div>
              <div class="details-breakdown" id="locationBreakdown">
                <!-- Content will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <footer class="app-footer">
      <div class="storage-line">Storage: <span id="storageUsage"></span> <div class="storage-bar" id="storageBar"><div class="storage-bar-ls" id="storageBarLs" title="localStorage"></div><div class="storage-bar-idb" id="storageBarIdb" title="IndexedDB Images"></div></div> <a href="#" id="storageReportLink">Storage report</a></div>
      <div class="footer-meta">
        <span>Thank you for using <span id="footerBrand">StakTrakr</span> <a id="versionBadge" class="version-badge" style="display: none"></a>. &copy; 2025-2026 <a id="footerDomain" href="https://staktrakr.com" target="_blank" rel="noopener">staktrakr.com</a>. Special thanks to the <a href="https://www.reddit.com/r/Silverbugs/" target="_blank" rel="noopener">r/Silverbugs</a> community for the feedback, bug reports, and encouragement that shaped this app. &middot; <a href="#" onclick="if(window.showFaqModal){event.preventDefault();window.showFaqModal();}">FAQ</a></span>
        <div class="footer-badges">
          <a href="https://github.com/lbruton/StakTrakr" target="_blank" rel="noopener"><img src="https://img.shields.io/github/license/lbruton/StakTrakr?style=flat-square" alt="MIT License" height="20"></a>
          <a href="https://app.codacy.com/gh/lbruton/StakTrakr/dashboard?utm_source=gh&amp;utm_medium=referral&amp;utm_content=&amp;utm_campaign=Badge_grade" target="_blank" rel="noopener"><img src="https://app.codacy.com/project/badge/Grade/b8d30126676546cb958fa6a7e0174da8" alt="Codacy Badge" height="20"></a>
          <a href="https://github.com/lbruton/StakTrakr/issues" target="_blank" rel="noopener"><img src="https://img.shields.io/github/issues/lbruton/StakTrakr?style=flat-square" alt="GitHub Issues" height="20"></a>
          <a href="https://www.reddit.com/r/staktrakr/" target="_blank" rel="noopener"><img src="https://img.shields.io/reddit/subreddit-subscribers/staktrakr?style=flat-square&amp;label=community" alt="Community" height="20"></a>
          <a href="https://github.com/sponsors/lbruton" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/sponsor-%E2%99%A1-ea4aaa?style=flat-square" alt="Sponsor" height="20"></a>
        </div>
      </div>
    </footer>
    <!-- =============================================================================
       ABOUT & DISCLAIMER MODAL
       Comprehensive application information and disclaimer modal similar to the
       original splash page design with enhanced features and detailed information.
       ============================================================================= -->
    <div class="modal" id="ackModal" style="display: none">
      <div class="modal-content about-modal-content">
        <div class="modal-header about-modal-header">
          <h1 class="about-title">
            <span id="ackAppName">StakTrakr</span> <span id="ackVersion"></span>
          </h1>
          <button aria-label="Close modal" class="modal-close" id="ackCloseBtn">
            ×
          </button>
        </div>
        <div class="modal-body about-modal-body">
          <!-- Application Description -->
          <div class="about-description">
            A free, open-source precious metals portfolio tracker. Monitor live
            spot prices, track purchase cost vs melt value, and compute gain/loss
            across Silver, Gold, Platinum, and Palladium. All data stays in your
            browser — nothing is ever sent to a server.
          </div>

          <!-- Important Notice -->
          <div class="about-alert">
            <div class="alert-header">
              <span class="alert-icon">⚠️</span>
              <strong>Important Privacy & Data Notice</strong>
            </div>
            <div class="alert-content">
              <p>
                <strong>Your Privacy is Protected:</strong> All data is stored
                locally in your browser using localStorage and
                <em>never transmitted to any server</em>. Your precious metals
                inventory information remains completely private and under your
                control.
              </p>

              <p>
                <strong>Data Backup Responsibility:</strong> Since data is
                stored locally, it will be lost if you clear browser history,
                reset browser data, or use private browsing mode. Remember to
                export your data regularly to keep a copy.
              </p>

              <p>
                <strong>Use at Your Own Risk:</strong> This tool is provided for
                informational and organizational purposes only. The developer
                assumes no responsibility for any financial decisions,
                investment choices, or data loss. Always verify spot prices and
                calculations independently.
              </p>

              <p>
                <strong>Spot Price Accuracy:</strong> Prices displayed are for
                reference only and may not reflect real-time market conditions.
                Always confirm current pricing with your dealer or official
                market sources before making transactions.
              </p>
            </div>
          </div>
          <div class="alert-actions">
            <button class="btn btn-primary about-accept-btn" id="ackAcceptBtn">
              ✅ I Understand - Continue to Application
            </button>
          </div>
          <div class="acceptance-text">
            By continuing, you acknowledge that you understand this tool stores
            data locally, you are responsible for backing up your data, and you
            use this application at your own risk.
          </div>
        </div>
      </div>
    </div>
    <div class="modal" id="aboutModal" style="display: none">
      <div class="modal-content about-modal-content">
        <div class="modal-header about-modal-header">
          <button
            aria-label="Close modal"
            class="modal-close"
            id="aboutCloseBtn"
          >
            ×
          </button>
        </div>
        <div class="modal-body about-modal-body">
          <h2 class="about-title" id="aboutTitle">
            <span id="aboutAppName">StakTrakr</span>
            <span id="aboutVersion"></span>
          </h2>
          <div class="about-description">
            A free, open-source precious metals portfolio tracker. Monitor live
            spot prices, track purchase cost vs melt value, and compute gain/loss
            across Silver, Gold, Platinum, and Palladium. All data stays in your
            browser — nothing is ever sent to a server. Export to CSV, JSON, PDF,
            or HTML backup at any time.
            <div class="about-badges">
              <a id="aboutSiteLink" href="https://www.staktrakr.com" target="_blank" rel="noopener" class="about-badge">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                <span id="aboutSiteDomain">staktrakr.com</span>
              </a>
              <a href="https://github.com/lbruton/StakTrakr" target="_blank" rel="noopener" class="about-badge">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/></svg>
                Source
              </a>
              <a href="https://www.reddit.com/r/staktrakr/" target="_blank" rel="noopener" class="about-badge">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/></svg>
                Community
              </a>
              <a href="https://github.com/lbruton/StakTrakr/blob/main/LICENSE" target="_blank" rel="noopener noreferrer" class="about-badge">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                MIT License
              </a>
              <a href="docs/api/index.html" target="_blank" rel="noopener" class="about-badge">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                API Docs
              </a>
              <a href="https://github.com/sponsors/lbruton" target="_blank" rel="noopener" class="about-badge">
                <svg viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                Sponsor
              </a>
              <button class="about-badge" onclick="if(window.showFaqModal)window.showFaqModal()">
                ❓ FAQ
              </button>
              <button class="about-badge" onclick="if(window.openModalById)openModalById('privacyModal')">
                🔒 Privacy
              </button>
            </div>
          </div>

          <div class="about-alert about-alert-compact">
            <span class="alert-icon">⚠️</span>
            All data is stored locally in your browser and never sent to a server.
            Export regularly to keep a backup. See <button class="about-alert-link" onclick="if(window.showFaqModal)window.showFaqModal()">FAQ</button> for full details.
          </div>
          <!-- What's New and Roadmap -->
          <div class="about-info-grid">
            <div class="about-section">
              <div class="section-title">🚀 What's New in <span id="aboutCurrentVersion"></span></div>
              <ul id="aboutChangelogLatest" class="changelog-list"></ul>
              <div class="about-section-footer">
                <button class="about-card-link" id="aboutShowChangelogBtn">View Full Changelog →</button>
              </div>
            </div>

            <div class="about-section" id="aboutRoadmapSection">
              <div class="section-title">🗺️ Development Roadmap</div>
              <ul id="aboutRoadmapList" class="changelog-list"></ul>
              <div class="about-section-footer">
                <a class="about-card-link" href="https://github.com/lbruton/StakTrakr/blob/main/docs/announcements.md" target="_blank" rel="noopener">View Full Roadmap →</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal" id="versionModal" style="display: none">
      <div class="modal-content about-modal-content">
        <div class="modal-header about-modal-header">
          <h1 class="about-title">What's New <span id="versionModalVersion"></span></h1>
          <button aria-label="Close modal" class="modal-close" id="versionCloseBtn">×</button>
        </div>
        <div class="modal-body about-modal-body">
          <div class="about-info-grid">
            <div class="about-section">
              <div class="section-title">🚀 What's New</div>
              <ul id="versionChanges" class="changelog-list"></ul>
              <div class="about-section-footer">
                <button class="about-card-link" id="versionShowChangelogBtn">View Full Changelog →</button>
              </div>
            </div>

            <div class="about-section">
              <div class="section-title">🗺️ Development Roadmap</div>
              <ul id="versionRoadmapList" class="changelog-list"></ul>
              <div class="about-section-footer">
                <a class="about-card-link" href="https://github.com/lbruton/StakTrakr/blob/main/docs/announcements.md" target="_blank" rel="noopener">View Full Roadmap →</a>
              </div>
            </div>
          </div>

          <div class="alert-actions">
            <button class="btn btn-primary" id="versionAcceptBtn">Accept and continue</button>
          </div>
        </div>
      </div>
    </div>
    <!-- =============================================================================
       ============================================================================= -->

    <!-- =============================================================================
       UNIFIED SETTINGS MODAL
       Consolidates API, Files, and Appearance into a single sidebar-navigated modal.
       Sub-modals (apiInfoModal, apiHistoryModal, catalogHistoryModal, apiQuotaModal,
       goldbackHistoryModal) remain as stacking overlays.
       ============================================================================= -->
    <div class="modal" id="settingsModal" style="display: none">
      <div class="modal-content settings-modal-content">
        <div class="modal-header">
          <h2>Settings</h2>
          <button aria-label="Close modal" class="modal-close" id="settingsCloseBtn">&times;</button>
        </div>
        <div class="settings-modal-layout">
          <!-- Sidebar Navigation -->
          <nav class="settings-sidebar">
            <button class="settings-nav-item active" data-section="site">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r="2.5"/><circle cx="19" cy="13" r="2.5"/><circle cx="16" cy="20" r="2.5"/><circle cx="7" cy="20" r="2.5"/><circle cx="4" cy="13" r="2.5"/><circle cx="12" cy="13" r="3"/></svg>
              Appearance
            </button>
            <button class="settings-nav-item" data-section="system">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
              Inventory
            </button>
            <button class="settings-nav-item" data-section="search">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Search
            </button>
            <button class="settings-nav-item" data-section="grouping">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
              Filters
            </button>
            <button class="settings-nav-item" data-section="images">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
              Images
            </button>
            <button class="settings-nav-item" data-section="currency">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
              Currency
            </button>
            <button class="settings-nav-item" data-section="goldback">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v12"/><path d="M9 9a3 3 0 0 1 3-1.5c2 0 3 1 3 2.5s-1 2.5-3 2.5-3 1-3 2.5a3 3 0 0 0 3 2.5"/></svg>
              Goldback
            </button>
            <button class="settings-nav-item" data-section="market">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M0 0h1v15h15v1H0V0Zm14.817 3.113a.5.5 0 0 1 .07.704l-4.5 5.5a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .76-.063l2.573 2.565 4.15-5.073a.5.5 0 0 1 .704-.07z"/>
              </svg>
              Market
            </button>
            <button class="settings-nav-item" data-section="storage">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14c0 1.66 4.03 3 9 3s9-1.34 9-3V5"/><path d="M3 12c0 1.66 4.03 3 9 3s9-1.34 9-3"/></svg>
              Storage
            </button>
            <button class="settings-nav-item" data-section="api">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></svg>
              API
            </button>
            <button class="settings-nav-item" data-section="cloud">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>
              Cloud
            </button>
            <button class="settings-nav-item" data-section="faq">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
              FAQ
            </button>
            <button class="settings-nav-item" data-section="changelog">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>
              Log
            </button>
          </nav>

          <!-- Content Area -->
          <div class="settings-content-area">

            <!-- ===== APPEARANCE SETTINGS ===== -->
            <div class="settings-section-panel" id="settingsPanel_site" style="display: block">
              <h3>Appearance</h3>

              <!-- ── Theme + Timezone side-by-side ── -->
              <div class="settings-fieldset">
                <div class="settings-card-grid">
                  <div class="settings-card">
                    <div class="settings-fieldset-title">Theme</div>
                    <div class="settings-group">
                      <div class="settings-group-label">Color scheme</div>
                      <div class="theme-picker">
                        <button class="theme-option" data-theme="light" title="Light">&#9728;&#65039; Light</button>
                        <button class="theme-option" data-theme="dark" title="Dark">&#127769; Dark</button>
                        <button class="theme-option" data-theme="sepia" title="Sepia">&#128220; Sepia</button>
                      </div>
                    </div>
                  </div>
                  <div class="settings-card">
                    <div class="settings-fieldset-title">Display Timezone</div>
                    <div class="settings-group">
                      <div class="settings-group-label">Timezone</div>
                      <p class="settings-subtext">Choose which timezone to use when displaying timestamps. Stored data is always UTC.</p>
                      <select id="settingsTimezone" class="form-control">
                        <option value="auto">Auto (browser default)</option>
                        <option value="UTC">UTC</option>
                        <optgroup label="Americas">
                          <option value="America/New_York">Eastern (New York)</option>
                          <option value="America/Chicago">Central (Chicago)</option>
                          <option value="America/Denver">Mountain (Denver)</option>
                          <option value="America/Los_Angeles">Pacific (Los Angeles)</option>
                          <option value="America/Anchorage">Alaska</option>
                          <option value="Pacific/Honolulu">Hawaii</option>
                        </optgroup>
                        <optgroup label="Europe">
                          <option value="Europe/London">London (GMT/BST)</option>
                          <option value="Europe/Paris">Paris / CET</option>
                          <option value="Europe/Moscow">Moscow</option>
                        </optgroup>
                        <optgroup label="Asia / Pacific">
                          <option value="Asia/Tokyo">Tokyo (JST)</option>
                          <option value="Asia/Shanghai">Shanghai (CST)</option>
                          <option value="Asia/Kolkata">Kolkata (IST)</option>
                          <option value="Australia/Sydney">Sydney (AEST)</option>
                        </optgroup>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Currency, Image Display, and Card View sections moved to their own tabs -->

              <!-- ── Header Buttons ── -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">Header Buttons</div>
                <p class="settings-subtext">Optional buttons shown in the top-right of the app header.</p>
                <div class="settings-card-grid settings-card-grid--compact">
                  <div class="settings-card">
                    <div class="settings-group-label">Theme</div>
                    <p class="settings-subtext">Cycle color theme.</p>
                    <div class="chip-sort-toggle" id="settingsHeaderThemeBtn_hdr">
                      <button type="button" class="chip-sort-btn" data-val="yes">On</button>
                      <button type="button" class="chip-sort-btn" data-val="no">Off</button>
                    </div>
                  </div>
                  <div class="settings-card">
                    <div class="settings-group-label">Currency</div>
                    <p class="settings-subtext">Switch display currency.</p>
                    <div class="chip-sort-toggle" id="settingsHeaderCurrencyBtn_hdr">
                      <button type="button" class="chip-sort-btn" data-val="yes">On</button>
                      <button type="button" class="chip-sort-btn" data-val="no">Off</button>
                    </div>
                  </div>
                  <div class="settings-card">
                    <div class="settings-group-label">Trend</div>
                    <p class="settings-subtext">Cycle sparkline period.</p>
                    <div class="chip-sort-toggle" id="settingsHeaderTrendBtn_hdr">
                      <button type="button" class="chip-sort-btn" data-val="yes">On</button>
                      <button type="button" class="chip-sort-btn" data-val="no">Off</button>
                    </div>
                  </div>
                  <div class="settings-card">
                    <div class="settings-group-label">Sync</div>
                    <p class="settings-subtext">Sync all spot prices.</p>
                    <div class="chip-sort-toggle" id="settingsHeaderSyncBtn_hdr">
                      <button type="button" class="chip-sort-btn" data-val="yes">On</button>
                      <button type="button" class="chip-sort-btn" data-val="no">Off</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ── Layout ── -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">Layout</div>
                <div class="settings-group">
                  <div class="settings-group-label">Visible sections</div>
                  <p class="settings-subtext">Toggle visibility and reorder major page sections.</p>
                  <div class="chip-grouping-table-container" id="layoutSectionConfigContainer">
                    <div class="chip-grouping-empty">Loading...</div>
                  </div>
                </div>
                <div class="settings-group">
                  <div class="settings-group-label">Item detail modal</div>
                  <p class="settings-subtext">Reorder and toggle sections in the item view modal.</p>
                  <div class="chip-grouping-table-container" id="viewModalSectionConfigContainer">
                    <div class="chip-grouping-empty">Loading...</div>
                  </div>
                </div>
              </div>

              <!-- ── Inventory View ── -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">Inventory View</div>
                <div class="settings-card-grid settings-card-grid--compact settings-card-grid--3col">
                  <div class="settings-card">
                    <div class="settings-group-label">Card View</div>
                    <p class="settings-subtext">Select layout style.</p>
                    <div class="chip-sort-toggle" id="settingsCardStyleToggle">
                      <button type="button" class="chip-sort-btn active" data-style="A" title="Sparkline cards">A</button>
                      <button type="button" class="chip-sort-btn" data-style="B" title="Hero cards">B</button>
                      <button type="button" class="chip-sort-btn" data-style="C" title="Split cards">C</button>
                      <button type="button" class="chip-sort-btn" data-style="D" title="Table view">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                          <rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="9" x2="9" y2="21"/><line x1="15" y1="9" x2="15" y2="21"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="settings-card">
                    <div class="settings-group-label">Default Sort</div>
                    <p class="settings-subtext">Sort field and direction on load.</p>
                    <select id="settingsDefaultSortColumn" style="margin-bottom:0.4rem">
                      <option value="0">Date</option>
                      <option value="1">Metal</option>
                      <option value="2">Type</option>
                      <option value="4" selected>Name</option>
                      <option value="5">Qty</option>
                      <option value="6">Weight</option>
                      <option value="7">Purchase</option>
                      <option value="8">Melt Value</option>
                      <option value="9">Retail</option>
                      <option value="10">Gain/Loss</option>
                      <option value="11">Source</option>
                    </select>
                    <div class="chip-sort-toggle" id="settingsDefaultSortDir">
                      <button type="button" class="chip-sort-btn active" data-val="asc">↑ Asc</button>
                      <button type="button" class="chip-sort-btn" data-val="desc">↓ Desc</button>
                    </div>
                  </div>
                  <div class="settings-card">
                    <div class="settings-group-label">Visible Items</div>
                    <p class="settings-subtext">Max items shown before scrolling (cards + table).</p>
                    <select id="settingsItemsPerPage">
                      <option value="3">3</option>
                      <option value="6">6</option>
                      <option value="12">12</option>
                      <option value="24">24</option>
                      <option value="48">48</option>
                      <option value="96">96</option>
                      <option value="128">128</option>
                      <option value="512">512</option>
                      <option value="all">All</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- ── Custom Themes (placeholder) ── -->
              <div class="settings-fieldset" style="text-align:center; opacity:0.6;">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.3"><circle cx="13.5" cy="6.5" r="2.5"/><circle cx="19" cy="13" r="2.5"/><circle cx="16" cy="20" r="2.5"/><circle cx="7" cy="20" r="2.5"/><circle cx="4" cy="13" r="2.5"/><circle cx="12" cy="13" r="3"/></svg>
                <p style="margin-top:0.5rem; font-size:0.85rem;">Custom themes coming soon &mdash; build your own color scheme.</p>
              </div>

            </div>

            <!-- ===== TABLE SETTINGS ===== -->
            <!-- ===== CHIPS ===== -->
            <div class="settings-section-panel" id="settingsPanel_grouping" style="display: none">
              <h3>Filter Chips</h3>

              <!-- ── Metals & Inline Chips ── -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">Metals &amp; Inline Chips</div>
                <div class="settings-card-grid">
                  <div class="settings-card">
                    <div class="settings-group-label">Metal Order</div>
                    <p class="settings-subtext">Reorder and show/hide spot price and summary cards. Drag rows to reorder.</p>
                    <div class="chip-grouping-table-container" id="metalOrderConfigContainer">
                      <div class="chip-grouping-empty">Loading...</div>
                    </div>
                  </div>
                  <div class="settings-card">
                    <div class="settings-group-label">Inline Name Chips</div>
                    <p class="settings-subtext">Choose which badges appear next to item names in the table.</p>
                    <div class="chip-grouping-table-container" id="inlineChipConfigContainer">
                      <div class="chip-grouping-empty">Loading...</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="settings-group">
                <div class="settings-group-label">Filter chip threshold</div>
                <p class="settings-subtext">Minimum item count for a filter chip to appear.</p>
                <select id="settingsChipMinCount">
                  <option value="2">2+</option>
                  <option value="3">3+</option>
                  <option value="5">5+</option>
                  <option value="10">10+</option>
                  <option value="100">100+ (off)</option>
                </select>
              </div>

              <div class="settings-group">
                <div class="settings-group-label">Smart name grouping</div>
                <p class="settings-subtext">Group item names by base name (e.g., "American Silver Eagle (3)").</p>
                <div class="chip-sort-toggle" id="settingsGroupNameChips">
                  <button type="button" class="chip-sort-btn active" data-val="yes">On</button>
                  <button type="button" class="chip-sort-btn" data-val="no">Off</button>
                </div>
              </div>

              <div class="settings-group">
                <div class="settings-group-label">Dynamic name chips</div>
                <p class="settings-subtext">Auto-extract text from parentheses and quotes in item names as additional filter chips.</p>
                <div class="chip-sort-toggle" id="settingsDynamicChips">
                  <button type="button" class="chip-sort-btn active" data-val="yes">On</button>
                  <button type="button" class="chip-sort-btn" data-val="no">Off</button>
                </div>
              </div>

              <div class="settings-group">
                <div class="settings-group-label">Filter chip categories</div>
                <p class="settings-subtext">Enable, disable, and reorder chip categories. Assign the same Group letter to merge categories so their chips sort together.</p>
                <div class="chip-grouping-table-container" id="filterChipCategoryContainer">
                  <div class="chip-grouping-empty">Loading…</div>
                </div>
              </div>

              <div class="settings-group">
                <div class="settings-group-label">Chip quantity badge</div>
                <p class="settings-subtext">Show item count on each filter chip (e.g., "Gold (13)").</p>
                <div class="chip-sort-toggle" id="settingsChipQtyBadge">
                  <button type="button" class="chip-sort-btn active" data-val="yes">On</button>
                  <button type="button" class="chip-sort-btn" data-val="no">Off</button>
                </div>
              </div>

              <div class="settings-group">
                <div class="settings-group-label">Chip sort order</div>
                <p class="settings-subtext">Sort chips within each category by name or quantity.</p>
                <div class="chip-sort-toggle" id="settingsChipSortOrder">
                  <button type="button" class="chip-sort-btn active" data-sort="alpha">A-Z</button>
                  <button type="button" class="chip-sort-btn" data-sort="count">Qty</button>
                </div>
              </div>

              <div class="settings-group">
                <div class="settings-group-label">Chip blacklist</div>
                <p class="settings-subtext">Suppressed auto-generated chips. Right-click any name chip to add it here.</p>
                <div class="chip-grouping-controls">
                  <select id="blacklistInput" class="chip-grouping-input">
                    <option value="">Select a chip to suppress…</option>
                  </select>
                  <button type="button" class="btn" id="addBlacklistBtn">Add</button>
                </div>
                <div class="chip-grouping-table-container" id="blacklistTableContainer">
                  <div class="chip-grouping-empty">No blacklisted chips</div>
                </div>
              </div>

              <div class="settings-group">
                <div class="settings-group-label">Custom grouping rules</div>
                <p class="settings-subtext">Define chip labels with comma or semicolon-separated name patterns.</p>
                <div class="chip-grouping-controls">
                  <input type="text" id="customGroupLabelInput" class="chip-grouping-input" placeholder="Chip label">
                  <input type="text" id="customGroupPatternsInput" class="chip-grouping-input-wide" placeholder="Patterns (comma-separated)">
                  <button type="button" class="btn" id="addCustomGroupBtn">Add Rule</button>
                </div>
                <div class="chip-grouping-table-container" id="customGroupTableContainer">
                  <div class="chip-grouping-empty">No custom grouping rules</div>
                </div>
              </div>
            </div>

            <!-- ===== SEARCH ===== -->
            <div class="settings-section-panel" id="settingsPanel_search" style="display: none">
              <h3>Search</h3>

              <div class="settings-group">
                <div class="settings-group-label">Fuzzy autocomplete</div>
                <p class="settings-subtext">Show smart suggestions when typing in the Name, Purchase Location, and Storage Location fields.</p>
                <div class="chip-sort-toggle" id="settingsFuzzyAutocomplete">
                  <button type="button" class="chip-sort-btn active" data-val="yes">On</button>
                  <button type="button" class="chip-sort-btn" data-val="no">Off</button>
                </div>
              </div>

              <div class="settings-group">
                <div class="settings-group-label">Numista name matching</div>
                <p class="settings-subtext">Rewrite common coin names (e.g. "ASE") into Numista-optimized search queries with direct lookups for known catalog IDs.</p>
                <div class="chip-sort-toggle" id="settingsNumistaLookup">
                  <button type="button" class="chip-sort-btn active" data-val="yes">On</button>
                  <button type="button" class="chip-sort-btn" data-val="no">Off</button>
                </div>
              </div>

              <div class="settings-group">
                <div class="settings-group-label">Built-in patterns <span id="seedRuleCount" style="font-size:0.8em;opacity:0.6;margin-left:0.3em;"></span></div>
                <p class="settings-subtext">Pre-configured lookup rules shipped with StakTrakr. Toggle individual rules on or off.</p>
                <div class="chip-grouping-table-container" id="seedRuleTableContainer" style="max-height:220px;overflow-y:auto;">
                  <div class="chip-grouping-empty">Loading…</div>
                </div>
              </div>

              <div class="settings-group">
                <div class="settings-group-label">Custom patterns</div>
                <p class="settings-subtext">Add your own regex patterns to rewrite Numista search queries. Custom rules override built-in patterns.</p>
                <div class="chip-grouping-controls">
                  <input type="text" id="numistaRulePatternInput" class="chip-grouping-input" placeholder="Regex pattern">
                  <input type="text" id="numistaRuleReplacementInput" class="chip-grouping-input-wide" placeholder="Numista query">
                  <input type="text" id="numistaRuleIdInput" class="chip-grouping-input" placeholder="N# (optional)" style="width:90px;">
                  <button type="button" class="btn" id="addNumistaRuleBtn">Add</button>
                </div>
                <div class="chip-grouping-table-container" id="customRuleTableContainer">
                  <div class="chip-grouping-empty">No custom patterns</div>
                </div>
              </div>
            </div>

            <!-- ===== API ===== -->
            <div class="settings-section-panel" id="settingsPanel_api" style="display: none">
              <h3>API Configuration</h3>

              <div class="settings-actions">
                <button type="button" class="btn success" id="syncAllBtn">Sync Metals</button>
                <button type="button" class="btn danger" id="flushCacheBtn">Flush Metals Cache</button>
                <button type="button" class="btn" id="apiHistoryBtn">Metals History</button>
                <button type="button" class="btn" id="catalogHistoryBtn">Catalog History</button>
              </div>

              <div class="api-header-status-row" id="apiHeaderStatusRow"></div>

              <!-- Provider Tabs — Numista pinned, metals draggable -->
              <div class="settings-provider-tabs">
                <button class="settings-provider-tab pinned active" data-provider="NUMISTA">Numista</button>
                <button class="settings-provider-tab pinned" data-provider="PCGS">PCGS</button>
                <button class="settings-provider-tab" data-provider="STAKTRAKR">StakTrakr</button>
                <button class="settings-provider-tab" data-provider="METALS_DEV">Metals.dev</button>
                <button class="settings-provider-tab" data-provider="METALS_API">Metals-API</button>
                <button class="settings-provider-tab" data-provider="METAL_PRICE_API">MetalPriceAPI</button>
                <button class="settings-provider-tab" data-provider="CUSTOM">Custom Spot API</button>
              </div>

              <!-- Numista Provider Panel -->
              <div class="settings-provider-panel" id="providerPanel_NUMISTA" style="display: block">
                <div class="api-provider" data-provider="NUMISTA">
                  <div class="provider-header">
                    <span class="provider-name">Numista Catalog API</span>
                  </div>
                  <div class="api-key-row">
                    <label for="numistaApiKey">API Key:</label>
                    <input type="password" id="numistaApiKey" placeholder="Enter your Numista API key" />
                  </div>
                  <div class="api-key-note">
                    <p>Get a free API key at <a href="https://en.numista.com/api/" target="_blank" rel="noopener">numista.com/api</a> (2,000 requests/month free tier). Your key is stored locally in your browser.</p>
                  </div>
                  <div id="numistaUsageBar" class="api-usage" style="margin-top: 0.75rem;"></div>
                  <div class="provider-info">
                    <div class="provider-status" id="numistaProviderStatus"><span class="status-dot"></span><span class="status-text">Disconnected</span></div>
                  </div>
                  <div class="provider-footer">
                    <div class="provider-actions">
                      <button class="btn api-save-btn success" id="saveNumistaBtn" data-provider="NUMISTA">Save Key</button>
                      <button class="btn api-sync-btn info" id="testNumistaBtn" data-provider="NUMISTA">Test Connection</button>
                      <button class="btn api-clear-btn warning" id="clearNumistaBtn" data-provider="NUMISTA">Clear Key</button>
                    </div>
                  </div>
                  <div id="numistaStatus" class="api-status" style="margin-top: 0.5rem;"></div>

                  <!-- View Modal Field Toggles -->
                  <div class="settings-group" style="margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 0.75rem;">
                    <div class="settings-group-label">View modal fields</div>
                    <p class="settings-subtext">Choose which Numista data fields appear in the item view modal.</p>
                    <div id="numistaViewFieldToggles" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px 1rem;">
                      <label class="settings-checkbox-label"><input type="checkbox" data-nf="denomination" checked> Denomination</label>
                      <label class="settings-checkbox-label"><input type="checkbox" data-nf="shape" checked> Shape</label>
                      <label class="settings-checkbox-label"><input type="checkbox" data-nf="diameter" checked> Diameter</label>
                      <label class="settings-checkbox-label"><input type="checkbox" data-nf="thickness" checked> Thickness</label>
                      <label class="settings-checkbox-label"><input type="checkbox" data-nf="orientation" checked> Orientation</label>
                      <label class="settings-checkbox-label"><input type="checkbox" data-nf="composition" checked> Composition</label>
                      <label class="settings-checkbox-label"><input type="checkbox" data-nf="country" checked> Country</label>
                      <label class="settings-checkbox-label"><input type="checkbox" data-nf="technique" checked> Technique</label>
                      <label class="settings-checkbox-label"><input type="checkbox" data-nf="references" checked> References (KM#)</label>
                      <label class="settings-checkbox-label"><input type="checkbox" data-nf="edge" checked> Edge</label>
                      <label class="settings-checkbox-label"><input type="checkbox" data-nf="tags" checked> Tags</label>
                      <label class="settings-checkbox-label"><input type="checkbox" data-nf="commemorative" checked> Commemorative</label>
                      <label class="settings-checkbox-label"><input type="checkbox" data-nf="rarity" checked> Rarity</label>
                      <label class="settings-checkbox-label"><input type="checkbox" data-nf="mintage" checked> Mintage</label>
                      <label class="settings-checkbox-label"><input type="checkbox" data-nf="imageTooltips" checked> Image tooltips</label>
                    </div>
                  </div>

                  <!-- Numista Bulk Sync (STACK-87/88) -->
                  <div class="settings-group" id="numistaBulkSyncGroup" style="margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 0.75rem; display: none;">
                    <div class="settings-group-label">Metadata Sync</div>
                    <p class="settings-subtext">
                      Sync metadata for all inventory items with Numista catalog IDs.
                      Images are loaded on-demand when viewing items. Uses your API key (counts toward monthly quota).
                    </p>

                    <!-- Stats bar -->
                    <div id="numistaSyncStats" class="settings-subtext" style="margin-bottom:0.5rem;"></div>

                    <!-- Eligible items table (collapsible) -->
                    <details style="margin-bottom:0.5rem;">
                      <summary style="font-size:0.8rem;cursor:pointer;opacity:0.7;">Show eligible items</summary>
                      <div id="numistaSyncTableContainer" class="chip-grouping-table-container" style="max-height:180px;overflow-y:auto;margin-top:0.35rem;"></div>
                    </details>

                    <!-- Activity log (collapsible) -->
                    <details style="margin-bottom:0.5rem;">
                      <summary style="font-size:0.8rem;cursor:pointer;opacity:0.7;">Activity log</summary>
                      <div id="numistaSyncLog" style="max-height:120px;overflow-y:auto;border:1px solid var(--border-color, #ddd);border-radius:4px;padding:0.4rem;margin-top:0.25rem;background:var(--bg-secondary, #f9f9f9);"></div>
                    </details>

                    <!-- Progress -->
                    <progress id="numistaSyncProgress" value="0" max="0" style="display:none;width:100%;margin-bottom:0.5rem;"></progress>

                    <!-- Action buttons -->
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                      <button type="button" class="btn info" id="numistaSyncStartBtn">Sync Metadata</button>
                      <button type="button" class="btn warning" id="numistaSyncCancelBtn" style="display:none;">Cancel</button>
                      <button type="button" class="btn danger" id="numistaSyncClearBtn" style="font-size:0.8rem;">Clear Cache</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- PCGS Provider Panel -->
              <div class="settings-provider-panel" id="providerPanel_PCGS" style="display: none">
                <div class="api-provider" data-provider="PCGS">
                  <div class="provider-header">
                    <span class="provider-name">PCGS Cert Verification API</span>
                  </div>
                  <div class="api-key-row">
                    <label for="pcgsBearerToken">Bearer Token:</label>
                    <input type="password" id="pcgsBearerToken" placeholder="Enter your PCGS API bearer token" />
                  </div>
                  <div class="api-key-note">
                    <p>Requires a PCGS API account at <a href="https://api.pcgs.com" target="_blank" rel="noopener">api.pcgs.com</a> (1,000 requests/day). Token is stored locally in your browser.</p>
                    <p style="margin-top:0.35rem;opacity:0.7;font-size:0.8rem;">HTTPS required — cert verification will not work on <code>file://</code> protocol.</p>
                  </div>
                  <div id="pcgsUsageBar" class="api-usage" style="margin-top: 0.75rem;"></div>
                  <div class="provider-info">
                    <div class="provider-status" id="pcgsProviderStatus"><span class="status-dot"></span><span class="status-text">Disconnected</span></div>
                  </div>
                  <div class="provider-footer">
                    <div class="provider-actions">
                      <button class="btn api-save-btn success" id="savePcgsBtn" data-provider="PCGS">Save Token</button>
                      <button class="btn api-sync-btn info" id="testPcgsBtn" data-provider="PCGS">Test Connection</button>
                      <button class="btn api-clear-btn warning" id="clearPcgsBtn" data-provider="PCGS">Clear Token</button>
                    </div>
                  </div>
                  <div id="pcgsStatus" class="api-status" style="margin-top: 0.5rem;"></div>
                </div>
              </div>

              <!-- StakTrakr Provider Panel -->
              <div class="settings-provider-panel" id="providerPanel_STAKTRAKR" style="display: none">
                <div class="api-provider" data-provider="STAKTRAKR">
                  <div class="provider-header">
                    <span class="provider-name">StakTrakr Spot API</span>
                    <span class="provider-badge free">Free</span>
                    <a href="https://www.staktrakr.com" target="_blank" rel="noopener noreferrer" class="provider-doc-link" title="StakTrakr Website">Docs</a>
                  </div>
                  <p class="provider-description" style="margin: 0.5rem 0; color: var(--text-muted);">Free hourly spot prices — no API key required.</p>
                  <p class="provider-disclaimer" style="margin: 0.25rem 0 0.5rem; font-size: 0.75rem; color: var(--disclaimer-color);">This is a free, best-effort service. Prices may be delayed or temporarily unavailable. No guarantee of accuracy, uptime, or availability is provided.</p>
                  <div class="provider-settings">
                    <h4>Provider Settings</h4>
                    <div class="provider-setting-row">
                      <label for="cacheTimeout_STAKTRAKR">Cache Timeout:</label>
                      <select id="cacheTimeout_STAKTRAKR" class="provider-cache-select">
                        <option value="0">No Cache</option>
                        <option value="0.25">15 minutes</option>
                        <option value="0.5">30 minutes</option>
                        <option value="1" selected>1 hour</option>
                        <option value="6">6 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24">24 hours</option>
                      </select>
                    </div>
                    <div class="provider-setting-row">
                      <label for="providerPriority_STAKTRAKR">Sync Priority:</label>
                      <select class="provider-priority-select" id="providerPriority_STAKTRAKR" data-provider="STAKTRAKR">
                        <option value="1">1st</option>
                        <option value="2">2nd</option>
                        <option value="3">3rd</option>
                        <option value="4">4th</option>
                        <option value="5">5th</option>
                        <option value="0">Disabled</option>
                      </select>
                    </div>
                    <div class="metal-selection">
                      <label>Select Metals to Track:</label>
                      <div class="metal-checkboxes">
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="STAKTRAKR" data-metal="silver" checked><span class="metal-name">Silver (AG)</span></label>
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="STAKTRAKR" data-metal="gold" checked><span class="metal-name">Gold (AU)</span></label>
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="STAKTRAKR" data-metal="platinum" checked><span class="metal-name">Platinum (PT)</span></label>
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="STAKTRAKR" data-metal="palladium" checked><span class="metal-name">Palladium (PD)</span></label>
                      </div>
                    </div>
                    <div class="provider-history-pull">
                      <label for="historyPullDays_STAKTRAKR">Pull Hourly History:</label>
                      <select id="historyPullDays_STAKTRAKR" class="provider-history-select">
                        <option value="1">1 day</option>
                        <option value="3">3 days</option>
                        <option value="7" selected>7 days</option>
                        <option value="14">14 days</option>
                        <option value="30">30 days</option>
                      </select>
                      <button type="button" class="btn api-history-btn" data-provider="STAKTRAKR">Pull History</button>
                      <span class="history-pull-cost" id="historyPullCost_STAKTRAKR"></span>
                    </div>
                    <div class="provider-info">
                      <div class="provider-status"><span class="status-dot"></span><span class="status-text">Disconnected</span><span class="status-last-used"></span></div>
                      <div class="provider-history"></div>
                    </div>
                  </div>
                  <div class="provider-footer">
                    <div class="provider-actions">
                      <button type="button" class="btn api-sync-btn success" data-provider="STAKTRAKR">Test &amp; Sync</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Metals.dev Provider Panel -->
              <div class="settings-provider-panel" id="providerPanel_METALS_DEV" style="display: none">
                <div class="api-provider" data-provider="METALS_DEV">
                  <div class="provider-header">
                    <span class="provider-name">Metals.dev</span>
                    <a href="https://metals.dev/documentation" target="_blank" rel="noopener noreferrer" class="provider-doc-link" title="API Documentation">Docs</a>
                  </div>
                  <div class="api-key-row">
                    <label for="apiKey_METALS_DEV">API Key:</label>
                    <input type="password" id="apiKey_METALS_DEV" placeholder="Enter your API key" />
                  </div>
                  <div class="provider-settings">
                    <h4>Provider Settings</h4>
                    <div class="provider-setting-row">
                      <label for="cacheTimeout_METALS_DEV">Cache Timeout:</label>
                      <select id="cacheTimeout_METALS_DEV" class="provider-cache-select">
                        <option value="0">No Cache</option>
                        <option value="0.25">15 minutes</option>
                        <option value="0.5">30 minutes</option>
                        <option value="1">1 hour</option>
                        <option value="6">6 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24" selected>24 hours</option>
                      </select>
                    </div>
                    <div class="provider-setting-row">
                      <label for="providerPriority_METALS_DEV">Sync Priority:</label>
                      <select class="provider-priority-select" id="providerPriority_METALS_DEV" data-provider="METALS_DEV">
                        <option value="1">1st</option>
                        <option value="2">2nd</option>
                        <option value="3">3rd</option>
                        <option value="4">4th</option>
                        <option value="5">5th</option>
                        <option value="0">Disabled</option>
                      </select>
                    </div>
                    <div class="provider-history-pull">
                      <label for="historyPullDays_METALS_DEV">Pull History:</label>
                      <select id="historyPullDays_METALS_DEV" class="provider-history-select">
                        <option value="7">7 days</option>
                        <option value="14">14 days</option>
                        <option value="30" selected>30 days</option>
                      </select>
                      <button type="button" class="btn api-history-btn" data-provider="METALS_DEV">Pull History</button>
                      <span class="history-pull-cost" id="historyPullCost_METALS_DEV"></span>
                    </div>
                    <div class="metal-selection">
                      <label>Select Metals to Track:</label>
                      <div class="metal-checkboxes">
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="METALS_DEV" data-metal="silver" checked><span class="metal-name">Silver (AG)</span></label>
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="METALS_DEV" data-metal="gold" checked><span class="metal-name">Gold (AU)</span></label>
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="METALS_DEV" data-metal="platinum" checked><span class="metal-name">Platinum (PT)</span></label>
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="METALS_DEV" data-metal="palladium" checked><span class="metal-name">Palladium (PD)</span></label>
                      </div>
                    </div>
                    <div class="provider-info">
                      <div class="api-key-note">Your API key is stored locally and never shared.</div>
                      <div class="provider-status"><span class="status-dot"></span><span class="status-text">Disconnected</span><span class="status-last-used"></span></div>
                      <div class="provider-history"></div>
                    </div>
                  </div>
                  <div class="provider-footer">
                    <div class="provider-actions">
                      <button type="button" class="btn api-save-btn" data-provider="METALS_DEV">Save</button>
                      <button type="button" class="btn api-sync-btn success" data-provider="METALS_DEV">Save and Test</button>
                      <button type="button" class="btn api-clear-btn warning" data-provider="METALS_DEV">Clear Key</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Metals-API Provider Panel -->
              <div class="settings-provider-panel" id="providerPanel_METALS_API" style="display: none">
                <div class="api-provider" data-provider="METALS_API">
                  <div class="provider-header">
                    <span class="provider-name">Metals-API.com</span>
                    <a href="https://metals-api.com/documentation" target="_blank" rel="noopener noreferrer" class="provider-doc-link" title="API Documentation">Docs</a>
                  </div>
                  <div class="api-key-row">
                    <label for="apiKey_METALS_API">API Key:</label>
                    <input type="password" id="apiKey_METALS_API" placeholder="Enter your API key" />
                  </div>
                  <div class="provider-settings">
                    <h4>Provider Settings</h4>
                    <div class="provider-setting-row">
                      <label for="cacheTimeout_METALS_API">Cache Timeout:</label>
                      <select id="cacheTimeout_METALS_API" class="provider-cache-select">
                        <option value="0">No Cache</option>
                        <option value="0.25">15 minutes</option>
                        <option value="0.5">30 minutes</option>
                        <option value="1">1 hour</option>
                        <option value="6">6 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24" selected>24 hours</option>
                      </select>
                    </div>
                    <div class="provider-setting-row">
                      <label for="providerPriority_METALS_API">Sync Priority:</label>
                      <select class="provider-priority-select" id="providerPriority_METALS_API" data-provider="METALS_API">
                        <option value="1">1st</option>
                        <option value="2">2nd</option>
                        <option value="3">3rd</option>
                        <option value="4">4th</option>
                        <option value="5">5th</option>
                        <option value="0">Disabled</option>
                      </select>
                    </div>
                    <div class="provider-history-pull">
                      <label for="historyPullDays_METALS_API">Pull History:</label>
                      <select id="historyPullDays_METALS_API" class="provider-history-select">
                        <option value="7">7 days</option>
                        <option value="14">14 days</option>
                        <option value="30" selected>30 days</option>
                        <option value="60">60 days</option>
                        <option value="90">90 days</option>
                        <option value="180">180 days</option>
                        <option value="365">365 days</option>
                      </select>
                      <button type="button" class="btn api-history-btn" data-provider="METALS_API">Pull History</button>
                      <span class="history-pull-cost" id="historyPullCost_METALS_API"></span>
                    </div>
                    <div class="metal-selection">
                      <label>Select Metals to Track:</label>
                      <div class="metal-checkboxes">
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="METALS_API" data-metal="silver" checked><span class="metal-name">Silver (AG)</span></label>
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="METALS_API" data-metal="gold" checked><span class="metal-name">Gold (AU)</span></label>
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="METALS_API" data-metal="platinum" checked><span class="metal-name">Platinum (PT)</span></label>
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="METALS_API" data-metal="palladium" checked><span class="metal-name">Palladium (PD)</span></label>
                      </div>
                    </div>
                    <div class="provider-info">
                      <div class="api-key-note">Your API key is stored locally and never shared.</div>
                      <div class="provider-status"><span class="status-dot"></span><span class="status-text">Disconnected</span><span class="status-last-used"></span></div>
                      <div class="provider-history"></div>
                    </div>
                  </div>
                  <div class="provider-footer">
                    <div class="provider-actions">
                      <button type="button" class="btn api-save-btn" data-provider="METALS_API">Save</button>
                      <button type="button" class="btn api-sync-btn success" data-provider="METALS_API">Save and Test</button>
                      <button type="button" class="btn api-clear-btn warning" data-provider="METALS_API">Clear Key</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- MetalPriceAPI Provider Panel -->
              <div class="settings-provider-panel" id="providerPanel_METAL_PRICE_API" style="display: none">
                <div class="api-provider" data-provider="METAL_PRICE_API">
                  <div class="provider-header">
                    <span class="provider-name">MetalPriceAPI.com</span>
                    <a href="https://metalpriceapi.com/documentation" target="_blank" rel="noopener noreferrer" class="provider-doc-link" title="API Documentation">Docs</a>
                  </div>
                  <div class="api-key-row">
                    <label for="apiKey_METAL_PRICE_API">API Key:</label>
                    <input type="password" id="apiKey_METAL_PRICE_API" placeholder="Enter your API key" />
                  </div>
                  <div class="provider-settings">
                    <h4>Provider Settings</h4>
                    <div class="provider-setting-row">
                      <label for="cacheTimeout_METAL_PRICE_API">Cache Timeout:</label>
                      <select id="cacheTimeout_METAL_PRICE_API" class="provider-cache-select">
                        <option value="0">No Cache</option>
                        <option value="0.25">15 minutes</option>
                        <option value="0.5">30 minutes</option>
                        <option value="1">1 hour</option>
                        <option value="6">6 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24" selected>24 hours</option>
                      </select>
                    </div>
                    <div class="provider-setting-row">
                      <label for="providerPriority_METAL_PRICE_API">Sync Priority:</label>
                      <select class="provider-priority-select" id="providerPriority_METAL_PRICE_API" data-provider="METAL_PRICE_API">
                        <option value="1">1st</option>
                        <option value="2">2nd</option>
                        <option value="3">3rd</option>
                        <option value="4">4th</option>
                        <option value="5">5th</option>
                        <option value="0">Disabled</option>
                      </select>
                    </div>
                    <div class="provider-history-pull">
                      <label for="historyPullDays_METAL_PRICE_API">Pull History:</label>
                      <select id="historyPullDays_METAL_PRICE_API" class="provider-history-select">
                        <option value="7">7 days</option>
                        <option value="14">14 days</option>
                        <option value="30" selected>30 days</option>
                        <option value="60">60 days</option>
                        <option value="90">90 days</option>
                        <option value="180">180 days</option>
                        <option value="365">365 days</option>
                      </select>
                      <button type="button" class="btn api-history-btn" data-provider="METAL_PRICE_API">Pull History</button>
                      <label class="metal-checkbox" style="margin-left: 0.5rem;">
                        <input type="checkbox" id="hourlyPull_METAL_PRICE_API" class="provider-hourly-toggle" data-provider="METAL_PRICE_API">
                        <span class="metal-name">Hourly</span>
                      </label>
                      <span class="history-pull-cost" id="historyPullCost_METAL_PRICE_API"></span>
                    </div>
                    <div class="metal-selection">
                      <label>Select Metals to Track:</label>
                      <div class="metal-checkboxes">
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="METAL_PRICE_API" data-metal="silver" checked><span class="metal-name">Silver (AG)</span></label>
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="METAL_PRICE_API" data-metal="gold" checked><span class="metal-name">Gold (AU)</span></label>
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="METAL_PRICE_API" data-metal="platinum" checked><span class="metal-name">Platinum (PT)</span></label>
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="METAL_PRICE_API" data-metal="palladium" checked><span class="metal-name">Palladium (PD)</span></label>
                      </div>
                    </div>
                    <div class="provider-info">
                      <div class="api-key-note">Your API key is stored locally and never shared.</div>
                      <div class="provider-status"><span class="status-dot"></span><span class="status-text">Disconnected</span><span class="status-last-used"></span></div>
                      <div class="provider-history"></div>
                    </div>
                  </div>
                  <div class="provider-footer">
                    <div class="provider-actions">
                      <button type="button" class="btn api-save-btn" data-provider="METAL_PRICE_API">Save</button>
                      <button type="button" class="btn api-sync-btn success" data-provider="METAL_PRICE_API">Save and Test</button>
                      <button type="button" class="btn api-clear-btn warning" data-provider="METAL_PRICE_API">Clear Key</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Custom Spot API Provider Panel -->
              <div class="settings-provider-panel" id="providerPanel_CUSTOM" style="display: none">
                <div class="api-provider" data-provider="CUSTOM">
                  <div class="provider-header">
                    <span class="provider-name">Custom Spot API</span>
                  </div>
                  <div class="api-field-row">
                    <label for="apiBase_CUSTOM">Base URL:</label>
                    <input type="text" id="apiBase_CUSTOM" placeholder="https://api.example.com" />
                  </div>
                  <div class="api-field-row">
                    <label for="apiEndpoint_CUSTOM">Endpoint:</label>
                    <input type="text" id="apiEndpoint_CUSTOM" placeholder="/latest?key={API_KEY}&metal={METAL}" />
                  </div>
                  <div class="api-field-row">
                    <label for="apiFormat_CUSTOM">Metal Format:</label>
                    <select id="apiFormat_CUSTOM">
                      <option value="symbol">Symbol</option>
                      <option value="word">Word</option>
                    </select>
                  </div>
                  <div class="api-key-row">
                    <label for="apiKey_CUSTOM">API Key:</label>
                    <input type="password" id="apiKey_CUSTOM" placeholder="Enter your API key" />
                  </div>
                  <div class="provider-settings">
                    <h4>Provider Settings</h4>
                    <div class="provider-setting-row">
                      <label for="cacheTimeout_CUSTOM">Cache Timeout:</label>
                      <select id="cacheTimeout_CUSTOM" class="provider-cache-select">
                        <option value="0">No Cache</option>
                        <option value="0.25">15 minutes</option>
                        <option value="0.5">30 minutes</option>
                        <option value="1">1 hour</option>
                        <option value="6">6 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24" selected>24 hours</option>
                      </select>
                    </div>
                    <div class="provider-setting-row">
                      <label for="providerPriority_CUSTOM">Sync Priority:</label>
                      <select class="provider-priority-select" id="providerPriority_CUSTOM" data-provider="CUSTOM">
                        <option value="1">1st</option>
                        <option value="2">2nd</option>
                        <option value="3">3rd</option>
                        <option value="4">4th</option>
                        <option value="5">5th</option>
                        <option value="0">Disabled</option>
                      </select>
                    </div>
                    <!-- Custom providers: no history pull (batch not supported) -->
                    <div class="metal-selection">
                      <label>Select Metals to Track:</label>
                      <div class="metal-checkboxes">
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="CUSTOM" data-metal="silver" checked><span class="metal-name">Silver (AG)</span></label>
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="CUSTOM" data-metal="gold" checked><span class="metal-name">Gold (AU)</span></label>
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="CUSTOM" data-metal="platinum" checked><span class="metal-name">Platinum (PT)</span></label>
                        <label class="metal-checkbox"><input type="checkbox" class="provider-metal" data-provider="CUSTOM" data-metal="palladium" checked><span class="metal-name">Palladium (PD)</span></label>
                      </div>
                    </div>
                    <div class="provider-info">
                      <div class="api-key-note">Your API key is stored locally and never shared.</div>
                      <div class="provider-status"><span class="status-dot"></span><span class="status-text">Disconnected</span><span class="status-last-used"></span></div>
                      <div class="provider-history"></div>
                    </div>
                  </div>
                  <div class="provider-footer">
                    <div class="provider-actions">
                      <button type="button" class="btn api-save-btn" data-provider="CUSTOM">Save</button>
                      <button type="button" class="btn api-sync-btn success" data-provider="CUSTOM">Save and Test</button>
                      <button type="button" class="btn api-clear-btn warning" data-provider="CUSTOM">Clear Key</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ===== CLOUD SYNC ===== -->
            <div class="settings-section-panel" id="settingsPanel_cloud" style="display: none">
              <h3>Cloud Sync</h3>

              <!-- Beta Banner -->
              <div class="cloud-beta-banner">
                <span class="cloud-beta-badge">BETA</span>
                <p class="cloud-beta-title">&#x1F409; Here be dragons</p>
                <p>Cloud Sync lets you store <strong>encrypted vault backups</strong> on your own cloud storage account. Your data is encrypted with AES-256-GCM before it leaves StakTrakr &mdash; your provider never sees the plaintext.</p>
                <p>This feature is in <strong>early beta</strong>. It works, but rough edges remain. We are a small team and your patience means a lot.</p>
                <p style="margin-bottom:0"><button class="resource-btn" style="font-size:0.8rem;padding:0.35rem 0.75rem" onclick="if(window.openModalById)openModalById('privacyModal')">&#x1F512; Privacy Policy</button></p>
              </div>

              <!-- StakTrakr Cloud Placeholder -->
              <div class="cloud-provider-card cloud-provider-card--coming-soon">
                <div class="cloud-provider-card-header">
                  <span class="cloud-provider-card-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:-2px"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    StakTrakr Cloud <span style="font-weight:400;font-size:0.8em">(Sponsors)</span>
                  </span>
                  <span class="cloud-provider-card-badges">
                    <span class="cloud-badge cloud-badge--coming-soon">COMING SOON</span>
                  </span>
                </div>
                <p class="settings-subtext" style="margin:0.5rem 0 0">Supabase-powered cloud storage for StakTrakr sponsors. Zero-config encrypted sync with automatic backups.</p>
              </div>

              <!-- Dropbox Provider (unified card) -->
              <div class="cloud-provider-card" id="cloudCard_dropbox">
                <div class="cloud-provider-card-header">
                  <span class="cloud-provider-card-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:-2px"><path d="M6 2l6 3.6L6 9.2 0 5.6zm12 0l6 3.6-6 3.6-6-3.6zm-12 8l6 3.6-6 3.6-6-3.6zm12 0l6 3.6-6 3.6-6-3.6zM6 18.4l6-3.6 6 3.6-6 3.6z"/></svg>
                    Dropbox
                  </span>
                  <span class="cloud-provider-card-badges">
                    <span class="cloud-connected-badge" style="display:none">Connected</span>
                    <span class="cloud-badge cloud-badge--beta">BETA</span>
                  </span>
                </div>

                <!-- Status rows -->
                <div class="cloud-connection-status" id="cloudStatus_dropbox">
                  <div class="cloud-status-row">
                    <span class="cloud-status-label">Status</span>
                    <span class="cloud-status-value cloud-status-indicator" data-state="disconnected">
                      <span class="cloud-status-dot"></span>
                      <span class="cloud-status-text">Not connected</span>
                    </span>
                  </div>
                  <div class="cloud-status-row">
                    <span class="cloud-status-label">Last sync</span>
                    <span class="cloud-status-value cloud-status-sync">Never</span>
                  </div>
                  <div class="cloud-status-row">
                    <span class="cloud-status-label">Items backed up</span>
                    <span class="cloud-status-value cloud-status-items">&mdash;</span>
                  </div>
                </div>

                <!-- Actions -->
                <div class="cloud-provider-card-actions">
                  <div class="cloud-login-area">
                    <button class="btn cloud-connect-btn" data-provider="dropbox">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:0.3rem"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                      Login to Dropbox
                    </button>
                  </div>
                  <button class="btn danger cloud-disconnect-btn" data-provider="dropbox" style="display:none">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:0.3rem"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    Disconnect
                  </button>
                  <button class="btn success cloud-backup-btn" data-provider="dropbox" disabled>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:0.3rem"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Backup Now
                  </button>
                  <button class="btn cloud-restore-btn" data-provider="dropbox" disabled>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:0.3rem"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Restore
                  </button>
                </div>
                <div class="cloud-status-detail"></div>
                <div class="cloud-backup-list" id="cloudBackupList_dropbox" style="display:none"></div>

                <!-- STAK-149: Auto-Sync Controls -->
                <div class="cloud-autosync-section" style="margin-top:0.75rem;border-top:1px solid var(--border-color,#ddd);padding-top:0.75rem">
                  <div class="cloud-status-row" style="align-items:center">
                    <span class="cloud-status-label">
                      <strong>Auto-sync</strong>
                      <span class="settings-subtext" style="display:block;font-size:0.75rem">Sync inventory automatically on every change</span>
                    </span>
                    <label class="settings-toggle-switch" style="margin-left:auto">
                      <input type="checkbox" id="cloudAutoSyncToggle" onchange="if(this.checked){enableCloudSync('dropbox');}else{disableCloudSync();}">
                      <span class="settings-toggle-slider"></span>
                    </label>
                  </div>
                  <div class="cloud-status-row" id="cloudAutoSyncStatus" style="align-items:center;margin-top:0.35rem">
                    <span class="cloud-status-label">Status</span>
                    <span class="cloud-status-value" style="display:flex;align-items:center;gap:0.4rem">
                      <span class="cloud-sync-dot"></span>
                      <span class="cloud-sync-status-text">Auto-sync off</span>
                    </span>
                  </div>
                  <div class="cloud-status-row" style="align-items:center;margin-top:0.35rem">
                    <span class="cloud-status-label">Last synced</span>
                    <span class="cloud-status-value" id="cloudAutoSyncLastSync">Never</span>
                  </div>
                  <div style="margin-top:0.5rem">
                    <button class="btn" id="cloudSyncNowBtn" disabled onclick="if(typeof pushSyncVault==='function')pushSyncVault();" style="font-size:0.8rem;padding:0.25rem 0.6rem">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px;margin-right:0.25rem"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                      Sync Now
                    </button>
                  </div>
                </div>

                <!-- Sync History (pre-pull local snapshot) -->
                <div class="cloud-autosync-section" style="margin-top:0.75rem;border-top:1px solid var(--border-color,#ddd);padding-top:0.75rem">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
                    <strong style="font-size:0.85rem">Sync History</strong>
                    <span class="settings-subtext" style="font-size:0.75rem">Last local snapshot</span>
                  </div>
                  <div id="cloudSyncHistorySection">
                    <p class="settings-subtext" style="margin:0">No snapshot available.</p>
                  </div>
                </div>

                <!-- Disclaimer -->
                <div class="cloud-provider-disclaimer" style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap">
                  <span>Backups are stored in <strong>/StakTrakr</strong> on your Dropbox. Your vault password encrypts the data &mdash; if you lose it, backups cannot be recovered.</span>
                  <button class="btn" style="font-size:0.78rem;padding:0.2rem 0.55rem;white-space:nowrap;flex-shrink:0"
                    onclick="if(typeof switchLogTab==='function'){switchLogTab('cloud');} if(typeof switchSettingsSection==='function'){switchSettingsSection('changelog');}">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px;margin-right:0.25rem"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                    View Sync Log
                  </button>
                </div>
              </div>

              <!-- More Providers -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">More Providers</div>
                <div class="settings-card-grid">
                  <!-- Google Drive -->
                  <div class="cloud-provider-card cloud-provider-card--coming-soon" style="margin:0">
                    <div class="cloud-provider-card-header">
                      <span class="cloud-provider-card-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:-2px"><path d="M7.71 3.5l-5.5 9.5h5.6l5.5-9.5H7.71zm1.1 10.5H1.39L4.59 20h8.71l-4.49-6zm8.68-10.5l-5.5 9.5 3.39 5.5 5.5-9.5-3.39-5.5z"/></svg>
                        Google Drive
                      </span>
                      <span class="cloud-provider-card-badges">
                        <span class="cloud-badge cloud-badge--coming-soon">COMING SOON</span>
                      </span>
                    </div>
                  </div>
                  <!-- OneDrive -->
                  <div class="cloud-provider-card cloud-provider-card--coming-soon" style="margin:0">
                    <div class="cloud-provider-card-header">
                      <span class="cloud-provider-card-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:-2px"><path d="M10.5 18H6a4 4 0 0 1-.83-7.91A5.5 5.5 0 0 1 14.28 8 3.5 3.5 0 0 1 18 11.5h.5a2.5 2.5 0 0 1 0 5H15"/><path d="M10 15l3-3 3 3"/></svg>
                        OneDrive
                      </span>
                      <span class="cloud-provider-card-badges">
                        <span class="cloud-badge cloud-badge--coming-soon">COMING SOON</span>
                      </span>
                    </div>
                  </div>
                  <!-- pCloud -->
                  <div class="cloud-provider-card cloud-provider-card--coming-soon" style="margin:0">
                    <div class="cloud-provider-card-header">
                      <span class="cloud-provider-card-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>
                        pCloud
                      </span>
                      <span class="cloud-provider-card-badges">
                        <span class="cloud-badge cloud-badge--coming-soon">COMING SOON</span>
                      </span>
                    </div>
                  </div>
                  <!-- Box -->
                  <div class="cloud-provider-card cloud-provider-card--coming-soon" style="margin:0">
                    <div class="cloud-provider-card-header">
                      <span class="cloud-provider-card-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 3H8L2 7h20l-6-4z"/></svg>
                        Box
                      </span>
                      <span class="cloud-provider-card-badges">
                        <span class="cloud-badge cloud-badge--coming-soon">COMING SOON</span>
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Session Cache (demoted) -->
              <div class="settings-fieldset cloud-session-cache">
                <div class="settings-fieldset-title">Session Password Cache</div>
                <p class="settings-subtext">Your vault password is remembered for this browser session after the first backup or restore. Closing the browser clears it.</p>
                <div class="cloud-status-row" style="margin-top:0.5rem">
                  <span class="cloud-status-label">Cache status</span>
                  <span class="cloud-status-value" id="cloudPwCacheStatus">Not cached</span>
                </div>
              </div>

            </div>

            <!-- ===== IMAGES (STACK-96) ===== -->
            <div class="settings-section-panel" id="settingsPanel_images" style="display: none">
              <h3>Images</h3>

              <!-- ── Cache Actions ── -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">Image Cache</div>
                <div class="image-actions-row">
                  <button class="btn" id="importImagesBtn" type="button">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:0.3rem"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Import
                  </button>
                  <button class="btn" id="exportAllImagesBtn" type="button">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:0.3rem"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Export
                  </button>
                  <button class="btn secondary" id="syncImageUrlsBtn" type="button">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:0.3rem"><path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M2.5 11.5a10 10 0 0 1 18.4-4.5"/><path d="M21.5 12.5a10 10 0 0 1-18.4 4.5"/></svg>
                    Download URLs
                  </button>
                  <button class="btn danger" id="clearAllImagesBtn" type="button">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:0.3rem"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
                    Clear Cache
                  </button>
                  <input type="file" id="importImagesFile" accept=".zip" style="display:none" />
                </div>
              </div>

              <!-- ── Image Display ── -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">Image Display</div>
                <div class="settings-card-grid settings-card-grid--compact settings-card-grid--3col">
                  <div class="settings-card">
                    <div class="settings-group-label">Table thumbnails</div>
                    <p class="settings-subtext">Show coin images in the table.</p>
                    <div class="chip-sort-toggle" id="tableImagesToggle">
                      <button type="button" class="chip-sort-btn" data-val="yes">On</button>
                      <button type="button" class="chip-sort-btn" data-val="no">Off</button>
                    </div>
                  </div>
                  <div class="settings-card">
                    <div class="settings-group-label">Image sides</div>
                    <p class="settings-subtext">Which coin sides to show.</p>
                    <div class="chip-sort-toggle" id="tableImageSidesToggle">
                      <button type="button" class="chip-sort-btn" data-val="both">Both</button>
                      <button type="button" class="chip-sort-btn" data-val="obverse">Obv</button>
                      <button type="button" class="chip-sort-btn" data-val="reverse">Rev</button>
                    </div>
                  </div>
                  <div class="settings-card">
                    <div class="settings-group-label">Numista override</div>
                    <p class="settings-subtext">Numista images take priority.</p>
                    <div class="chip-sort-toggle" id="numistaOverrideToggle">
                      <button type="button" class="chip-sort-btn" data-val="yes">On</button>
                      <button type="button" class="chip-sort-btn" data-val="no">Off</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ── Add Pattern Image Rule ── -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">Add Pattern Image Rule</div>
                <p class="settings-subtext">Create rules that automatically assign images to items matching a name pattern.</p>
                <div class="pattern-rule-form" id="patternRuleForm">
                  <div class="pattern-rule-form-row">
                    <div class="pattern-rule-field">
                      <label for="patternRulePattern">
                        Name Pattern
                        <div class="chip-sort-toggle pattern-mode-toggle" id="patternModeToggle" style="display:inline-flex;margin-left:0.4rem;vertical-align:middle;">
                          <button type="button" id="patternModeKeywords" class="chip-sort-btn active" title="Comma or semicolon separated keywords">Keywords</button>
                          <button type="button" id="patternModeRegex" class="chip-sort-btn" title="Regular expression">Regex</button>
                        </div>
                      </label>
                      <input type="text" id="patternRulePattern" class="form-control" placeholder="e.g. morgan, peace, walking liberty" />
                      <small id="patternRuleTip" class="pattern-rule-tip">Separate keywords with commas or semicolons. Matches item names containing any keyword.</small>
                    </div>
                  </div>
                  <div class="pattern-rule-form-row">
                    <div class="pattern-rule-field">
                      <label for="patternRuleObverse">Obverse Image</label>
                      <div class="image-input-row">
                        <input type="file" id="patternRuleObverse" accept="image/*" />
                        <button type="button" class="btn btn-icon camera-capture-btn" id="patternRuleObverseCamera" title="Take photo" aria-label="Take photo with camera">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                        </button>
                        <input type="file" id="patternRuleObverseCapture" accept="image/*" capture="environment" style="display:none" aria-hidden="true" />
                      </div>
                    </div>
                    <div class="pattern-rule-field">
                      <label for="patternRuleReverse">Reverse Image</label>
                      <div class="image-input-row">
                        <input type="file" id="patternRuleReverse" accept="image/*" />
                        <button type="button" class="btn btn-icon camera-capture-btn" id="patternRuleReverseCamera" title="Take photo" aria-label="Take photo with camera">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                        </button>
                        <input type="file" id="patternRuleReverseCapture" accept="image/*" capture="environment" style="display:none" aria-hidden="true" />
                      </div>
                    </div>
                    <div class="pattern-rule-field pattern-rule-field-narrow" style="align-self:flex-end">
                      <button class="btn" id="addPatternRuleBtn" type="button">Add Rule</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ── Custom Pattern Rules ── -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">Custom Pattern Rules</div>
                <div id="customPatternImageRules"></div>
              </div>

              <!-- ── Per-Item User Images ── -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">Per-Item User Images</div>
                <div id="userImageGrid"></div>
              </div>

              <!-- ── Storage (bottom) ── -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">Storage</div>
                <div id="imageStorageStats" class="image-storage-stats">
                  <span class="stat-item">Loading...</span>
                </div>
              </div>
            </div>

            <!-- ===== INVENTORY ===== -->
            <div class="settings-section-panel" id="settingsPanel_system" style="display: none">
              <h3>Inventory</h3>

              <!-- ── Bulk Editor ── -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">Bulk Editor</div>
                <div class="settings-card-grid">
                  <div class="settings-card">
                    <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.35rem">
                      <div class="settings-group-label" style="margin:0">Bulk Editor</div>
                      <span class="cloud-badge cloud-badge--beta">BETA</span>
                    </div>
                    <p class="settings-subtext">Select multiple inventory items and apply batch operations — edit shared fields, duplicate entries, or remove items in bulk. This feature is actively developed; please report any issues on GitHub.</p>
                    <div class="settings-btn-row">
                      <button class="btn settings-action-btn" id="bulkEditBtn" type="button">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:0.35rem;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        Open Bulk Editor
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ── Import ── -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">Import</div>
                <div class="settings-card-grid">
                  <div class="settings-card">
                    <h3>Import</h3>
                    <p class="settings-subtext">Import your data files.</p>
                    <div class="import-block">
                      <div class="import-export-grid">
                        <div class="import-csv-grid">
                          <button class="btn warning" id="importCsvOverride">Import CSV</button>
                          <button class="btn success" id="importCsvMerge">Merge CSV</button>
                          <input accept=".csv" hidden id="importCsvFile" type="file" />
                        </div>
                        <div class="import-json-grid">
                          <button class="btn warning" id="importJsonOverride">Import JSON</button>
                          <button class="btn success" id="importJsonMerge">Merge JSON</button>
                          <input accept=".json" hidden id="importJsonFile" type="file" />
                        </div>
                        <div>
                          <button class="btn warning" id="importZipBtn">Restore ZIP Backup</button>
                          <input accept=".zip" hidden id="importZipFile" type="file" />
                        </div>
                      </div>
                      <progress class="import-progress" id="importProgress" value="0" max="0"></progress>
                      <div class="import-progress-text" id="importProgressText"></div>
                    </div>
                    <p class="settings-subtext" style="margin-top:0.5rem">
                      New here? <a href="sample.csv" download="sample.csv">Download sample CSV</a> to try importing.
                    </p>
                  </div>
                  <div class="settings-card">
                    <h3>Third-Party</h3>
                    <p class="settings-subtext">Import data from external services like Numista.</p>
                    <div class="third-party-block">
                      <div class="import-export-grid">
                        <div class="grid grid-2">
                          <button class="btn warning" id="importNumistaBtn">Import Numista CSV</button>
                          <button class="btn success" id="mergeNumistaBtn">Merge Numista CSV</button>
                        </div>
                        <input type="file" id="numistaImportFile" accept=".csv" hidden />
                        <div class="beta-warning">Numista import is a beta feature</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ── Export ── -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">Export</div>
                <div class="settings-card-grid">
                  <div class="settings-card">
                    <h3>Export</h3>
                    <p class="settings-subtext">Export your data files.</p>
                    <div class="export-block">
                      <div class="import-export-grid">
                        <button class="btn info" id="exportCsvBtn">Export CSV</button>
                        <button class="btn info" id="exportJsonBtn">Export JSON</button>
                        <button class="btn info" id="exportPdfBtn">Export PDF</button>
                        <button class="btn info" id="exportZipBtn">Export ZIP Backup</button>
                      </div>
                    </div>
                  </div>
                  <div class="settings-card">
                    <div class="settings-group-label">Encrypted Backup</div>
                    <p class="settings-subtext">AES-GCM encrypted vault file. Use to back up and restore all inventory data.</p>
                    <div class="settings-btn-row">
                      <button class="btn" id="vaultExportBtn">Export Backup</button>
                      <button class="btn info" id="vaultImportBtn">Restore Backup</button>
                    </div>
                    <input type="file" id="vaultImportFile" accept=".stvault" hidden />
                  </div>
                </div>
              </div>

            </div>

            <!-- ===== STORAGE ===== -->
            <div class="settings-section-panel" id="settingsPanel_storage" style="display: none">
              <h3>Storage</h3>

              <!-- ── Summary Cards ── -->
              <div class="storage-summary-grid" id="storageSummaryGrid">
                <div class="storage-stat-card">
                  <div class="storage-stat-label">localStorage</div>
                  <div class="storage-stat-value" id="storageStat_ls">—</div>
                  <div class="storage-stat-bar-wrap">
                    <div class="storage-stat-bar storage-stat-bar--ls" id="storageStatBar_ls"></div>
                  </div>
                  <div class="storage-stat-sub" id="storageStat_ls_sub">of 5,120 KB</div>
                </div>
                <div class="storage-stat-card">
                  <div class="storage-stat-label">IndexedDB (Images)</div>
                  <div class="storage-stat-value" id="storageStat_idb">—</div>
                  <div class="storage-stat-bar-wrap">
                    <div class="storage-stat-bar storage-stat-bar--idb" id="storageStatBar_idb"></div>
                  </div>
                  <div class="storage-stat-sub" id="storageStat_idb_sub">of 50 MB</div>
                </div>
                <div class="storage-stat-card">
                  <div class="storage-stat-label">Combined</div>
                  <div class="storage-stat-value" id="storageStat_combined">—</div>
                  <div class="storage-stat-bar-wrap storage-stat-bar-wrap--stacked">
                    <div class="storage-stat-bar storage-stat-bar--ls" id="storageStatBar_combined_ls"></div>
                    <div class="storage-stat-bar storage-stat-bar--idb" id="storageStatBar_combined_idb"></div>
                  </div>
                  <div class="storage-stat-sub" id="storageStat_combined_sub">of ~55 MB cap</div>
                </div>
              </div>

              <!-- ── localStorage Keys ── -->
              <div class="settings-fieldset">
                <div class="storage-fieldset-header">
                  <div class="settings-fieldset-title" style="margin:0">localStorage Keys</div>
                  <div class="storage-fieldset-actions">
                    <button class="storage-toggle-tiny btn-link" id="storageToggleTiny">Show minor keys</button>
                    <button class="btn storage-refresh-btn" id="storageRefreshBtn" title="Refresh storage stats">
                      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                      Refresh
                    </button>
                  </div>
                </div>
                <div id="storageKeyTable" class="storage-key-table">
                  <div class="storage-key-table-loading">Loading…</div>
                </div>
              </div>

              <!-- ── IndexedDB Stores ── -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">IndexedDB Stores</div>
                <div id="storageIdbTable" class="storage-key-table">
                  <div class="storage-key-table-loading">Loading…</div>
                </div>
              </div>

              <!-- ── Data Reset ── -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">Data Reset</div>
                <div class="settings-card-grid">
                  <div class="settings-card boating-accident-section">
                    <p class="settings-subtext">Permanently remove inventory or wipe all app data. These actions cannot be undone.</p>
                    <div class="settings-btn-row">
                      <button class="btn warning" id="removeInventoryDataBtn">Remove Inventory</button>
                      <button class="btn danger" id="boatingAccidentBtn">Wipe All Data</button>
                    </div>
                  </div>
                </div>
              </div>

            </div>

            <!-- ===== CURRENCY & PRICING ===== -->
            <div class="settings-section-panel" id="settingsPanel_currency" style="display: none">
              <h3>Currency &amp; Pricing</h3>

              <div class="settings-fieldset">
                <div class="settings-group">
                  <div class="settings-group-label">Display currency</div>
                  <p class="settings-subtext">All prices, spot values, and exports will use this currency. Spot prices are fetched in USD and converted using daily exchange rates.</p>
                  <select id="settingsDisplayCurrency"></select>
                </div>
                <div class="settings-group">
                  <div class="settings-group-label">Header currency button</div>
                  <p class="settings-subtext">Show a quick currency switcher in the app header.</p>
                  <div class="chip-sort-toggle" id="settingsHeaderCurrencyBtn">
                    <button type="button" class="chip-sort-btn" data-val="yes">On</button>
                    <button type="button" class="chip-sort-btn" data-val="no">Off</button>
                  </div>
                </div>
                <div class="settings-group">
                  <div class="settings-group-label">24h price comparison</div>
                  <p class="settings-subtext">Choose how the 24h percentage change on spot cards is calculated.</p>
                  <select id="settingsSpotCompareMode">
                    <option value="close-close">Close / Close (default)</option>
                    <option value="open-open">Open / Open</option>
                    <option value="open-close">Open / Close</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- ===== GOLDBACK PRICING (STACK-45) ===== -->
            <div class="settings-section-panel" id="settingsPanel_goldback" style="display: none">
              <h3>Goldback Denomination Pricing</h3>
              <p class="settings-subtext">
                Set market prices for Goldback denominations manually or auto-estimate from gold spot.
                Check current rates at
                <a href="#" id="goldbackExchangeRateLink">goldback.com/exchange-rates</a>.
              </p>

              <div class="settings-group">
                <label>Goldback Pricing</label>
                <p class="settings-subtext">Use denomination prices as retail value for gb-unit items.</p>
                <div id="settingsGoldbackEnabled" class="chip-sort-group">
                  <button class="chip-sort-btn" data-val="on" type="button">On</button>
                  <button class="chip-sort-btn active" data-val="off" type="button">Off</button>
                </div>
              </div>

              <div class="settings-group">
                <label>Real-Time Price Estimation</label>
                <p class="settings-subtext">
                  Auto-estimate prices from gold spot: <code>2 &times; (spot&thinsp;/&thinsp;1000) &times; modifier</code>.
                  Manual edits will be overwritten on the next spot refresh.
                </p>
                <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
                  <div id="settingsGoldbackEstimateEnabled" class="chip-sort-group">
                    <button class="chip-sort-btn" data-val="on" type="button">On</button>
                    <button class="chip-sort-btn active" data-val="off" type="button">Off</button>
                  </div>
                  <button class="btn btn-primary" id="goldbackEstimateRefreshBtn" type="button" style="display:none;">Refresh from API</button>
                </div>
                <div id="goldbackEstimateModifierRow" style="display:none;margin-top:0.5rem;">
                  <label style="font-size:0.85em;">
                    Modifier
                    <span class="settings-tooltip" title="Community research suggests Goldback pegs at roughly 2&times; gold spot + ~3% (modifier 1.03). The default is 1.0 (no premium). Adjust based on how your API spot price compares to Goldback's published rates.">&#9432;</span>
                  </label>
                  <div style="display:flex;align-items:center;gap:0.4rem;margin-top:0.25rem;">
                    <input type="number" id="goldbackEstimateModifierInput" min="0.5" max="2.0" step="0.01" value="1.0" style="width:80px;" />
                    <span style="font-size:0.8em;color:var(--text-secondary);">(1.0 = no premium, 1.03 = ~3% premium)</span>
                  </div>
                </div>
                <p id="goldbackEstimateInfo" class="settings-subtext" style="display:none;margin-top:0.5rem;"></p>
              </div>

              <div class="settings-group">
                <label>Quick Fill</label>
                <p class="settings-subtext">Enter the 1 Goldback exchange rate to auto-fill all denominations.</p>
                <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem;">
                  <span id="gbQuickFillSymbol" style="color:var(--text-secondary);">$</span>
                  <input type="number" id="goldbackQuickFillInput" min="0" step="0.01" placeholder="1 GB rate" style="width:100px;" />
                  <button class="btn btn-primary" id="goldbackQuickFillBtn" type="button">Set All</button>
                </div>
              </div>

              <div class="settings-group">
                <label>Denomination Prices</label>
                <table class="settings-goldback-table" id="goldbackPriceTable">
                  <thead>
                    <tr>
                      <th>Denomination</th>
                      <th>Gold Content</th>
                      <th>Market Price</th>
                      <th>Last Updated</th>
                    </tr>
                  </thead>
                  <tbody id="goldbackPriceTableBody">
                    <!-- Rows rendered dynamically by syncGoldbackSettingsUI() -->
                  </tbody>
                </table>
                <button class="btn btn-primary" id="goldbackSavePricesBtn" type="button" style="margin-top: 0.5rem;">Save Prices</button>
                <button class="btn" id="goldbackHistoryBtn" type="button" style="margin-top: 0.5rem;">Goldback History</button>
              </div>
            </div>

            <!-- ===== MARKET PRICES ===== -->
            <div id="settingsPanel_market" class="settings-section-panel" style="display: none">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Market Prices</h3>
                <div style="display:flex;align-items:center;gap:0.5rem;">
                  <span id="retailLastSync" class="settings-subtext"></span>
                  <button id="retailSyncBtn" class="btn btn-sm btn-primary" type="button">Sync Now</button>
                </div>
              </div>
              <span id="retailSyncStatus" class="settings-subtext"></span>

              <div id="retailCardsGrid" class="retail-cards-grid" aria-live="polite" aria-label="Retail coin price cards">
                <!-- Cards rendered by renderRetailCards() -->
              </div>

              <div id="retailEmptyState" class="retail-empty-state" style="display: none">
                <div class="retail-empty-icon">📊</div>
                <p class="retail-empty-title">No market prices yet</p>
                <p class="retail-empty-desc">Sync to load current bullion retail prices from APMEX, Monument, SDB, and JM Bullion.</p>
                <button class="retail-sync-cta" type="button" onclick="syncRetailPrices()">Sync Now</button>
              </div>
            </div>

            <!-- ===== ACTIVITY LOG ===== -->
            <div class="settings-section-panel" id="settingsPanel_changelog" style="display: none">
              <h3>Activity Log</h3>
              <p class="settings-subtext">Browse inventory changes, spot price history, catalog lookups, and per-item price tracking.</p>

              <!-- Log sub-tab bar -->
              <div class="settings-log-tabs">
                <button class="settings-log-tab active" data-log-tab="changelog" type="button">Changelog</button>
                <button class="settings-log-tab" data-log-tab="metals" type="button">Metals</button>
                <button class="settings-log-tab" data-log-tab="lbma" type="button">LBMA History</button>
                <button class="settings-log-tab" data-log-tab="catalogs" type="button">Catalogs</button>
                <button class="settings-log-tab" data-log-tab="pricehistory" type="button">Price History</button>
                <button class="settings-log-tab" data-log-tab="cloud" type="button">Cloud</button>
                <button class="settings-log-tab" data-log-tab="market" type="button">Market</button>
              </div>

              <!-- Changelog panel (existing) -->
              <div class="settings-log-panel" id="logPanel_changelog">
                <p class="settings-subtext">Recent inventory changes. Click a row to edit the item, or undo/redo individual changes.</p>
                <div class="settings-changelog-actions">
                  <button class="btn btn-secondary" id="settingsChangeLogClearBtn" type="button">Clear Log</button>
                </div>
                <div class="settings-changelog-wrap">
                  <table id="settingsChangeLogTable">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Item</th>
                        <th>Field</th>
                        <th>Old Value</th>
                        <th>New Value</th>
                        <th>Undo</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <!-- Metals (Spot History) panel -->
              <div class="settings-log-panel" id="logPanel_metals" style="display: none">
                <p class="settings-subtext">Spot price updates recorded from API syncs and manual edits.</p>
                <div class="settings-changelog-actions">
                  <button class="btn btn-secondary" id="settingsSpotHistoryClearBtn" type="button">Clear Spot History</button>
                </div>
                <div class="settings-changelog-wrap">
                  <table id="settingsSpotHistoryTable">
                    <thead>
                      <tr>
                        <th>Timestamp</th>
                        <th>Metal</th>
                        <th>Spot Price</th>
                        <th>Source</th>
                        <th>Provider</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <!-- LBMA History (Reference Seed Data) panel -->
              <div class="settings-log-panel" id="logPanel_lbma" style="display: none">
                <p class="settings-subtext">Historical LBMA reference prices from bundled seed data (read-only).</p>
                <div class="settings-pricehistory-controls">
                  <select class="settings-filter-input" id="settingsLbmaMetalFilter">
                    <option value="all">All Metals</option>
                    <option value="silver">Silver</option>
                    <option value="gold">Gold</option>
                    <option value="platinum">Platinum</option>
                    <option value="palladium">Palladium</option>
                  </select>
                  <input class="settings-filter-input" id="settingsLbmaStartDate" type="date">
                  <input class="settings-filter-input" id="settingsLbmaEndDate" type="date">
                  <button class="btn btn-secondary" id="settingsLbmaResetBtn" type="button">Reset</button>
                  <span class="settings-subtext" id="settingsLbmaResultCount" style="margin-left:auto;"></span>
                </div>
                <div class="settings-changelog-wrap">
                  <table id="settingsLbmaHistoryTable">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Metal</th>
                        <th>Spot Price</th>
                        <th>Provider</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <!-- Catalogs panel -->
              <div class="settings-log-panel" id="logPanel_catalogs" style="display: none">
                <p class="settings-subtext">Catalog API call history. Failed lookups are highlighted in red.</p>
                <div class="settings-changelog-actions">
                  <button class="btn btn-secondary" id="settingsCatalogHistoryClearBtn" type="button">Clear Catalog History</button>
                </div>
                <div class="settings-changelog-wrap">
                  <table id="settingsCatalogHistoryTable">
                    <thead>
                      <tr>
                        <th>Time</th>
                        <th>Action</th>
                        <th>Query</th>
                        <th>Result</th>
                        <th>Items</th>
                        <th>Provider</th>
                        <th>Duration</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <!-- Price History panel -->
              <div class="settings-log-panel" id="logPanel_pricehistory" style="display: none">
                <p class="settings-subtext">Per-item price snapshots recorded on add, edit, and spot price sync.</p>
                <div class="settings-pricehistory-controls">
                  <input class="settings-filter-input" id="priceHistoryFilterInput" placeholder="Filter by item name..." type="text">
                  <button class="btn btn-secondary" id="settingsPriceHistoryClearBtn" type="button">Clear Price History</button>
                </div>
                <div class="settings-changelog-wrap">
                  <table id="settingsPriceHistoryTable">
                    <thead>
                      <tr>
                        <th>Timestamp</th>
                        <th>Item Name</th>
                        <th>Retail</th>
                        <th>Spot</th>
                        <th>Melt</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <!-- Cloud panel -->
              <div class="settings-log-panel" id="logPanel_cloud" style="display: none">
                <p class="settings-subtext">Cloud sync activity — backups, restores, connections, and token refreshes.</p>
                <div class="settings-changelog-actions">
                  <button class="btn btn-secondary" id="settingsCloudActivityClearBtn" type="button">Clear Cloud Log</button>
                </div>
                <div class="settings-changelog-wrap">
                  <table id="settingsCloudActivityTable">
                    <thead>
                      <tr>
                        <th>Time</th>
                        <th>Action</th>
                        <th>Provider</th>
                        <th>Result</th>
                        <th>Detail</th>
                        <th>Duration</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <div id="logPanel_market" class="settings-log-panel" style="display: none">
                <div class="retail-history-controls">
                  <label for="retailHistorySlugSelect" class="retail-history-label">Coin:</label>
                  <select id="retailHistorySlugSelect" class="form-select form-select-sm retail-history-select">
                    <option value="ase">American Silver Eagle</option>
                    <option value="maple-silver">Silver Maple Leaf</option>
                    <option value="britannia-silver">Silver Britannia</option>
                    <option value="krugerrand-silver">Silver Krugerrand</option>
                    <option value="generic-silver-round">Generic Silver Round</option>
                    <option value="generic-silver-bar-10oz">Generic 10oz Silver Bar</option>
                    <option value="age">American Gold Eagle</option>
                    <option value="buffalo">American Gold Buffalo</option>
                    <option value="maple-gold">Gold Maple Leaf</option>
                    <option value="krugerrand-gold">Gold Krugerrand</option>
                    <option value="ape">American Platinum Eagle</option>
                  </select>
                  <div class="retail-timeframe-tabs">
                    <button class="retail-tf-btn active" data-retail-timeframe="7" type="button">7d</button>
                    <button class="retail-tf-btn" data-retail-timeframe="30" type="button">30d</button>
                    <button class="retail-tf-btn" data-retail-timeframe="90" type="button">90d</button>
                    <button class="retail-tf-btn" data-retail-timeframe="all" type="button">All</button>
                  </div>
                </div>
                <div class="retail-history-table-wrap">
                  <table id="retailHistoryTable" class="retail-history-table">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Avg</th>
                        <th>Median</th>
                        <th>Lowest</th>
                        <th>APMEX</th>
                        <th>Monument</th>
                        <th>SDB</th>
                        <th>JM</th>
                      </tr>
                    </thead>
                    <tbody id="retailHistoryTableBody"></tbody>
                  </table>
                </div>
              </div>

            </div>

            <!-- ===== FAQ ===== -->
            <div class="settings-section-panel" id="settingsPanel_faq" style="display: none">
              <h3>Frequently Asked Questions</h3>

              <!-- Section 1: Your Data & Privacy -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">🔒 Your Data &amp; Privacy</div>

                <details class="faq-item">
                  <summary class="faq-question">Who can see my inventory?</summary>
                  <div class="faq-answer">
                    <p>Only you. Your inventory is stored entirely on your own device using your browser's localStorage (and IndexedDB for images). No data is ever sent to any server unless you explicitly choose to use a cloud backup feature like Dropbox.</p>
                    <p>Even when you use cloud backup, the data is encrypted on your device <em>before</em> it leaves — the cloud provider receives an encrypted blob they cannot read.</p>
                  </div>
                </details>

                <details class="faq-item">
                  <summary class="faq-question">Can the developer see my data?</summary>
                  <div class="faq-answer">
                    <p>No. There is no server-side component, no database, and no analytics that transmit your inventory. The developer has no technical means to access your data.</p>
                    <p>The only outbound network requests the app makes are:</p>
                    <ul class="faq-list">
                      <li>Spot price lookups from public metal pricing APIs (no inventory data included)</li>
                      <li>Numista / PCGS catalog searches when you use those features</li>
                      <li>Version check against <code>staktrakr.com/version.json</code> (no inventory data included)</li>
                      <li>Exchange rate data from Open Exchange Rates (no inventory data included)</li>
                    </ul>
                  </div>
                </details>

                <details class="faq-item">
                  <summary class="faq-question">Does this app use cookies or tracking?</summary>
                  <div class="faq-answer">
                    <p><strong>No cookies. No advertising SDKs. No tracking pixels.</strong> The app itself uses browser localStorage and IndexedDB solely to store your inventory and preferences on your own device.</p>
                    <p>However, when you use the <strong>hosted version</strong> at staktrakr.com (served via Cloudflare Pages), <a href="https://www.cloudflare.com/web-analytics/" target="_blank" rel="noopener">Cloudflare Web Analytics</a> is active at the network edge. It collects aggregated, anonymous page view metrics — things like visit counts, countries, and browser types — to help the developer understand usage. Cloudflare does this without cookies and without building individual user profiles.</p>
                    <p>No inventory data is ever included. If you download and run the app locally from a ZIP file, no analytics run at all.</p>
                    <details class="faq-technical">
                      <summary>What Cloudflare Web Analytics does and does not do</summary>
                      <p><strong>Does not:</strong> set cookies · use localStorage · fingerprint individuals · share data with advertisers · track you across sites<br><strong>Does:</strong> log page views at the network edge · process IP addresses server-side (not stored individually) · report aggregated metrics to the site owner only</p>
                    </details>
                  </div>
                </details>

                <details class="faq-item">
                  <summary class="faq-question">What happens if I clear my browser history?</summary>
                  <div class="faq-answer">
                    <p>If you clear browser storage (not just history), your inventory data stored in localStorage will be deleted. Browser history alone does not affect your data.</p>
                    <p><strong>Recommendation:</strong> Export a backup regularly using the ZIP or vault export options. This gives you a file you control, independent of any browser.</p>
                  </div>
                </details>

                <details class="faq-item">
                  <summary class="faq-question">Is this app safe from viruses or malware?</summary>
                  <div class="faq-answer">
                    <p>StakTrakr is open-source software — anyone can read the code at <a href="https://github.com/lbruton/StakTrakr" target="_blank" rel="noopener">github.com/lbruton/StakTrakr</a>. There is no hidden code.</p>
                    <p>The app loads several trusted third-party libraries (Chart.js, PapaParse, jsPDF, Bootstrap) from CDNs. These are industry-standard libraries used by millions of websites.</p>
                    <p>Like any web app, your device's security is part of the equation. Keep your browser and operating system updated, and be cautious about browser extensions that have broad permissions.</p>
                  </div>
                </details>
              </div>

              <!-- Section 2: Backups & Export -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">📦 Backups &amp; Export</div>

                <details class="faq-item">
                  <summary class="faq-question">How do I get my data out if I want to leave?</summary>
                  <div class="faq-answer">
                    <p>Your data is never locked in. You can export at any time in multiple formats:</p>
                    <ul class="faq-list">
                      <li><strong>CSV</strong> — opens in Excel, Google Sheets, or any spreadsheet app</li>
                      <li><strong>PDF</strong> — a formatted report for printing or archiving</li>
                      <li><strong>ZIP backup</strong> — a complete snapshot including settings, importable into any future StakTrakr install</li>
                      <li><strong>Encrypted vault (.stvault)</strong> — a password-protected backup file</li>
                    </ul>
                    <p>All export options are in the <strong>Inventory → Export</strong> menu.</p>
                  </div>
                </details>

                <details class="faq-item">
                  <summary class="faq-question">Will this app keep working in the future?</summary>
                  <div class="faq-answer">
                    <p>Yes. Because the app runs entirely in your browser with no server requirement, a downloaded copy will continue to work indefinitely — even without an internet connection — as long as browsers continue to support standard web APIs (localStorage, IndexedDB, JavaScript).</p>
                    <p>You can always save a ZIP of the app and open it locally. The app is designed from the ground up to work with the <code>file://</code> protocol.</p>
                  </div>
                </details>

                <details class="faq-item">
                  <summary class="faq-question">What if the developer stops maintaining it?</summary>
                  <div class="faq-answer">
                    <p>The app is MIT licensed and open source. If development stops, anyone in the community can fork the project and continue it. Your data remains yours in exportable formats regardless.</p>
                    <p>The offline-first, single-file design means the app won't simply stop working the way a subscription service would.</p>
                  </div>
                </details>
              </div>

              <!-- Section 3: Cloud Storage -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">☁️ Cloud Storage</div>

                <details class="faq-item">
                  <summary class="faq-question">If I use Dropbox, can Dropbox see my data?</summary>
                  <div class="faq-answer">
                    <p>No. When you use the cloud backup feature, your inventory is encrypted on your device before it is uploaded. Dropbox only ever receives an encrypted file — they cannot read what's inside it.</p>
                    <details class="faq-technical">
                      <summary>Technical details</summary>
                      <p>Encryption uses <strong>AES-256-GCM</strong> (symmetric authenticated encryption) with a key derived from your password via <strong>PBKDF2-SHA256 with 100,000 iterations</strong>. The encryption happens entirely in your browser using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API" target="_blank" rel="noopener">Web Crypto API</a> — the same cryptographic standard used by password managers and secure messaging apps. The cloud provider receives only the ciphertext and a random salt, never your password or plaintext data.</p>
                    </details>
                  </div>
                </details>

                <details class="faq-item">
                  <summary class="faq-question">What is encryption and how does it protect me?</summary>
                  <div class="faq-answer">
                    <p>Encryption transforms your data into unreadable scrambled text using a secret key derived from your password. Without the correct password, the data is mathematically impossible to read — even if someone intercepts the file or the cloud provider is breached.</p>
                    <p>Think of it like a safe deposit box: the bank (Dropbox) holds the box, but only you have the key. The bank has no way to open it.</p>
                    <p><strong>Important:</strong> If you lose your vault password, the data cannot be recovered. Store your password somewhere safe.</p>
                  </div>
                </details>
              </div>

              <!-- Section 4: Security -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">🛡️ Security</div>

                <details class="faq-item">
                  <summary class="faq-question">Is my data safe from hackers?</summary>
                  <div class="faq-answer">
                    <p>Your local data (in localStorage/IndexedDB) is protected by your browser's same-origin security model — other websites cannot read it. The vault encryption protects backups with strong cryptography.</p>
                    <p>The practical risks are the same as any local software:</p>
                    <ul class="faq-list">
                      <li>Malware on your device that can read browser storage</li>
                      <li>Browser extensions with broad permissions</li>
                      <li>Physical access to an unlocked device</li>
                    </ul>
                    <p>Standard device security hygiene — OS updates, reputable extensions only, device lock screens — provides strong protection.</p>
                  </div>
                </details>
              </div>

              <!-- Section 5: About the App -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">💡 About the App</div>

                <details class="faq-item">
                  <summary class="faq-question">How is this different from other precious metals apps?</summary>
                  <div class="faq-answer">
                    <p>Most precious metals apps store your data on their servers and require accounts. StakTrakr is different:</p>
                    <ul class="faq-list">
                      <li><strong>Fully local</strong> — your data never leaves your device unless you choose cloud backup</li>
                      <li><strong>No account required</strong> — no email, no password to create, no profile</li>
                      <li><strong>Open source</strong> — the code is publicly readable; there are no hidden behaviors</li>
                      <li><strong>No subscription</strong> — the core app is free forever; optional sponsor perks cover infrastructure costs</li>
                      <li><strong>Works offline</strong> — once loaded, the app works without internet (spot prices require connectivity)</li>
                      <li><strong>Portable</strong> — download a ZIP, open <code>index.html</code>, and it runs anywhere</li>
                    </ul>
                  </div>
                </details>

                <details class="faq-item">
                  <summary class="faq-question">Does this app have any subscriptions or costs?</summary>
                  <div class="faq-answer">
                    <p><strong>The core app is free and always will be.</strong> Every feature you see today — full inventory management, spot price sync, CSV/PDF/ZIP export, encrypted vault backups, Dropbox cloud sync, Numista/PCGS integration — is included with no account required and no paywall.</p>
                    <p>Running the app costs real money: the domain renewal, and the API provider that supplies hourly live spot prices for all users on a best-effort basis. Sponsoring at $1/month or more on GitHub helps cover those costs directly.</p>
                    <p>As a thank-you, sponsors will get access to <strong>optional infrastructure perks</strong> as they are built out:</p>
                    <ul class="faq-list">
                      <li><strong>Now:</strong> Dropbox cloud backup is free for everyone</li>
                      <li><strong>Coming for sponsors:</strong> a hosted cloud storage key (Supabase-backed) — same encryption guarantees as Dropbox, no third-party account needed</li>
                      <li><strong>Further out:</strong> early access to real-time encrypted cloud sync (live CRUD to the cloud, not just manual backup/restore), as the user base and infrastructure grows</li>
                    </ul>
                    <p>None of these are features being removed from the free tier — they are new infrastructure that costs money to operate. If sponsorship never materializes, the core app stays exactly as it is. If it grows, everyone benefits from a more sustainable project.</p>
                    <p>The hourly API spot prices are provided on a best-effort basis. If infrastructure costs become unsustainable, that service may be reduced — but the app itself, and Dropbox sync, will always remain free and open source.</p>
                  </div>
                </details>
              </div>

              <!-- Section 6: Honest Limitations -->
              <div class="settings-fieldset faq-limitations-section">
                <div class="settings-fieldset-title faq-limitations-title">⚖️ Honest Limitations</div>
                <p class="faq-limitations-intro">We believe in transparency. Here are real trade-offs you should know about.</p>

                <details class="faq-item">
                  <summary class="faq-question">localStorage can be cleared unexpectedly</summary>
                  <div class="faq-answer">
                    <p>Browser localStorage is not permanent storage. It can be cleared by:</p>
                    <ul class="faq-list">
                      <li>"Clear site data" or "Clear browsing data" in browser settings</li>
                      <li>Private/incognito browsing sessions (data is lost when the window closes)</li>
                      <li><strong>iOS Safari storage eviction</strong> — Apple may automatically delete localStorage for apps that haven't been used recently if the device is low on storage</li>
                    </ul>
                    <p><strong>Mitigation:</strong> Export a ZIP or vault backup regularly, especially on iOS. Consider connecting a cloud backup provider.</p>
                  </div>
                </details>

                <details class="faq-item">
                  <summary class="faq-question">Opening via file:// protocol on some browsers</summary>
                  <div class="faq-answer">
                    <p>The app is designed to work with the <code>file://</code> protocol (opening <code>index.html</code> directly from your filesystem). However, a small number of browser configurations restrict localStorage persistence in <code>file://</code> contexts.</p>
                    <p>If you experience data not persisting when opening the file directly, try serving it from a local web server (e.g., <code>python3 -m http.server</code>) or use the hosted version at staktrakr.com.</p>
                  </div>
                </details>

                <details class="faq-item">
                  <summary class="faq-question">No formal third-party security audit — but here's what we do run</summary>
                  <div class="faq-answer">
                    <p>StakTrakr is a one-person project. A paid independent cryptographic audit hasn't been commissioned — that's the honest limitation. But the codebase is not unreviewed. Every commit runs through a layered set of automated security and quality checks:</p>
                    <ul class="faq-list">
                      <li><strong>Codacy</strong> — continuous code quality gate, A+ rating maintained on every PR</li>
                      <li><strong>CodeQL</strong> — GitHub's semantic code analysis, scans for security vulnerabilities on every push</li>
                      <li><strong>Semgrep</strong> — static analysis for common security anti-patterns</li>
                      <li><strong>PMD</strong> — additional static analysis for code quality issues</li>
                      <li><strong>ESLint</strong> — JavaScript linting with security-aware rules</li>
                      <li><strong>GitHub Copilot &amp; Codex</strong> — AI-assisted code review on pull requests</li>
                    </ul>
                    <p>Development is also assisted by <strong>Claude Code</strong> (Anthropic's AI coding assistant), which is explicitly instructed to flag security concerns — SQL injection, XSS, insecure storage patterns, and similar issues — during implementation.</p>
                    <p>This is the realistic security posture of a well-maintained open-source personal project: comprehensive automated tooling, no paid human audit. For most users tracking a personal collection, this is a reasonable level of assurance. Users with very high threat models may wish to verify the encryption implementation themselves — the source is fully public.</p>
                  </div>
                </details>

                <details class="faq-item">
                  <summary class="faq-question">Only Dropbox is active — other cloud providers are coming soon</summary>
                  <div class="faq-answer">
                    <p><strong>Dropbox is the only fully active cloud backup provider.</strong> The Cloud tab in Settings also shows placeholder cards for four future providers: Google Drive, OneDrive, pCloud, and Box. These are shown to communicate the roadmap, not as functional options. All will use the same client-side AES-256-GCM encryption as Dropbox — the provider never sees your plaintext data.</p>
                  </div>
                </details>

                <details class="faq-item">
                  <summary class="faq-question">Spot prices are reference data, not transaction prices</summary>
                  <div class="faq-answer">
                    <p>The spot prices displayed are fetched from public metal pricing APIs and represent the theoretical melt value of metal at that moment. They are <strong>not</strong> buy/sell prices from a dealer.</p>
                    <p>Actual transaction prices will differ due to dealer premiums, bid/ask spreads, and market conditions. The "Melt Value" shown is a reference floor, not a guaranteed sale price.</p>
                  </div>
                </details>
              </div>

              <!-- Section 7: More Information -->
              <div class="settings-fieldset">
                <div class="settings-fieldset-title">📄 More Information</div>
                <div class="resources-grid">
                  <button class="resource-btn" onclick="if(window.openModalById)openModalById('privacyModal')">
                    🔒 Privacy Policy
                  </button>
                  <a class="resource-btn" href="https://github.com/lbruton/StakTrakr" target="_blank" rel="noopener">
                    📁 Source Code
                  </a>
                  <a class="resource-btn" href="https://www.reddit.com/r/staktrakr/" target="_blank" rel="noopener">
                    💬 Community
                  </a>
                </div>
              </div>

            </div><!-- #settingsPanel_faq -->

          </div><!-- .settings-content-area -->
        </div><!-- .settings-modal-layout -->
        <div class="settings-footer" id="settingsFooter"></div>
      </div><!-- .settings-modal-content -->
    </div><!-- #settingsModal -->

    <div class="modal" id="cloudSyncModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Cloud Sync</h2>
          <button
            aria-label="Close modal"
            class="modal-close"
            id="cloudSyncCloseBtn"
          >
            ×
          </button>
        </div>
        <div class="modal-body">
          ☁️ Feature coming soon ☁️
        </div>
      </div>
    </div>

    <!-- Vault Encrypted Backup Modal -->
    <div class="modal" id="vaultModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="vaultModalTitle">Encrypted Backup</h2>
          <button
            aria-label="Close modal"
            class="modal-close"
            id="vaultCloseBtn"
          >
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="encryption-info">
            <strong>Included:</strong> All inventory data, settings, API keys, and price history.
          </div>

          <div id="vaultFileInfo" class="encryption-info" style="display: none">
            <strong>File:</strong> <span id="vaultFileName"></span>
            (<span id="vaultFileSize"></span>)
          </div>

          <div class="form-row">
            <label for="vaultPassword">Password</label>
            <div class="password-input-group">
              <input
                type="password"
                id="vaultPassword"
                placeholder="Minimum 8 characters"
                autocomplete="off"
              />
              <button
                type="button"
                class="password-toggle"
                id="vaultPasswordToggle"
                title="Show/hide password"
              >&#9678;</button>
            </div>
          </div>

          <div id="vaultStrengthRow">
            <div class="strength-bar">
              <div class="strength-fill" id="vaultStrengthFill"></div>
            </div>
            <div class="strength-text" id="vaultStrengthText"></div>
          </div>

          <div class="form-row" id="vaultConfirmRow">
            <label for="vaultConfirmPassword">Confirm Password</label>
            <div class="password-input-group">
              <input
                type="password"
                id="vaultConfirmPassword"
                placeholder="Re-enter password"
                autocomplete="off"
              />
              <button
                type="button"
                class="password-toggle"
                id="vaultConfirmToggle"
                title="Show/hide password"
              >&#9678;</button>
            </div>
            <div class="password-match" id="vaultMatchIndicator"></div>
          </div>

          <div id="vaultStatus" class="encryption-status" style="display: none"></div>

          <div class="encryption-warning">
            <strong>Warning:</strong> If you forget this password, your backup cannot be recovered.
          </div>

          <div class="encryption-actions">
            <button class="btn" id="vaultActionBtn">Export</button>
            <button class="btn warning" id="vaultCancelBtn">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- STAK-149: Sync Password Modal -->
    <div class="modal" id="cloudSyncPasswordModal" style="display: none">
      <div class="modal-content" style="max-width: 400px">
        <div class="modal-header">
          <h2>Sync Password</h2>
          <button aria-label="Close modal" class="modal-close" id="syncPasswordCancelBtn">&times;</button>
        </div>
        <div class="modal-body">
          <p class="settings-subtext" style="margin-bottom:1rem">Enter your vault password to encrypt your inventory before syncing. This password never leaves your device.</p>
          <div class="password-input-group">
            <input type="password" id="syncPasswordInput" placeholder="Vault password" autocomplete="current-password" style="width:100%"/>
          </div>
          <div id="syncPasswordError" style="color:var(--danger);font-size:0.8rem;margin-top:0.4rem;display:none"></div>
          <div class="encryption-actions" style="margin-top:1rem">
            <button class="btn success" id="syncPasswordConfirmBtn">Encrypt &amp; Sync</button>
            <button class="btn" id="syncPasswordCancelBtn2">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- STAK-149: Cloud Auto-Sync Conflict Modal -->
    <div class="modal" id="cloudSyncConflictModal" style="display: none">
      <div class="modal-content" style="max-width: 520px">
        <div class="modal-header">
          <h2>Sync Conflict</h2>
          <button aria-label="Close modal" class="modal-close" id="syncConflictSkip">&times;</button>
        </div>
        <div class="modal-body">
          <p class="settings-subtext" style="margin-bottom:1rem">Both this device and another device have changes since the last sync. Choose which version to keep.</p>
          <div class="cloud-conflict-grid">
            <div class="cloud-conflict-col">
              <div class="cloud-conflict-col-label">This Device</div>
              <div class="cloud-conflict-row"><span>Items</span><strong id="syncConflictLocalItems">&mdash;</strong></div>
              <div class="cloud-conflict-row"><span>Changed</span><strong id="syncConflictLocalTime">&mdash;</strong></div>
              <div class="cloud-conflict-row"><span>Version</span><strong id="syncConflictLocalVersion">&mdash;</strong></div>
            </div>
            <div class="cloud-conflict-divider">vs</div>
            <div class="cloud-conflict-col">
              <div class="cloud-conflict-col-label">Remote (another device)</div>
              <div class="cloud-conflict-row"><span>Items</span><strong id="syncConflictRemoteItems">&mdash;</strong></div>
              <div class="cloud-conflict-row"><span>Changed</span><strong id="syncConflictRemoteTime">&mdash;</strong></div>
              <div class="cloud-conflict-row"><span>Version</span><strong id="syncConflictRemoteVersion">&mdash;</strong></div>
              <div class="cloud-conflict-row"><span>Device</span><strong id="syncConflictRemoteDevice">&mdash;</strong></div>
            </div>
          </div>
          <div class="encryption-warning" style="margin-top:1rem">
            <strong>Note:</strong> The losing version will be overwritten and cannot be recovered.
          </div>
          <div class="encryption-actions" style="margin-top:1rem;gap:0.5rem;flex-wrap:wrap">
            <button class="btn success" id="syncConflictKeepMine">Keep Mine (push local)</button>
            <button class="btn info" id="syncConflictKeepTheirs">Keep Theirs (pull remote)</button>
            <button class="btn" id="syncConflictSkipBtn" onclick="document.getElementById('cloudSyncConflictModal').style.display='none'">Skip for now</button>
          </div>
        </div>
      </div>
    </div>

    <!-- STAK-149: Cloud Auto-Sync Update Available Modal -->
    <div class="modal" id="cloudSyncUpdateModal" style="display: none">
      <div class="modal-content" style="max-width: 420px">
        <div class="modal-header">
          <h2>Sync Update Available</h2>
          <button aria-label="Close modal" class="modal-close" id="syncUpdateDismissX">&times;</button>
        </div>
        <div class="modal-body">
          <p class="settings-subtext" style="margin-bottom:1rem">Another device has pushed a newer version of your inventory. Would you like to update now?</p>
          <div class="cloud-sync-update-meta">
            <div class="cloud-sync-update-row"><span>Items</span><strong id="syncUpdateItemCount">&mdash;</strong></div>
            <div class="cloud-sync-update-row"><span>Updated</span><strong id="syncUpdateTimestamp">&mdash;</strong></div>
            <div class="cloud-sync-update-row"><span>Device</span><strong id="syncUpdateDevice">&mdash;</strong></div>
          </div>
          <div class="encryption-actions" style="margin-top:1.2rem;gap:0.5rem;flex-wrap:wrap">
            <button class="btn success" id="syncUpdateAcceptBtn">Accept Update</button>
            <button class="btn" id="syncUpdateDismissBtn">Not Now</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="apiQuotaModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>API Quota</h2>
          <button
            aria-label="Close modal"
            class="modal-close"
            id="apiQuotaCloseBtn"
          >
            ×
          </button>
        </div>
        <div class="modal-body" style="text-align: center">
          <label for="apiQuotaInput">Monthly quota:</label>
          <input type="number" id="apiQuotaInput" min="1" />
          <div style="margin-top: 1rem">
            <button class="btn" id="apiQuotaSaveBtn">Save</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="apiInfoModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="apiInfoTitle">Provider Information</h3>
          <button aria-label="Close modal" class="modal-close" id="apiInfoCloseBtn">×</button>
        </div>
        <div class="modal-body">
          <div id="apiInfoBody" class="api-info-body"></div>
        </div>
      </div>
    </div>
    <div class="modal" id="apiHistoryModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Metals Price History</h2>
          <button
            aria-label="Close modal"
            class="modal-close"
            id="apiHistoryCloseBtn"
          >
            ×
          </button>
        </div>
        <div class="modal-body">
          <div class="api-history-body">
            <div class="api-history-table">
              <div class="api-history-filter">
                <input
                  type="text"
                  id="apiHistoryFilter"
                  placeholder="Filter history..."
                />
                <button
                  type="button"
                  class="btn secondary"
                  id="apiHistoryClearFilterBtn"
                >
                  Clear
                </button>
              </div>
              <div class="api-history-table-wrapper">
                <table id="apiHistoryTable"></table>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer api-history-footer">
          <button type="button" class="btn" id="exportSpotHistoryBtn">Export History</button>
          <button type="button" class="btn" id="importSpotHistoryBtn">Import History</button>
          <input type="file" id="importSpotHistoryFile" accept=".csv,.json" style="display:none">
        </div>
      </div>
    </div>

    <!-- =============================================================================
       GOLDBACK PRICE HISTORY MODAL (STACK-45)

       Modal for viewing Goldback denomination price history.
       Mirrors the apiHistoryModal structure with sortable/filterable table.
       ============================================================================= -->
    <div class="modal" id="goldbackHistoryModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Goldback Price History</h2>
          <button
            aria-label="Close modal"
            class="modal-close"
            id="goldbackHistoryCloseBtn"
          >
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="api-history-body">
            <div class="api-history-table">
              <div class="api-history-filter">
                <input
                  type="text"
                  id="goldbackHistoryFilter"
                  placeholder="Filter history..."
                />
                <button
                  type="button"
                  class="btn secondary"
                  id="goldbackHistoryClearFilterBtn"
                >
                  Clear
                </button>
              </div>
              <div class="api-history-table-wrapper">
                <table id="goldbackHistoryTable"></table>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer api-history-footer">
          <button type="button" class="btn" id="exportGoldbackHistoryBtn">Export History</button>
        </div>
      </div>
    </div>

    <!-- =============================================================================
       ITEM PRICE HISTORY MODAL

       Per-item price history viewer with inline delete capability.
       Opens from the Retail Price field icon in the edit modal (STAK-109).
       Stacks above the edit modal (z-index: 10000).
       ============================================================================= -->
    <div class="modal" id="itemPriceHistoryModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="itemPriceHistoryTitle">Item Price History</h2>
          <button
            aria-label="Close modal"
            class="modal-close"
            id="itemPriceHistoryCloseBtn"
          >
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="api-history-body">
            <div class="api-history-table">
              <div class="api-history-filter">
                <input
                  type="text"
                  id="itemPriceHistoryFilter"
                  placeholder="Filter history..."
                />
                <button
                  type="button"
                  class="btn secondary"
                  id="itemPriceHistoryClearFilterBtn"
                >
                  Clear
                </button>
              </div>
              <div class="api-history-table-wrapper">
                <table id="itemPriceHistoryTable">
                  <thead>
                    <tr>
                      <th>Timestamp</th>
                      <th>Retail</th>
                      <th>Spot</th>
                      <th>Melt</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- =============================================================================
       CATALOG HISTORY MODAL

       Modal for viewing catalog API call history (Numista lookups, searches).
       Mirrors the apiHistoryModal structure with sortable/filterable table.
       ============================================================================= -->
    <div class="modal" id="catalogHistoryModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Catalog API History</h2>
          <button
            aria-label="Close modal"
            class="modal-close"
            id="catalogHistoryCloseBtn"
          >
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="api-history-body">
            <div class="api-history-table">
              <div class="api-history-filter">
                <input
                  type="text"
                  id="catalogHistoryFilter"
                  placeholder="Filter history..."
                />
                <button
                  type="button"
                  class="btn secondary"
                  id="catalogHistoryClearFilterBtn"
                >
                  Clear
                </button>
              </div>
              <div class="api-history-table-wrapper">
                <table id="catalogHistoryTable"></table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Numista pages open in a popup window (X-Frame-Options blocks iframes) -->

    <!-- =============================================================================
       NUMISTA RESULTS MODAL

       Stacked modal (z-index 10000) that appears over the item Add/Edit form.
       Shows search results from Numista API and a field picker to fill form fields.
       ============================================================================= -->
    <div class="modal" id="numistaResultsModal" style="display: none">
      <div class="modal-content numista-results-modal-content">
        <div class="modal-header">
          <h2 id="numistaResultsTitle">Numista Results</h2>
          <button aria-label="Close modal" class="modal-close" id="numistaResultsCloseBtn">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Search results list -->
          <div id="numistaResultsList" class="numista-results-list"></div>

          <!-- Field picker (hidden until a result is selected) -->
          <div id="numistaFieldPicker" class="numista-field-picker" style="display: none">
            <div id="numistaSelectedItem" class="numista-selected-preview"></div>
            <div id="numistaFieldCheckboxes" class="numista-field-checkboxes">
              <div class="numista-fields-heading">Fields to fill:</div>
              <!-- Populated dynamically with value previews by catalog-api.js -->
            </div>
            <div class="numista-fill-actions">
              <button class="btn" id="numistaFillCancelBtn" type="button">Cancel</button>
              <button class="btn premium" id="numistaFillBtn" type="button">Fill Fields</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- =============================================================================
       PCGS FIELD PICKER MODAL

       Stacked modal (z-index 10000) that appears over the item Add/Edit form.
       Shows the PCGS lookup result with images and a field picker to fill form fields.
       ============================================================================= -->
    <div class="modal" id="pcgsFieldPickerModal" style="display: none">
      <div class="modal-content numista-results-modal-content">
        <div class="modal-header">
          <h2 id="pcgsFieldPickerTitle">PCGS Item Found</h2>
          <button aria-label="Close modal" class="modal-close" id="pcgsFieldPickerCloseBtn">&times;</button>
        </div>
        <div class="modal-body">
          <div id="pcgsSelectedItem" class="numista-selected-preview"></div>
          <div id="pcgsFieldCheckboxes" class="numista-field-checkboxes">
            <div class="numista-fields-heading">Fields to fill:</div>
          </div>
          <div class="numista-fill-actions">
            <button class="btn" id="pcgsFillCancelBtn" type="button">Cancel</button>
            <button class="btn premium" id="pcgsFillBtn" type="button">Fill Fields</button>
          </div>
        </div>
      </div>
    </div>

    <!-- =============================================================================
       SPOT LOOKUP MODAL (STACK-49)

       Stacked modal (z-index 10000) that appears over the item Add/Edit form.
       Shows historical spot prices near the purchase date for the selected metal.
       ============================================================================= -->
    <div class="modal" id="spotLookupModal" style="display: none">
      <div class="modal-content numista-results-modal-content">
        <div class="modal-header">
          <h2 id="spotLookupTitle">Spot Price Lookup</h2>
          <button aria-label="Close modal" class="modal-close" id="spotLookupCloseBtn">&times;</button>
        </div>
        <div class="modal-body" id="spotLookupBody">
        </div>
      </div>
    </div>

    <!-- =============================================================================
       VIEW ITEM MODAL

       Card-style showcase for viewing a single inventory item with coin images,
       inventory data, valuation, grading, and Numista enrichment data.
       Gated behind COIN_IMAGES feature flag.
       ============================================================================= -->
    <div class="modal" id="viewItemModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <div class="view-header-left">
            <h2 id="viewModalTitle"></h2>
            <div class="view-header-badges">
              <span class="view-modal-catalog-id" id="viewModalCatalogId"></span>
              <span class="view-modal-count-chip" id="viewModalCountChip"></span>
            </div>
          </div>
          <div class="view-header-actions" id="viewHeaderActions"></div>
        </div>
        <div class="modal-body" id="viewModalBody"></div>
      </div>
    </div>

    <!-- =============================================================================
       DEBUG LOG MODAL

       Displays collected debug output when debug mode is enabled.
       ============================================================================= -->
    <div class="modal" id="debugModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Debug Log</h2>
          <button aria-label="Close modal" class="modal-close" id="debugCloseBtn">×</button>
        </div>
        <div class="modal-body">
          <pre id="debugModalContent"></pre>
        </div>
      </div>
    </div>

    <!-- =============================================================================
       BULK EDIT MODAL

       Full-screen modal for multi-item editing, copying, and deletion.
       ============================================================================= -->
    <div class="modal" id="bulkEditModal" style="display: none">
      <div class="modal-content bulk-edit-content">
        <div class="modal-header">
          <h2>Bulk Edit</h2>
          <button aria-label="Close modal" class="modal-close" id="bulkEditCloseBtn">&times;</button>
        </div>
        <div class="modal-body bulk-edit-body">
          <!-- Left: Field panel -->
          <div class="bulk-edit-fields" id="bulkEditFieldPanel"></div>
          <!-- Right: Item selection table -->
          <div class="bulk-edit-items">
            <div class="bulk-edit-toolbar" id="bulkEditToolbar"></div>
            <div class="bulk-edit-table-wrap" id="bulkEditTableWrap"></div>
          </div>
        </div>
        <div class="modal-footer bulk-edit-footer" id="bulkEditFooter"></div>
      </div>
    </div>

    <!-- Bulk Edit inline confirmation (replaces window.confirm suppressed by modal context) -->
    <div class="modal" id="bulkConfirmModal" style="display: none; z-index: 10050">
      <div class="modal-content" style="max-width: 380px">
        <div class="modal-header">
          <h2>Confirm</h2>
        </div>
        <div class="modal-body">
          <p id="bulkConfirmMessage" style="margin: 0 0 1.2rem"></p>
          <div class="encryption-actions" style="gap: 0.5rem">
            <button class="btn btn-danger" id="bulkConfirmOkBtn">Confirm</button>
            <button class="btn" id="bulkConfirmCancelBtn">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div class="modal" id="privacyModal" style="display: none">
      <div class="modal-content" style="max-width:760px">
        <div class="modal-header">
          <h3>Privacy Policy</h3>
          <button aria-label="Close modal" class="modal-close" onclick="if(window.closeModalById)closeModalById('privacyModal');else this.closest('.modal').style.display='none';">&times;</button>
        </div>
        <div class="modal-body" style="padding:1rem 1.5rem;overflow-y:auto;max-height:70vh">

          <!-- Overview -->
          <div class="about-section">
            <div class="section-title">🏠 Overview</div>
            <p style="font-size:0.95rem;line-height:1.6">StakTrakr is a client-side web application for tracking precious metals inventory. Your data stays on your device — we do not operate servers that store user data. <em>Last updated: February 17, 2026.</em></p>
          </div>

          <!-- Your Data -->
          <div class="about-section">
            <div class="section-title">💾 Your Data</div>

            <details class="faq-item">
              <summary class="faq-question">Where is my data stored?</summary>
              <div class="faq-answer">
                <p>All inventory data, settings, and preferences are stored locally in your browser using <strong>localStorage</strong> and <strong>IndexedDB</strong> (for images). Nothing is transmitted to StakTrakr servers.</p>
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-question">Can this data be lost?</summary>
              <div class="faq-answer">
                <p>Browser localStorage is not permanent storage. It can be cleared by browser settings, private/incognito sessions, or on iOS if the device is low on storage and the app hasn't been used recently.</p>
                <p><strong>Recommendation:</strong> Export a ZIP or vault backup regularly, especially on iOS. Consider connecting a cloud backup provider.</p>
              </div>
            </details>
          </div>

          <!-- Cloud Backup -->
          <div class="about-section">
            <div class="section-title">☁️ Cloud Backup</div>

            <details class="faq-item">
              <summary class="faq-question">What happens when I connect Dropbox, pCloud, or Box?</summary>
              <div class="faq-answer">
                <p>StakTrakr will request authorization to read and write files in a <code>/StakTrakr/</code> folder on your account. It stores an OAuth access token in your browser's localStorage to maintain the connection. StakTrakr does not access any other files in your cloud storage account.</p>
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-question">Can my cloud provider read my data?</summary>
              <div class="faq-answer">
                <p>No. Your backup is encrypted on your device with <strong>AES-256-GCM</strong> before it is uploaded. The cloud provider receives only ciphertext and a random salt — never your password or plaintext data. The key is derived from your password via PBKDF2-SHA256 with 100,000 iterations using the browser's <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API" target="_blank" rel="noopener">Web Crypto API</a>.</p>
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-question">How do I disconnect?</summary>
              <div class="faq-answer">
                <p>You can disconnect at any time in <strong>Settings → Cloud</strong>. Disconnecting removes the stored OAuth token from your browser. Your cloud files are not automatically deleted — you can remove them manually from your cloud provider's file manager.</p>
              </div>
            </details>
          </div>

          <!-- Third-Party APIs -->
          <div class="about-section">
            <div class="section-title">🔌 Third-Party APIs</div>

            <details class="faq-item">
              <summary class="faq-question">What external services does StakTrakr contact?</summary>
              <div class="faq-answer">
                <p>StakTrakr may contact external services for spot price data, exchange rates, and catalog lookups. These requests contain no personal information — only metal type or coin identifiers. No cookies or tracking identifiers are sent. Specific services include:</p>
                <ul class="faq-list">
                  <li>Public metal pricing APIs (spot prices)</li>
                  <li>Open Exchange Rates (currency conversion)</li>
                  <li>Numista &amp; PCGS APIs (coin catalog lookups, when you use those features)</li>
                  <li><code>staktrakr.com/version.json</code> (version update check)</li>
                </ul>
              </div>
            </details>
          </div>

          <!-- Analytics & Tracking -->
          <div class="about-section">
            <div class="section-title">📊 Analytics &amp; Tracking</div>

            <details class="faq-item">
              <summary class="faq-question">Does the app track me?</summary>
              <div class="faq-answer">
                <p>No. The app itself does not use analytics, tracking pixels, fingerprinting, or advertising of any kind. There are no third-party scripts embedded in the app that collect user behavior.</p>
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-question">What about the hosted version at staktrakr.com?</summary>
              <div class="faq-answer">
                <p>When you use the hosted version at staktrakr.com (served via Cloudflare Pages), <a href="https://www.cloudflare.com/web-analytics/" target="_blank" rel="noopener">Cloudflare Web Analytics</a> is active at the network edge. It collects aggregated, anonymous page-view metrics (visit counts, countries, browser types) <strong>without cookies</strong> and without building individual user profiles. No inventory data is ever included. If you run the app locally from a downloaded ZIP, no analytics run at all.</p>
              </div>
            </details>
          </div>

          <!-- Cookies -->
          <div class="about-section">
            <div class="section-title">🍪 Cookies</div>
            <p style="font-size:0.95rem;line-height:1.6">StakTrakr does not set cookies. OAuth providers may set their own cookies during the authorization flow in the popup window. Cloudflare Web Analytics does not use cookies.</p>
          </div>

          <!-- Children -->
          <div class="about-section">
            <div class="section-title">👶 Children</div>
            <p style="font-size:0.95rem;line-height:1.6">StakTrakr is not directed at children under 13 and does not knowingly collect information from children.</p>
          </div>

          <!-- Changes & Contact -->
          <div class="about-section">
            <div class="section-title">📝 Changes &amp; Contact</div>
            <p style="font-size:0.95rem;line-height:1.6">If this policy changes, the updated version will appear in the app with a new date. Questions about this policy can be directed to the project's <a href="https://github.com/lbruton/StakTrakr/issues" target="_blank" rel="noopener">GitHub Issues</a> page.</p>
          </div>

        </div>
      </div>
    </div>

    <!-- =============================================================================
       JAVASCRIPT MODULE LOADING

       Modular architecture with proper dependency order:
       1. constants.js - Global configuration and version
       2. state.js - Application state and DOM element caching
       3. utils.js - Utility functions and formatters
       4. Feature modules - charts, theme, search, sorting, portal view, etc.
       5. Core modules - spot price management and inventory operations
       6. events.js - Event listener setup (requires all other modules)
       7. init.js - Application initialization and startup
       
       All scripts use 'defer' to ensure DOM is ready before execution
       External libraries (Chart.js, jsPDF, PapaParse, JSZip) loaded via CDN
       ============================================================================= -->

  <script defer src="js/debug-log.js"></script>
  <script defer src="./js/constants.js"></script>
  <script defer src="./js/state.js"></script>
  <script defer src="./js/utils.js"></script>
  <script defer src="./js/dialogs.js"></script>
  <script defer src="./js/image-processor.js"></script>
  <script defer src="./js/image-cache.js"></script>
  <script defer src="./js/bulk-image-cache.js"></script>
  <script defer src="./js/image-cache-modal.js"></script>
  <script defer src="./js/fuzzy-search.js"></script>
  <script defer src="./js/autocomplete.js"></script>
  <script defer src="./js/numista-lookup.js"></script>
  <script defer src="./js/seed-images.js"></script>
  <script defer src="./js/versionCheck.js"></script>
  <script defer src="./js/changeLog.js"></script>
    <script defer src="./js/charts.js"></script>
    <script defer src="./js/theme.js"></script>
    <script defer src="./js/search.js"></script>
    <script defer src="./js/chip-grouping.js"></script>
    <script defer src="./js/tags.js"></script>
    <script defer src="./js/filters.js"></script>
    <script defer src="./js/sorting.js"></script>
    <script defer src="./js/pagination.js"></script>
    <script defer src="./js/detailsModal.js"></script>
    <script defer src="./js/viewModal.js"></script>
    <script defer src="./js/debugModal.js"></script>
    <script defer src="./js/numista-modal.js"></script>
    <script defer src="./js/spot.js"></script>
    <script defer src="./data/spot-history-bundle.js"></script>
    <script defer src="./js/seed-data.js"></script>
    <script defer src="./js/priceHistory.js"></script>
    <script defer src="./js/spotLookup.js"></script>
    <script defer src="./js/goldback.js"></script>
    <script defer src="./js/retail.js"></script>
    <script defer src="./js/retail-view-modal.js"></script>
    <script defer src="./js/api.js"></script>
    <script defer src="./js/catalog-api.js"></script>
    <script defer src="./js/pcgs-api.js"></script>
    <script defer src="./js/catalog-providers.js"></script>
    <script defer src="./js/catalog-manager.js"></script>
    <script defer src="./js/inventory.js"></script>
    <script defer src="./js/card-view.js"></script>
    <script defer src="./js/vault.js"></script>
    <script defer src="./js/cloud-storage.js"></script>
    <script defer src="./js/cloud-sync.js"></script>
    <script defer src="./js/about.js"></script>
    <script defer src="./js/faq.js"></script>
    <script defer src="./js/customMapping.js"></script>
    <script defer src="./js/settings.js"></script>
    <script defer src="./js/settings-listeners.js"></script>
    <script defer src="./js/bulkEdit.js"></script>
    <script defer src="./js/events.js"></script>
    
    <!-- Test Scripts (Development) -->
    <script defer src="./js/test-loader.js"></script>

    <script defer src="./js/init.js"></script>

    <!-- Back to top floating button -->
    <button id="backToTopBtn" class="back-to-top" title="Back to top" aria-label="Scroll to top">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="18 15 12 9 6 15"/>
      </svg>
    </button>

    <!-- PROTOTYPE: STAK-144 — sync Settings card style dropdown with view toggle on open -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        var modal = document.getElementById('settingsModal');
        if (modal) {
          new MutationObserver(function () {
            if (modal.classList.contains('show')) {
              // Reflect current style (A/B/C/D) in settings card style dropdown
              // D is not in the dropdown; for D mode show nothing selected / keep last
              var cur = localStorage.getItem('cardViewStyle') || 'A';
              var sel = document.getElementById('settingsCardStyle');
              if (sel && cur !== 'D') sel.value = cur;
            }
          }).observe(modal, { attributes: true, attributeFilter: ['class'] });
        }
      });
    </script>

  <!-- ===== RETAIL VIEW MODAL ===== -->
  <div id="retailViewModal" class="modal-overlay" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="retailViewCoinName">
    <div class="modal-container modal-lg">
      <div class="modal-header">
        <div class="modal-title-group">
          <h2 id="retailViewCoinName" class="modal-title"></h2>
          <div class="modal-subtitle-row">
            <span id="retailViewModalSubtitle" class="modal-subtitle-text"></span>
          </div>
        </div>
        <button class="modal-close-btn" onclick="closeRetailViewModal()" aria-label="Close market price detail">&times;</button>
      </div>
      <div class="modal-body">
        <h3 class="retail-view-section-title">Current Prices</h3>
        <div class="retail-view-table-wrap">
          <table id="retailViewPricesTable" class="retail-view-table">
            <thead>
              <tr><th>Vendor</th><th>Price</th><th>Confidence</th></tr>
            </thead>
            <tbody id="retailViewCurrentTableBody"></tbody>
          </table>
        </div>
        <h3 class="retail-view-section-title">Price History</h3>
        <div class="retail-view-chart-wrap">
          <canvas id="retailViewChart" aria-label="Retail price history chart"></canvas>
        </div>
        <div class="retail-view-table-wrap">
          <table id="retailViewHistoryTable" class="retail-view-table">
            <thead>
              <tr>
                <th>Date</th><th>Avg</th><th>Median</th><th>Lowest</th>
                <th>APMEX</th><th>Monument</th><th>SDB</th><th>JM</th>
              </tr>
            </thead>
            <tbody id="retailViewHistoryTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  </body>
</html>
