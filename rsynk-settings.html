<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rSynk Settings - StackTrackr AI Enhancement</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
        }
        
        .section h2 {
            margin: 0 0 15px 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-online {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }
        
        .status-offline {
            background: #f44336;
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.3);
        }
        
        .status-pending {
            background: #ff9800;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .setting-row:last-child {
            border-bottom: none;
        }
        
        .setting-label {
            flex: 1;
        }
        
        .setting-label h3 {
            margin: 0 0 5px 0;
            color: #333;
        }
        
        .setting-label p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }
        
        .setting-control {
            flex: 0 0 auto;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: #4CAF50;
        }
        
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }
        
        .input-control {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            width: 150px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 0;
        }
        
        .stat-label {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 0.9em;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .log-entry {
            margin: 2px 0;
            white-space: pre-wrap;
        }
        
        .log-timestamp {
            color: #569cd6;
        }
        
        .log-level-info {
            color: #4ec9b0;
        }
        
        .log-level-warn {
            color: #dcdcaa;
        }
        
        .log-level-error {
            color: #f44747;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            border-top: 1px solid #e0e0e0;
        }
        
        .footer a {
            color: #667eea;
            text-decoration: none;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .alert-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            color: #1976d2;
        }
        
        .alert-warning {
            background: #fff3e0;
            border: 1px solid #ff9800;
            color: #f57c00;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç rSynk Settings</h1>
            <p>AI-Powered Search Enhancement for StackTrackr</p>
        </div>
        
        <div class="content">
            <!-- Status Section -->
            <div class="section">
                <h2>
                    <span class="status-indicator" id="rsynk-status-indicator"></span>
                    Connection Status
                </h2>
                
                <div class="setting-row">
                    <div class="setting-label">
                        <h3 id="status-text">Checking connection...</h3>
                        <p id="status-details">Testing rSynk server availability</p>
                    </div>
                    <div class="setting-control">
                        <button class="btn btn-secondary" id="test-connection-btn">
                            üîÑ Test Connection
                        </button>
                    </div>
                </div>
                
                <div class="stats-grid" id="stats-grid" style="display: none;">
                    <div class="stat-item">
                        <div class="stat-value" id="stat-total-requests">0</div>
                        <div class="stat-label">Total Requests</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-success-rate">0%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-cache-size">0</div>
                        <div class="stat-label">Cached Results</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-server-response">0ms</div>
                        <div class="stat-label">Response Time</div>
                    </div>
                </div>
            </div>
            
            <!-- Main Settings -->
            <div class="section">
                <h2>‚öôÔ∏è AI Enhancement Settings</h2>
                
                <div class="setting-row">
                    <div class="setting-label">
                        <h3>Enable rSynk</h3>
                        <p>Use AI-powered search enhancement from rSynk server</p>
                    </div>
                    <div class="setting-control">
                        <div class="toggle-switch" id="enable-rsynk-toggle">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
                
                <div class="setting-row">
                    <div class="setting-label">
                        <h3>Local AI Fallback</h3>
                        <p>Use local AI when rSynk server is unavailable</p>
                    </div>
                    <div class="setting-control">
                        <div class="toggle-switch active" id="fallback-local-toggle">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
                
                <div class="setting-row">
                    <div class="setting-label">
                        <h3>Cache Results</h3>
                        <p>Cache AI results for 30 minutes to improve performance</p>
                    </div>
                    <div class="setting-control">
                        <div class="toggle-switch active" id="cache-results-toggle">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
                
                <div class="setting-row">
                    <div class="setting-label">
                        <h3>Debug Mode</h3>
                        <p>Show detailed logging and debug information</p>
                    </div>
                    <div class="setting-control">
                        <div class="toggle-switch" id="debug-mode-toggle">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Performance Settings -->
            <div class="section">
                <h2>‚ö° Performance Settings</h2>
                
                <div class="setting-row">
                    <div class="setting-label">
                        <h3>Request Timeout</h3>
                        <p>Maximum time to wait for rSynk response (milliseconds)</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="input-control" id="timeout-input" value="2000" min="500" max="10000" step="500">
                    </div>
                </div>
                
                <div class="setting-row">
                    <div class="setting-label">
                        <h3>Rate Limit</h3>
                        <p>Maximum requests per minute to prevent abuse</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="input-control" id="rate-limit-input" value="60" min="10" max="300" step="10">
                    </div>
                </div>
                
                <div class="setting-row">
                    <div class="setting-label">
                        <h3>Server URL</h3>
                        <p>rSynk server endpoint for production use</p>
                    </div>
                    <div class="setting-control">
                        <input type="url" class="input-control" id="server-url-input" value="https://rsynk.your-domain.com" style="width: 250px;">
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="section">
                <h2>üîß Actions</h2>
                
                <div class="setting-row">
                    <div class="setting-label">
                        <h3>Clear Cache</h3>
                        <p>Remove all cached AI results and start fresh</p>
                    </div>
                    <div class="setting-control">
                        <button class="btn btn-secondary" id="clear-cache-btn">
                            üóëÔ∏è Clear Cache
                        </button>
                    </div>
                </div>
                
                <div class="setting-row">
                    <div class="setting-label">
                        <h3>Reset Settings</h3>
                        <p>Restore all settings to default values</p>
                    </div>
                    <div class="setting-control">
                        <button class="btn btn-secondary" id="reset-settings-btn">
                            ‚Ü∫ Reset to Defaults
                        </button>
                    </div>
                </div>
                
                <div class="setting-row">
                    <div class="setting-label">
                        <h3>Export Logs</h3>
                        <p>Download debug logs for troubleshooting</p>
                    </div>
                    <div class="setting-control">
                        <button class="btn btn-secondary" id="export-logs-btn">
                            üì• Export Logs
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Debug Console -->
            <div class="section" id="debug-section" style="display: none;">
                <h2>üêõ Debug Console</h2>
                <p>Real-time logging and debugging information</p>
                
                <div class="log-container" id="debug-console">
                    <div class="log-entry">
                        <span class="log-timestamp">[00:00:00]</span>
                        <span class="log-level-info">[INFO]</span>
                        rSynk settings panel initialized
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" id="clear-logs-btn">
                        üßπ Clear Logs
                    </button>
                </div>
            </div>
            
            <!-- Information -->
            <div class="alert alert-info">
                <strong>üí° About rSynk:</strong> rSynk is an AI-powered search enhancement system that uses local Large Language Models to understand your precious metals queries better. It provides more intelligent search results by understanding context, handling abbreviations, and suggesting relevant items.
            </div>
            
            <div class="alert alert-warning" id="server-warning" style="display: none;">
                <strong>‚ö†Ô∏è Server Required:</strong> rSynk requires a running server instance. Please ensure your rSynk server is deployed and accessible before enabling AI enhancement.
            </div>
        </div>
        
        <div class="footer">
            <p>rSynk v1.0.0 | Part of the <a href="#">rEngine Ecosystem</a></p>
            <p>Powered by StackTrackr AI Enhancement Platform</p>
        </div>
    </div>

    <script>
        // Initialize settings panel
        class rSynkSettingsPanel {
            constructor() {
                this.logs = [];
                this.initializeUI();
                this.loadSettings();
                this.bindEvents();
                this.startStatusCheck();
                this.log('info', 'rSynk settings panel initialized');
            }
            
            initializeUI() {
                // Get UI elements
                this.elements = {
                    statusIndicator: document.getElementById('rsynk-status-indicator'),
                    statusText: document.getElementById('status-text'),
                    statusDetails: document.getElementById('status-details'),
                    statsGrid: document.getElementById('stats-grid'),
                    
                    // Toggles
                    enableToggle: document.getElementById('enable-rsynk-toggle'),
                    fallbackToggle: document.getElementById('fallback-local-toggle'),
                    cacheToggle: document.getElementById('cache-results-toggle'),
                    debugToggle: document.getElementById('debug-mode-toggle'),
                    
                    // Inputs
                    timeoutInput: document.getElementById('timeout-input'),
                    rateLimitInput: document.getElementById('rate-limit-input'),
                    serverUrlInput: document.getElementById('server-url-input'),
                    
                    // Buttons
                    testConnectionBtn: document.getElementById('test-connection-btn'),
                    clearCacheBtn: document.getElementById('clear-cache-btn'),
                    resetSettingsBtn: document.getElementById('reset-settings-btn'),
                    exportLogsBtn: document.getElementById('export-logs-btn'),
                    clearLogsBtn: document.getElementById('clear-logs-btn'),
                    
                    // Debug
                    debugSection: document.getElementById('debug-section'),
                    debugConsole: document.getElementById('debug-console'),
                    serverWarning: document.getElementById('server-warning')
                };
            }
            
            loadSettings() {
                // Load settings from localStorage or use defaults
                const settings = this.getStoredSettings();
                
                this.setToggle(this.elements.enableToggle, settings.enabled);
                this.setToggle(this.elements.fallbackToggle, settings.fallbackToLocal);
                this.setToggle(this.elements.cacheToggle, settings.cacheResults);
                this.setToggle(this.elements.debugToggle, settings.debugMode);
                
                this.elements.timeoutInput.value = settings.timeout;
                this.elements.rateLimitInput.value = settings.maxRequestsPerMinute;
                this.elements.serverUrlInput.value = settings.serverUrl;
                
                // Show/hide debug section
                this.toggleDebugSection(settings.debugMode);
            }
            
            getStoredSettings() {
                const defaults = {
                    enabled: false,
                    fallbackToLocal: true,
                    cacheResults: true,
                    debugMode: false,
                    timeout: 2000,
                    maxRequestsPerMinute: 60,
                    serverUrl: 'https://rsynk.your-domain.com'
                };
                
                try {
                    const stored = localStorage.getItem('rsynk_settings');
                    return stored ? {...defaults, ...JSON.parse(stored)} : defaults;
                } catch (error) {
                    this.log('warn', 'Failed to load stored settings, using defaults');
                    return defaults;
                }
            }
            
            saveSettings() {
                const settings = {
                    enabled: this.elements.enableToggle.classList.contains('active'),
                    fallbackToLocal: this.elements.fallbackToggle.classList.contains('active'),
                    cacheResults: this.elements.cacheToggle.classList.contains('active'),
                    debugMode: this.elements.debugToggle.classList.contains('active'),
                    timeout: parseInt(this.elements.timeoutInput.value),
                    maxRequestsPerMinute: parseInt(this.elements.rateLimitInput.value),
                    serverUrl: this.elements.serverUrlInput.value.trim()
                };
                
                try {
                    localStorage.setItem('rsynk_settings', JSON.stringify(settings));
                    this.log('info', 'Settings saved successfully');
                    
                    // Update rSynk instance if available
                    if (window.rSynk) {
                        window.rSynk.config = {...window.rSynk.config, ...settings};
                        if (settings.enabled) {
                            window.rSynk.enable();
                        } else {
                            window.rSynk.disable();
                        }
                    }
                } catch (error) {
                    this.log('error', 'Failed to save settings: ' + error.message);
                }
            }
            
            bindEvents() {
                // Toggle switches
                [this.elements.enableToggle, this.elements.fallbackToggle, 
                 this.elements.cacheToggle, this.elements.debugToggle].forEach(toggle => {
                    toggle.addEventListener('click', (e) => {
                        this.toggleSetting(e.target);
                        this.saveSettings();
                        
                        // Special handling for debug mode
                        if (toggle === this.elements.debugToggle) {
                            this.toggleDebugSection(toggle.classList.contains('active'));
                        }
                    });
                });
                
                // Input changes
                [this.elements.timeoutInput, this.elements.rateLimitInput, 
                 this.elements.serverUrlInput].forEach(input => {
                    input.addEventListener('change', () => {
                        this.saveSettings();
                    });
                });
                
                // Buttons
                this.elements.testConnectionBtn.addEventListener('click', () => {
                    this.testConnection();
                });
                
                this.elements.clearCacheBtn.addEventListener('click', () => {
                    this.clearCache();
                });
                
                this.elements.resetSettingsBtn.addEventListener('click', () => {
                    this.resetSettings();
                });
                
                this.elements.exportLogsBtn.addEventListener('click', () => {
                    this.exportLogs();
                });
                
                this.elements.clearLogsBtn.addEventListener('click', () => {
                    this.clearLogs();
                });
            }
            
            setToggle(toggle, active) {
                if (active) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            }
            
            toggleSetting(toggle) {
                toggle.classList.toggle('active');
            }
            
            toggleDebugSection(show) {
                this.elements.debugSection.style.display = show ? 'block' : 'none';
            }
            
            async testConnection() {
                this.setStatus('pending', 'Testing connection...', 'Connecting to rSynk server');
                this.elements.testConnectionBtn.disabled = true;
                this.elements.testConnectionBtn.textContent = '‚è≥ Testing...';
                
                try {
                    const startTime = Date.now();
                    const serverUrl = this.elements.serverUrlInput.value.trim();
                    
                    const response = await fetch(`${serverUrl}/api/health`, {
                        method: 'GET',
                        timeout: 5000
                    });
                    
                    const responseTime = Date.now() - startTime;
                    
                    if (response.ok) {
                        const health = await response.json();
                        this.setStatus('online', 'Server Online', 
                            `Connected successfully (${responseTime}ms)`);
                        this.log('info', `Connection test successful: ${responseTime}ms`);
                        
                        // Update stats if available
                        this.updateStats(health, responseTime);
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                } catch (error) {
                    this.setStatus('offline', 'Connection Failed', error.message);
                    this.log('error', `Connection test failed: ${error.message}`);
                    this.elements.serverWarning.style.display = 'block';
                }
                
                this.elements.testConnectionBtn.disabled = false;
                this.elements.testConnectionBtn.textContent = 'üîÑ Test Connection';
            }
            
            setStatus(status, text, details) {
                // Update status indicator
                this.elements.statusIndicator.className = `status-indicator status-${status}`;
                this.elements.statusText.textContent = text;
                this.elements.statusDetails.textContent = details;
                
                // Show/hide stats
                if (status === 'online') {
                    this.elements.statsGrid.style.display = 'grid';
                    this.elements.serverWarning.style.display = 'none';
                } else if (status === 'offline') {
                    this.elements.serverWarning.style.display = 'block';
                }
            }
            
            updateStats(health, responseTime) {
                // Update server stats
                document.getElementById('stat-server-response').textContent = responseTime + 'ms';
                
                // Update client stats if rSynk is available
                if (window.rSynk) {
                    const stats = window.rSynk.getStats();
                    
                    document.getElementById('stat-total-requests').textContent = 
                        stats.stats ? stats.stats.total : '0';
                    
                    document.getElementById('stat-success-rate').textContent = 
                        stats.stats ? Math.round((stats.stats.successful / stats.stats.total) * 100) + '%' : '0%';
                    
                    document.getElementById('stat-cache-size').textContent = 
                        stats.cacheSize || '0';
                }
                
                // Update with health data
                if (health) {
                    if (health.requests_processed) {
                        document.getElementById('stat-total-requests').textContent = health.requests_processed;
                    }
                }
            }
            
            startStatusCheck() {
                // Check status every 30 seconds
                setInterval(() => {
                    if (this.elements.enableToggle.classList.contains('active')) {
                        this.testConnection();
                    }
                }, 30000);
                
                // Initial test
                this.testConnection();
            }
            
            clearCache() {
                try {
                    if (window.rSynk) {
                        window.rSynk.cache.clear();
                        this.log('info', 'Cache cleared successfully');
                        
                        // Update cache stat
                        document.getElementById('stat-cache-size').textContent = '0';
                    } else {
                        // Clear localStorage cache
                        Object.keys(localStorage).forEach(key => {
                            if (key.startsWith('rsynk:')) {
                                localStorage.removeItem(key);
                            }
                        });
                        this.log('info', 'Local cache cleared');
                    }
                } catch (error) {
                    this.log('error', 'Failed to clear cache: ' + error.message);
                }
            }
            
            resetSettings() {
                if (confirm('Reset all settings to defaults? This cannot be undone.')) {
                    // Clear stored settings
                    localStorage.removeItem('rsynk_settings');
                    localStorage.removeItem('rsynk_enabled');
                    
                    // Reload default settings
                    this.loadSettings();
                    this.saveSettings();
                    
                    this.log('info', 'Settings reset to defaults');
                }
            }
            
            exportLogs() {
                const logData = {
                    timestamp: new Date().toISOString(),
                    logs: this.logs,
                    settings: this.getStoredSettings(),
                    browser: navigator.userAgent,
                    rsynk_available: !!window.rSynk
                };
                
                const blob = new Blob([JSON.stringify(logData, null, 2)], 
                    { type: 'application/json' });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rsynk-logs-${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.log('info', 'Logs exported successfully');
            }
            
            clearLogs() {
                this.logs = [];
                this.elements.debugConsole.innerHTML = '';
                this.log('info', 'Debug logs cleared');
            }
            
            log(level, message) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = {
                    timestamp: Date.now(),
                    level: level,
                    message: message
                };
                
                this.logs.push(logEntry);
                
                // Add to debug console if visible
                if (this.elements.debugConsole) {
                    const div = document.createElement('div');
                    div.className = 'log-entry';
                    div.innerHTML = `
                        <span class="log-timestamp">[${timestamp}]</span>
                        <span class="log-level-${level}">[${level.toUpperCase()}]</span>
                        ${message}
                    `;
                    this.elements.debugConsole.appendChild(div);
                    this.elements.debugConsole.scrollTop = this.elements.debugConsole.scrollHeight;
                }
                
                // Keep only last 100 logs to prevent memory issues
                if (this.logs.length > 100) {
                    this.logs = this.logs.slice(-100);
                }
            }
        }
        
        // Initialize settings panel when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.rSynkSettings = new rSynkSettingsPanel();
        });
    </script>
</body>
</html>
