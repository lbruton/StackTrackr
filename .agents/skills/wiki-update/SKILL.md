---
name: wiki-update
description: Update StakTrakrWiki pages affected by the current patch. Called from /release patch Phase 3 after the version bump commit. Dispatches a background subagent — does not block PR creation. Triggers on any release patch that touches JS, CSS, skill, or devops files.
allowed-tools: Bash, Read, Task
---

# Wiki Update

Called automatically from `/release patch` Phase 3 after the version bump commit.
Identifies which wiki pages are affected by this patch's diff and rewrites only
those pages. Runs as a background Task agent — Phase 4 (PR creation) does not wait.

## File → Page Mapping

| Source file pattern | Wiki page(s) |
|---------------------|-------------|
| `index.html`, `sw.js`, `js/constants.js` | `frontend-overview.md` |
| `js/constants.js`, `js/utils.js` | `data-model.md` |
| `js/utils.js` | `storage-patterns.md`, `dom-patterns.md` |
| `js/cloud-sync.js`, `js/cloud-storage.js` | `sync-cloud.md` |
| `js/retail-view-modal.js`, `js/retail.js`, `js/retail-*.js` | `retail-modal.md` |
| `js/api.js`, `js/api-health.js` | `api-consumption.md` |
| `.claude/skills/release/`, `.claude/skills/ship/`, `devops/` | `release-workflow.md` |
| `sw.js`, `devops/hooks/stamp-sw-cache.sh` | `service-worker.md` |

## Steps

### Step 1: Identify affected pages

```bash
CHANGED=$(git diff HEAD~1 --name-only)
echo "Changed files:"
echo "$CHANGED"
```

Walk the mapping table above. Collect the set of wiki pages to update.

If no source files match any pattern (e.g. pure data or image change), exit with:
`Wiki update: no relevant files changed — skipping.`

### Step 2: For each affected page, rewrite it

Re-read the relevant source files from the current working tree.
Use the same structure as the initial sweep:

```markdown
# [Title]

> **Last updated:** vNEW_VERSION — YYYY-MM-DD
> **Source files:** `js/filename.js`, ...

## Overview
## Key Rules (read before touching this area)
## Architecture
## Common Mistakes
## Related Pages
```

**Update the `> **Last updated:**` line** with the new version and today's date.

### Step 3: Push changes via PR to StakTrakrWiki

Branch protection requires all changes go through a PR. Never push directly to `main`.

```bash
# 1. Pull latest and create a branch
cd /Volumes/DATA/GitHub/StakTrakrWiki
git pull origin main
BRANCH="wiki-update/vVERSION-$(date +%Y%m%d)"
git checkout -b "$BRANCH"

# 2. Copy updated pages into the repo
cp /tmp/PAGENAME.md ./PAGENAME.md
# ... repeat for each affected page

# 3. Commit and push
git add -A
git commit -m "sync: vVERSION — update PAGENAME [, PAGENAME2, ...]

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>"
git push -u origin "$BRANCH"

# 4. Create PR for review
gh pr create --repo lbruton/StakTrakrWiki \
  --title "sync: vVERSION wiki update" \
  --body "$(cat <<'EOF'
## Summary
- Updated wiki pages to reflect vVERSION changes

## Pages updated
- [list each page with brief description]

Generated by `/wiki-update` skill.
EOF
)"

# 5. Return to main
git checkout main
```

### Step 4: Report

Output when done:
```
Wiki PR created: [PR URL] — [list of pages updated]
```

## Infrastructure Page Mapping (informational)

Infrastructure pages are owned by StakTrakrApi Claude. StakTrakr Claude should **flag** when they may be stale — do not rewrite them directly.

| Changed file (StakTrakr) | May affect wiki page |
|----------------------------------|---------------------------|
| `js/api.js`, `js/api-health.js` | `api-consumption.md` |
| `docs/devops/` | `health.md` (deprecated local runbook — wiki is authoritative) |
| `.claude/skills/api-infrastructure/` | `architecture-overview.md` |
| `CLAUDE.md` (API section) | `health.md`, `fly-container.md` |

When any of these patterns are detected in `CHANGED`, add a note to the PR:
```
⚠️ API-related change — verify StakTrakrWiki infrastructure pages are current.
Check: health.md, fly-container.md, spot-pipeline.md as applicable.
StakTrakrApi Claude owns these pages — flag, don't rewrite.
```

---

## Integration point in release skill

This skill is invoked after the version bump commit in Phase 3 of `/release patch`:

> After committing the version bump, invoke the `wiki-update` skill via the Skill
> tool as a background Task agent. Do not wait for it before proceeding to Phase 4.
